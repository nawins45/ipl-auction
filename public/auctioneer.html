<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auctioneer - IPL Auction</title>
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Poppins', sans-serif; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .neon-border {
            border: 1px solid rgba(245, 158, 11, 0.3);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.1);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #F59E0B 0%, #F97316 100%);
            position: relative;
            overflow: hidden;
        }
        
        .btn-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.7s;
        }
        
        .btn-gradient:hover::before {
            left: 100%;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }
        
        .btn-purple {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }
        
        .btn-blue {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .stat-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s;
        }
        
        .stat-card:hover::before {
            left: 100%;
        }
        
        .user-item {
            transition: all 0.3s ease;
        }
        
        .user-item:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .bid-log-item {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .bid-log-item.new {
            border-left-color: #F59E0B;
            background: rgba(245, 158, 11, 0.1);
            animation: highlight 1s ease-out;
        }
        
        @keyframes highlight {
            from { background: rgba(245, 158, 11, 0.3); }
            to { background: rgba(245, 158, 11, 0.1); }
        }
        
        .team-badge {
            background: linear-gradient(45deg, #1e293b, #334155);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .scrollbar-custom::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: rgba(245, 158, 11, 0.3);
            border-radius: 3px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-thumb:hover {
            background: rgba(245, 158, 11, 0.5);
        }
        
        .input-glow {
            transition: all 0.3s ease;
        }
        
        .input-glow:focus {
            border-color: rgba(245, 158, 11, 0.5);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }
        
        .glow-text {
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }
        
        .float-animation {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        /* Add to the style section */
/* Fix for dropdown styling */
select {
    background-color: rgba(17, 24, 39, 0.8) !important;
    color: white !important;
}

select option {
    background-color: rgba(17, 24, 39, 0.95) !important;
    color: white !important;
    padding: 8px 12px;
}

select option:hover {
    background-color: rgba(55, 65, 81, 0.95) !important;
}
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-blue-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
                    üé§ Auctioneer Control Panel
                </h1>
                <div class="flex items-center space-x-2">
                    <div id="connectionStatus" class="flex items-center space-x-2 px-3 py-1 bg-gray-800/50 rounded-full">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="text-sm text-gray-300">Connected</span>
                    </div>
                    <span class="text-sm text-gray-400">Master Control</span>
                </div>
            </div>
            
            <!-- Room Code Display -->
            <div id="roomCodeContainer" class="bg-gradient-to-r from-yellow-900/30 to-orange-900/30 rounded-xl p-4 md:p-6 text-center hidden">
                <div class="text-sm text-gray-300 mb-1">ROOM CODE</div>
                <div id="roomCode" class="text-3xl md:text-4xl font-bold tracking-wider glow-text">----</div>
                <div class="text-xs text-gray-400 mt-1">Share with participants</div>
            </div>

            
            <!-- No Room Display -->
            <div id="noRoomContainer" class="bg-gradient-to-r from-blue-900/30 to-cyan-900/30 rounded-xl p-4 md:p-6 text-center">
                <div class="text-sm text-gray-300 mb-1">STATUS</div>
                <div class="text-2xl md:text-3xl font-bold text-blue-400">No Room Active</div>
                <div class="text-xs text-gray-400 mt-1">Create a room to start</div>
            </div>


        </header>
        <!-- Add this right after the header section -->
<div class="flex flex-wrap justify-center gap-4 mb-4">
    <button onclick="forceCheckRetention()" 
            class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-xl font-semibold text-sm hover:scale-[1.02] transition-all duration-300">
        üîç Check Retention Status
    </button>
</div>

        <!-- Quick Stats -->
        <div class="glass-panel rounded-2xl p-6 mb-8 slide-in">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stat-card text-center p-4 rounded-lg bg-blue-900/20">
                    <div class="text-2xl font-bold text-blue-400" id="totalPlayers">0</div>
                    <div class="text-sm text-gray-400">Total Players</div>
                </div>
                <div class="stat-card text-center p-4 rounded-lg bg-green-900/20">
                    <div class="text-2xl font-bold text-green-400" id="connectedCount">0</div>
                    <div class="text-sm text-gray-400">Connected Users</div>
                </div>
                <div class="stat-card text-center p-4 rounded-lg bg-purple-900/20">
                    <div class="text-2xl font-bold text-purple-400" id="teamsAssigned">0</div>
                    <div class="text-sm text-gray-400">Teams Assigned</div>
                </div>
                <div class="stat-card text-center p-4 rounded-lg bg-yellow-900/20">
                    <div class="text-2xl font-bold text-yellow-400" id="retentionDone">0</div>
                    <div class="text-sm text-gray-400">Retention Done</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Room Creation -->
                <div class="glass-panel rounded-2xl p-6 slide-in">
                    <h2 class="text-2xl font-bold mb-4 text-yellow-400 flex items-center gap-2">
                        <span class="text-2xl">üèÜ</span>
                        Create Auction Room
                    </h2>
                    
                    <div class="space-y-4">
                        <button id="createRoomBtn" 
                                class="w-full py-4 btn-gradient rounded-xl font-bold text-lg transition-all duration-300 hover:scale-[1.02] active:scale-95 group">
                            <span class="flex items-center justify-center space-x-3">
                                <span class="group-hover:rotate-12 transition-transform duration-300">üöÄ</span>
                                <span>CREATE NEW AUCTION ROOM</span>
                                <span class="group-hover:-rotate-12 transition-transform duration-300">‚ö°</span>
                            </span>
                        </button>
                        
                        <div id="roomInfo" class="hidden">
                            <div class="neon-border rounded-2xl p-6 text-center mt-4">
                                <h3 class="text-xl font-bold mb-2 text-green-400">Room Created Successfully!</h3>
                                <div class="text-5xl font-black tracking-wider mb-4 bg-gradient-to-r from-yellow-300 to-orange-400 bg-clip-text text-transparent" id="roomCodeDisplay"></div>
                                <p class="text-gray-300 mb-4">Share this code with participants</p>
                                <div class="text-sm text-gray-400 bg-gray-900/50 p-3 rounded-lg">
                                    <p class="font-mono">Users should go to: <span class="text-yellow-300">/user.html</span></p>
                                    <p class="mt-1">Enter the code above to join your auction</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rules Configuration -->
                <div class="glass-panel rounded-2xl p-6 slide-in" style="animation-delay: 0.1s;">
                    <h2 class="text-2xl font-bold mb-4 text-yellow-400 flex items-center gap-2">
                        <span class="text-2xl">‚öôÔ∏è</span>
                        Set Auction Rules
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-300">Total Purse (in Cr)</label>
                            <input type="number" id="totalPurse" min="50" max="250" value="100" 
                                   class="w-full glass-panel border border-gray-700 rounded-xl px-4 py-3 text-white focus:outline-none input-glow">
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-300">Squad Size (Auction Limit)</label>
                            <input type="number" id="squadSize" min="11" max="25" value="25" 
                                   class="w-full glass-panel border border-gray-700 rounded-xl px-4 py-3 text-white focus:outline-none input-glow">
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-300">Max Indian Players (Retention)</label>
                            <input type="number" id="maxIndian" min="1" max="10" value="4" 
                                   class="w-full glass-panel border border-gray-700 rounded-xl px-4 py-3 text-white focus:outline-none input-glow">
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-300">Max Overseas Players (Retention)</label>
                            <input type="number" id="maxOverseas" min="1" max="8" value="3" 
                                   class="w-full glass-panel border border-gray-700 rounded-xl px-4 py-3 text-white focus:outline-none input-glow">
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-300">Impact Players</label>
                            <input type="number" id="impactPlayers" min="0" max="5" value="1" 
                                   class="w-full glass-panel border border-gray-700 rounded-xl px-4 py-3 text-white focus:outline-none input-glow">
                        </div>
                    </div>
                    
                    <button id="lockRulesBtn" 
                            class="w-full mt-6 py-3 btn-gradient rounded-xl font-bold text-lg transition-all duration-300 hover:scale-[1.02] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <span class="flex items-center justify-center space-x-2">
                            <span>üîí</span>
                            <span>LOCK RULES & START</span>
                        </span>
                    </button>
                </div>

                <!-- Team Assignment -->
                <div class="glass-panel rounded-2xl p-6 slide-in" style="animation-delay: 0.2s;">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-yellow-400 flex items-center gap-2">
                            <span class="text-2xl">üë•</span>
                            Team Assignment
                        </h2>
                        <span class="bg-blue-500/20 text-blue-300 px-3 py-1 rounded-full text-sm" id="userCount">0 users</span>
                    </div>
                    
                    <div class="space-y-4">
                        <button id="assignTeamsBtn" 
                                class="w-full py-3 btn-purple rounded-xl font-bold text-lg transition-all duration-300 hover:scale-[1.02] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <span class="flex items-center justify-center space-x-2">
                                <span>üéØ</span>
                                <span>ASSIGN RANDOM TEAMS</span>
                            </span>
                        </button>
                        
                        <!-- Connected Users -->
                        <div class="mt-4">
                            <h3 class="text-lg font-semibold text-gray-300 mb-3">Connected Users</h3>
                            <div id="userList" class="space-y-2 max-h-48 overflow-y-auto scrollbar-custom pr-2">
                                <p class="text-gray-500 text-center py-4">Waiting for users to join...</p>
                            </div>
                        </div>
                        
                        <!-- Team Mapping Display -->
                        <div id="teamMapping" class="hidden">
                            <h3 class="text-lg font-semibold text-gray-300 mb-3">Team Assignments</h3>
                            <div id="teamList" class="space-y-2"></div>
                        </div>
                        
                        <!-- Force Shuffle -->
                        <div id="forceShuffleSection" class="hidden mt-4 p-4 glass-panel rounded-xl">
                            <h3 class="text-md font-semibold text-gray-300 mb-3">Force Team Shuffle</h3>
                            <div class="flex space-x-2">
                                <!-- In the force shuffle section (around line 330) -->
<select id="forceShuffleUser" class="flex-1 glass-panel border border-gray-700 rounded-xl px-3 py-2 text-white focus:outline-none bg-gray-900/70">
    <option value="" class="text-gray-400">Select user to shuffle</option>
</select>
                                <button id="forceShuffleBtn" class="px-4 py-2 btn-purple rounded-xl font-semibold text-sm transition-all duration-300 hover:scale-[1.02]">
                                    üîÄ Shuffle
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-6">
                <!-- Phase Controls -->
                <div class="glass-panel rounded-2xl p-6 slide-in" style="animation-delay: 0.3s;">
                    <h2 class="text-2xl font-bold mb-4 text-yellow-400 flex items-center gap-2">
                        <span class="text-2xl">‚è≥</span>
                        Phase Controls
                    </h2>
                    
                    <div class="space-y-4">
                        <button id="startRetentionBtn" 
                                class="w-full py-3 btn-danger rounded-xl font-bold text-lg transition-all duration-300 hover:scale-[1.02] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <span class="flex items-center justify-center space-x-2">
                                <span>‚è≥</span>
                                <span>START RETENTION (90s)</span>
                            </span>
                        </button>
                        
                        <button id="startAuctionPoolBtn" 
                                class="w-full py-3 btn-success rounded-xl font-bold text-lg transition-all duration-300 hover:scale-[1.02] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <span class="flex items-center justify-center space-x-2">
                                <span>üöÄ</span>
                                <span>START AUCTION POOL</span>
                            </span>
                        </button>
                        
                        <!-- Retention Progress -->
                        <div id="retentionProgress" class="hidden mt-4">
                            <h3 class="text-lg font-semibold text-gray-300 mb-3">Retention Submissions</h3>
                            <div id="submissionList" class="space-y-2 max-h-48 overflow-y-auto scrollbar-custom pr-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Auction Pool Controls -->
                <div class="glass-panel rounded-2xl p-6 slide-in" style="animation-delay: 0.4s;">
                    <h2 class="text-2xl font-bold mb-4 text-yellow-400 flex items-center gap-2">
                        <span class="text-2xl">üí∞</span>
                        Auction Pool Controls
                    </h2>
                    
                    <div id="auctionPoolControls" class="hidden space-y-4">
                        <button id="gotoAuctionBtn" 
                                class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl font-bold text-lg transition-all duration-300 hover:scale-[1.02] active:scale-95">
                            üé§ Go to Auction Control
                        </button>
                        
                        <div class="glass-panel rounded-xl p-4">
                            <h3 class="font-semibold text-gray-300 mb-3">Auction Status</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <span class="text-gray-400 text-sm">Category:</span>
                                    <span id="auctioneerCategory" class="ml-2 font-bold text-yellow-400">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-400 text-sm">Current Bid:</span>
                                    <span id="auctioneerCurrentBid" class="ml-2 font-bold text-green-400">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-400 text-sm">Players Left:</span>
                                    <span id="auctioneerPlayersLeft" class="ml-2 font-bold text-blue-400">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-400 text-sm">Unsold:</span>
                                    <span id="auctioneerUnsold" class="ml-2 font-bold text-red-400">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="auctionNotStarted" class="text-center py-6">
                        <div class="text-4xl mb-3">‚è≥</div>
                        <p class="text-gray-400">Auction pool will start after retention phase</p>
                    </div>
                </div>

                <!-- Live Bid Log -->
                <div class="glass-panel rounded-2xl p-6 slide-in" style="animation-delay: 0.5s;">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-yellow-400 flex items-center gap-2">
                            <span class="text-2xl">üìù</span>
                            Live Bid Log
                        </h2>
                        <button id="clearBidLogBtn" class="text-xs text-gray-400 hover:text-gray-300 px-3 py-1 glass-panel rounded-lg">
                            Clear
                        </button>
                    </div>
                    
                    <div id="bidLog" class="space-y-2 max-h-64 overflow-y-auto scrollbar-custom pr-2">
                        <div class="text-center text-gray-500 py-4">No bids yet</div>
                    </div>
                </div>

                <!-- Connected Users Mini -->
                <div class="glass-panel rounded-2xl p-6 slide-in" style="animation-delay: 0.6s;">
                    <h2 class="text-2xl font-bold mb-4 text-yellow-400 flex items-center gap-2">
                        <span class="text-2xl">üëë</span>
                        Auctioneer Info
                    </h2>
                    
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400">Username:</span>
                            <span class="font-semibold text-yellow-300" id="auctioneerUsername">---</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400">Role:</span>
                            <span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded-full text-xs font-bold" id="auctioneerRole">---</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400">Status:</span>
                            <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded-full text-xs">Active</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400">Room:</span>
                            <span id="currentRoomStatus" class="px-2 py-1 bg-blue-500/20 text-blue-400 rounded-full text-xs">No Room</span>
                        </div>
                    </div>
                    
                    <button onclick="logout()" 
                            class="w-full mt-4 py-2 glass-panel hover:bg-red-900/30 hover:text-red-400 rounded-xl font-semibold transition-all duration-300">
                        üö™ Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Panel (Remove in production) -->
    <div id="debugPanel" class="fixed bottom-4 right-4 glass-panel rounded-xl p-4 text-xs max-w-xs z-50">
        <div class="font-bold mb-2 text-yellow-400">Debug Info</div>
        <div class="space-y-1">
            <div>Session ID: <span id="debugSessionId" class="text-gray-300">---</span></div>
            <div>Username: <span id="debugUsername" class="text-gray-300">---</span></div>
            <div>Role: <span id="debugRole" class="text-gray-300">---</span></div>
            <div>Room: <span id="debugRoom" class="text-gray-300">---</span></div>
        </div>
        <button onclick="toggleDebug()" class="mt-2 text-xs text-gray-400 hover:text-gray-300">Hide</button>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black/70"></div>
        <div class="glass-panel rounded-2xl p-6 max-w-md mx-4 z-10">
            <div class="text-center">
                <div class="text-4xl mb-4" id="modalIcon">‚ö†Ô∏è</div>
                <h3 class="text-2xl font-bold mb-2" id="modalTitle">Alert</h3>
                <p class="text-gray-300 mb-6" id="modalMessage">This is a modal message</p>
                <button onclick="closeModal()" 
                        class="px-6 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg font-semibold">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== SOCKET CONNECTION ==========
         const socket = io(window.BACKEND_URL,{ transports: ["websocket", "polling"],}
        );
        let currentRoomCode = null;
        let currentSessionId = null;
        let currentUsername = null;
        let currentRole = null;
        
        // ========== DOM ELEMENTS ==========
        const connectionStatus = document.getElementById('connectionStatus');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const roomInfo = document.getElementById('roomInfo');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const lockRulesBtn = document.getElementById('lockRulesBtn');
        const assignTeamsBtn = document.getElementById('assignTeamsBtn');
        const startRetentionBtn = document.getElementById('startRetentionBtn');
        const startAuctionPoolBtn = document.getElementById('startAuctionPoolBtn');
        const gotoAuctionBtn = document.getElementById('gotoAuctionBtn');
        const auctionPoolControls = document.getElementById('auctionPoolControls');
        const userList = document.getElementById('userList');
        const userCount = document.getElementById('userCount');
        const teamMapping = document.getElementById('teamMapping');
        const teamList = document.getElementById('teamList');
        const retentionProgress = document.getElementById('retentionProgress');
        const submissionList = document.getElementById('submissionList');
        const bidLog = document.getElementById('bidLog');
        const clearBidLogBtn = document.getElementById('clearBidLogBtn');
        const auctioneerCategory = document.getElementById('auctioneerCategory');
        const auctioneerCurrentBid = document.getElementById('auctioneerCurrentBid');
        const auctioneerPlayersLeft = document.getElementById('auctioneerPlayersLeft');
        const auctioneerUnsold = document.getElementById('auctioneerUnsold');
        const forceShuffleSection = document.getElementById('forceShuffleSection');
        const forceShuffleUser = document.getElementById('forceShuffleUser');
        const forceShuffleBtn = document.getElementById('forceShuffleBtn');
        const roomCodeContainer = document.getElementById('roomCodeContainer');
        const noRoomContainer = document.getElementById('noRoomContainer');
        
        // Info elements
        const auctioneerUsernameElement = document.getElementById('auctioneerUsername');
        const auctioneerRoleElement = document.getElementById('auctioneerRole');
        const currentRoomStatus = document.getElementById('currentRoomStatus');
        
        // Stats elements
        const totalPlayers = document.getElementById('totalPlayers');
        const connectedCount = document.getElementById('connectedCount');
        const teamsAssigned = document.getElementById('teamsAssigned');
        const retentionDone = document.getElementById('retentionDone');

        // Debug elements
        const debugPanel = document.getElementById('debugPanel');
        const debugSessionId = document.getElementById('debugSessionId');
        const debugUsername = document.getElementById('debugUsername');
        const debugRole = document.getElementById('debugRole');
        const debugRoom = document.getElementById('debugRoom');

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üé§ Auctioneer page loaded');
            
            // First check URL parameters for session data
            checkUrlParameters();
            
            // Then load session from localStorage
            loadSessionFromStorage();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize socket connection
            initializeSocket();
            
            // Update debug panel
            updateDebugPanel();
        });
        
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionParam = urlParams.get('session');
            
            if (sessionParam) {
                try {
                    const sessionData = JSON.parse(decodeURIComponent(sessionParam));
                    console.log('üìã Found session in URL:', sessionData);
                    
                    // Store session in localStorage
                    localStorage.setItem('auctioneerSession', JSON.stringify(sessionData));
                    localStorage.setItem('currentSession', JSON.stringify(sessionData));
                    localStorage.setItem('session', JSON.stringify(sessionData));
                    
                    // Update session variables
                    currentSessionId = sessionData.sessionId;
                    currentUsername = sessionData.username;
                    currentRole = sessionData.role;
                    
                    // Remove session from URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                } catch (error) {
                    console.error('‚ùå Error parsing URL session:', error);
                }
            }
        }
        
        function loadSessionFromStorage() {
            console.log('üîç Checking localStorage for session data...');
            
            // Check all possible storage locations
            const storageLocations = [
                'auctioneerSession',
                'currentSession', 
                'session',
                'userSession'
            ];
            
            let sessionData = null;
            
            for (const location of storageLocations) {
                const storedData = localStorage.getItem(location);
                if (storedData) {
                    try {
                        const parsed = JSON.parse(storedData);
                        console.log(`üìã Found session in ${location}:`, parsed);
                        
                        // Validate the session has required fields
                        if (parsed.username && parsed.role && parsed.sessionId) {
                            sessionData = parsed;
                            break;
                        } else {
                            console.warn(`‚ö†Ô∏è Session in ${location} missing required fields`);
                            localStorage.removeItem(location);
                        }
                    } catch (error) {
                        console.error(`‚ùå Error parsing ${location}:`, error);
                    }
                }
            }
            
            if (!sessionData) {
                console.log('‚ùå No valid session data found in localStorage');
                // Don't redirect immediately, let the socket connection attempt first
                return;
            }
            
            // Set session variables
            currentSessionId = sessionData.sessionId;
            currentUsername = sessionData.username;
            currentRole = sessionData.role;
            currentRoomCode = sessionData.roomCode || null;
            
            console.log(`‚úÖ Session loaded: ${currentUsername} (${currentRole})`);
            
            // Update UI with session info
            updateUserInfo();
            
            // Update debug panel
            updateDebugPanel();
        }
        
        function updateUserInfo() {
            if (currentUsername) {
                auctioneerUsernameElement.textContent = currentUsername;
                auctioneerUsernameElement.classList.add('text-yellow-300');
            } else {
                auctioneerUsernameElement.textContent = 'Not logged in';
                auctioneerUsernameElement.classList.add('text-red-400');
            }
            
            if (currentRole) {
                auctioneerRoleElement.textContent = currentRole.toUpperCase();
                auctioneerRoleElement.classList.remove('bg-red-500/20', 'text-red-400');
                auctioneerRoleElement.classList.add('bg-yellow-500/20', 'text-yellow-400');
            } else {
                auctioneerRoleElement.textContent = 'UNKNOWN';
                auctioneerRoleElement.classList.remove('bg-yellow-500/20', 'text-yellow-400');
                auctioneerRoleElement.classList.add('bg-red-500/20', 'text-red-400');
            }
        }
        
        function initializeSocket() {
            socket.on('connect', () => {
                updateConnectionStatus('Connected', 'green');
                console.log('‚úÖ Connected to server');
                
                // Send session validation to server
                if (currentSessionId && currentUsername && currentRole) {
                    console.log('üîê Sending session validation to server');
                    socket.emit('validateSession', {
                        sessionId: currentSessionId,
                        username: currentUsername,
                        role: currentRole
                    });
                } else {
                    console.log('‚ö†Ô∏è No session data, requesting new session');
                    // Try to restore session from server
                    socket.emit('restoreSession', {
                        sessionId: currentSessionId
                    });
                }
                
                // Rejoin room if exists
                if (currentRoomCode) {
                    socket.emit('joinRoom', {
                        roomCode: currentRoomCode,
                        username: currentUsername,
                        role: currentRole,
                        sessionId: currentSessionId
                    });
                    console.log(`üîÑ Rejoining room: ${currentRoomCode}`);
                }
            });
            
            socket.on('connect_error', (error) => {
                updateConnectionStatus('Connection Error', 'red');
                console.error('‚ùå Connection error:', error);
                showAlert('Connection Error', 'Cannot connect to server. Please refresh.', '‚ùå');
            });
            
            socket.on('disconnect', () => {
                updateConnectionStatus('Disconnected', 'red');
                console.log('‚ùå Disconnected from server');
            });
            
            socket.on('sessionValidated', (data) => {
                console.log('‚úÖ Session validation response:', data);
                if (data.valid) {
                    updateConnectionStatus('Authenticated', 'green');
                    console.log('‚úÖ Session is valid');
                    
                    // Update session data if provided
                    if (data.session) {
                        currentSessionId = data.session.sessionId;
                        currentUsername = data.session.username;
                        currentRole = data.session.role;
                        updateUserInfo();
                        updateDebugPanel();
                    }
                } else {
                    console.log('‚ùå Session is invalid, redirecting to login');
                    showAlert('Session Expired', 'Your session has expired. Please login again.', 'üîí');
                    setTimeout(() => {
                        redirectToLogin();
                    }, 2000);
                }
            });
            
            socket.on('sessionRestored', (data) => {
                console.log('üîÑ Session restored from server:', data);
                if (data.valid && data.session) {
                    currentSessionId = data.session.sessionId;
                    currentUsername = data.session.username;
                    currentRole = data.session.role;
                    
                    // Update localStorage
                    const sessionData = {
                        sessionId: currentSessionId,
                        username: currentUsername,
                        role: currentRole
                    };
                    localStorage.setItem('auctioneerSession', JSON.stringify(sessionData));
                    localStorage.setItem('currentSession', JSON.stringify(sessionData));
                    
                    updateUserInfo();
                    updateDebugPanel();
                    updateConnectionStatus('Authenticated', 'green');
                } else {
                    console.log('‚ùå Could not restore session');
                    showAlert('Session Error', 'Could not restore your session. Please login again.', 'üîí');
                    setTimeout(() => {
                        redirectToLogin();
                    }, 2000);
                }
            });
            
            setupSocketEvents();
        }
        
        function redirectToLogin() {
            console.log('üîê Redirecting to login...');
            // Clear all session data
            localStorage.removeItem('auctioneerSession');
            localStorage.removeItem('currentSession');
            localStorage.removeItem('session');
            localStorage.removeItem('auctioneerRoomCode');
            localStorage.removeItem('userSession');
            
            // Redirect to login page
            window.location.href = 'login.html';
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout? All connected users will be disconnected.')) {
                if (currentRoomCode && currentSessionId) {
                    socket.emit('hardReset', { 
                        roomCode: currentRoomCode,
                        sessionId: currentSessionId 
                    });
                }
                redirectToLogin();
            }
        }
        
        function restoreRoomState(roomCode) {
            console.log(`üîó Restoring room: ${roomCode}`);
            
            // Update UI
            document.getElementById('roomCode').textContent = roomCode;
            roomCodeDisplay.textContent = roomCode;
            roomInfo.classList.remove('hidden');
            createRoomBtn.disabled = true;
            createRoomBtn.innerHTML = '<span class="flex items-center justify-center space-x-2"><span>‚úÖ</span><span>Room Active</span></span>';
            createRoomBtn.classList.add('bg-gradient-to-r', 'from-green-500/20', 'to-green-600/20', 'border', 'border-green-500/30');
            lockRulesBtn.disabled = false;
            
            // Show room code container
            roomCodeContainer.classList.remove('hidden');
            noRoomContainer.classList.add('hidden');
            
            currentRoomStatus.textContent = roomCode;
            currentRoomStatus.className = 'px-2 py-1 bg-green-500/20 text-green-400 rounded-full text-xs';
            
            showAlert('Room Restored', `Reconnected to room: ${roomCode}`, 'üîó');
            
            // Store in localStorage for persistence
            updateSessionStorageWithRoom(roomCode);
        }
        
        function updateSessionStorageWithRoom(roomCode) {
            currentRoomCode = roomCode;
            
            // Update all session storage locations
            const storageLocations = ['auctioneerSession', 'currentSession', 'session'];
            
            storageLocations.forEach(location => {
                const stored = localStorage.getItem(location);
                if (stored) {
                    try {
                        const sessionData = JSON.parse(stored);
                        sessionData.roomCode = roomCode;
                        localStorage.setItem(location, JSON.stringify(sessionData));
                    } catch (error) {
                        console.error(`Error updating ${location}:`, error);
                    }
                }
            });
            
            localStorage.setItem('auctioneerRoomCode', roomCode);
            updateDebugPanel();
        }
        
        function setupEventListeners() {
            // Room creation
            createRoomBtn.addEventListener('click', createRoom);
            
            // Rules and controls
            lockRulesBtn.addEventListener('click', lockRules);
            assignTeamsBtn.addEventListener('click', assignTeams);
            startRetentionBtn.addEventListener('click', startRetention);
            startAuctionPoolBtn.addEventListener('click', startAuctionPool);
            gotoAuctionBtn.addEventListener('click', gotoAuction);
            clearBidLogBtn.addEventListener('click', clearBidLog);
            forceShuffleBtn.addEventListener('click', forceShuffle);
            
            // Input validation
            setupInputValidation();
        }
        
        function setupInputValidation() {
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('change', function() {
                    const min = parseInt(this.min) || 0;
                    const max = parseInt(this.max) || 100;
                    let value = parseInt(this.value) || min;
                    
                    if (value < min) value = min;
                    if (value > max) value = max;
                    
                    this.value = value;
                });
            });
        }
        
        // ========== ROOM MANAGEMENT ==========
        function createRoom() {
            if (!currentSessionId) {
                showAlert('Session Error', 'Please login again', '‚ùå');
                redirectToLogin();
                return;
            }
            
            createRoomBtn.disabled = true;
            createRoomBtn.innerHTML = `
                <span class="flex items-center justify-center space-x-2">
                    <span class="animate-spin">‚è≥</span>
                    <span>Creating Room...</span>
                </span>
            `;
            
            // Send session ID with createRoom request
            socket.emit('createRoom', { 
                sessionId: currentSessionId,
                username: currentUsername,
                role: currentRole
            });
        }
        
        function lockRules() {
            if (!currentSessionId || !currentRoomCode) {
                showAlert('Session Error', 'Please create a room first', '‚ùå');
                return;
            }
            
            const rules = {
                totalPurse: parseInt(document.getElementById('totalPurse').value) || 100,
                maxIndian: parseInt(document.getElementById('maxIndian').value) || 4,
                maxOverseas: parseInt(document.getElementById('maxOverseas').value) || 3,
                squadSize: parseInt(document.getElementById('squadSize').value) || 25,
                impactPlayers: parseInt(document.getElementById('impactPlayers').value) || 1
            };
            
            socket.emit('setRules', { 
                roomCode: currentRoomCode, 
                rules: rules,
                sessionId: currentSessionId 
            });
            
            lockRulesBtn.innerHTML = `
                <span class="flex items-center justify-center space-x-2">
                    <span>‚úÖ</span>
                    <span>Rules Locked</span>
                </span>
            `;
            lockRulesBtn.disabled = true;
            lockRulesBtn.classList.remove('btn-gradient');
            lockRulesBtn.classList.add('bg-gradient-to-r', 'from-green-500/20', 'to-green-600/20', 'border', 'border-green-500/30');
            
            // Enable team assignment
            assignTeamsBtn.disabled = false;
            
            showAlert('Rules Locked', 'Auction rules have been locked and sent to all users.', '‚úÖ');
        }
        
        function assignTeams() {
            if (!currentSessionId || !currentRoomCode) {
                showAlert('Session Error', 'Please create a room first', '‚ùå');
                return;
            }
            
            socket.emit('assignTeams', { 
                roomCode: currentRoomCode,
                sessionId: currentSessionId 
            });
            
            assignTeamsBtn.innerHTML = `
                <span class="flex items-center justify-center space-x-2">
                    <span>‚úÖ</span>
                    <span>Teams Assigned</span>
                </span>
            `;
            assignTeamsBtn.disabled = true;
            assignTeamsBtn.classList.remove('btn-purple');
            assignTeamsBtn.classList.add('bg-gradient-to-r', 'from-green-500/20', 'to-green-600/20', 'border', 'border-green-500/30');
            
            // Enable retention start
            startRetentionBtn.disabled = false;
            
            showAlert('Teams Assigned', 'Teams have been randomly assigned to all users.', '‚úÖ');
        }
        
        function startRetention() {
            if (!currentSessionId || !currentRoomCode) {
                showAlert('Session Error', 'Please create a room first', '‚ùå');
                return;
            }
            
            if (confirm('Start retention phase? All users will be redirected to retention page with 90 seconds timer.')) {
                socket.emit('startRetention', { 
                    roomCode: currentRoomCode,
                    sessionId: currentSessionId 
                });
                
                startRetentionBtn.innerHTML = `
                    <span class="flex items-center justify-center space-x-2">
                        <span class="animate-pulse">‚è≥</span>
                        <span>Starting...</span>
                    </span>
                `;
                startRetentionBtn.disabled = true;
                
                showAlert('Retention Started', 'All users are being redirected to retention page.', 'üöÄ');
            }
        }
        
        function startAuctionPool() {
            if (!currentSessionId || !currentRoomCode) {
                showAlert('Session Error', 'Please create a room first', '‚ùå');
                return;
            }
            
            if (confirm('Start auction pool phase? All non-retained players will go into auction.')) {
                socket.emit('startAuctionPool', { 
                    roomCode: currentRoomCode,
                    sessionId: currentSessionId 
                });
                
                startAuctionPoolBtn.disabled = true;
                startAuctionPoolBtn.innerHTML = `
                    <span class="flex items-center justify-center space-x-2">
                        <span>‚úÖ</span>
                        <span>Auction Started</span>
                    </span>
                `;
                
                // Show auction controls
                auctionPoolControls.classList.remove('hidden');
                document.getElementById('auctionNotStarted').classList.add('hidden');
                
                showAlert('Auction Pool Started', 'Auction pool has started! Click "Go to Auction Control" to manage the auction.', 'üöÄ');
            }
        }
        
        function gotoAuction() {
            if (!currentRoomCode) {
                showAlert('Error', 'No active room', '‚ùå');
                return;
            }
            
            // Update session data with room code
            updateSessionStorageWithRoom(currentRoomCode);
            
            // Redirect to auction control page
            window.location.href = `auctioneer-auction.html?roomCode=${currentRoomCode}&sessionId=${currentSessionId}`;
        }
        
        function forceShuffle() {
            const username = forceShuffleUser.value;
            if (!username || !currentSessionId || !currentRoomCode) return;
            
            if (confirm(`Force shuffle team for ${username}?`)) {
                socket.emit('forceShuffle', { 
                    roomCode: currentRoomCode,
                    username: username,
                    sessionId: currentSessionId 
                });
                
                forceShuffleBtn.disabled = true;
                forceShuffleBtn.innerHTML = 'Shuffling...';
                
                setTimeout(() => {
                    forceShuffleBtn.disabled = false;
                    forceShuffleBtn.innerHTML = 'üîÄ Shuffle';
                }, 2000);
            }
        }
        
        function clearBidLog() {
            bidLog.innerHTML = '<div class="text-center text-gray-500 py-4">No bids yet</div>';
        }
        
        // ========== SOCKET EVENT HANDLERS ==========
        function setupSocketEvents() {
            socket.on('roomCreated', (data) => {
                currentRoomCode = data.roomCode;
                roomCodeDisplay.textContent = data.roomCode;
                document.getElementById('roomCode').textContent = data.roomCode;
                roomInfo.classList.remove('hidden');
                
                createRoomBtn.innerHTML = '‚úÖ Room Created';
                createRoomBtn.disabled = true;
                createRoomBtn.classList.remove('btn-gradient');
                createRoomBtn.classList.add('bg-gradient-to-r', 'from-green-500/20', 'to-green-600/20', 'border', 'border-green-500/30');
                
                lockRulesBtn.disabled = false;
                
                // Show room code container
                roomCodeContainer.classList.remove('hidden');
                noRoomContainer.classList.add('hidden');
                
                currentRoomStatus.textContent = data.roomCode;
                currentRoomStatus.className = 'px-2 py-1 bg-green-500/20 text-green-400 rounded-full text-xs';
                
                showAlert('Room Created', `Room code: ${data.roomCode}\n\nShare this code with users to join.`, '‚úÖ');
                
                // Store in localStorage
                updateSessionStorageWithRoom(data.roomCode);
            });
            
            socket.on('userJoined', (data) => {
    updateUserCount(data.totalUsers);
    
    // Check if user already exists
    const existingUser = userList.querySelector(`[data-username="${data.username}"]`);
    if (existingUser) {
        // Update existing user (remove duplicate)
        return;
    }
    
    // Remove "waiting" text once
    if (userList.firstChild?.textContent?.includes('Waiting')) {
        userList.innerHTML = '';
    }
    
    const userItem = document.createElement('div');
    userItem.className = 'user-item glass-panel rounded-xl p-4 slide-in';
    userItem.setAttribute('data-username', data.username);
    
    userItem.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="font-medium">${data.username}</span>
            </div>
            <div class="flex items-center space-x-2">
                <button class="force-shuffle-btn text-sm text-gray-400 hover:text-yellow-400 transition-colors" 
                        data-username="${data.username}">
                    üîÄ
                </button>
            </div>
        </div>
    `;
    
    userList.appendChild(userItem);
    
    // Add to force shuffle dropdown (remove duplicates)
    const existingOption = Array.from(forceShuffleUser.options).find(
        opt => opt.value === data.username
    );
    
    if (!existingOption) {
        const option = document.createElement('option');
        option.value = data.username;
        option.textContent = data.username;
        option.className = 'text-white bg-gray-800';
        forceShuffleUser.appendChild(option);
    }
    
    // Show force shuffle section if users exist
    if (data.totalUsers > 0) {
        forceShuffleSection.classList.remove('hidden');
    }
    
    updateStats();
});

socket.on('userLeft', (data) => {
    updateUserCount(data.totalUsers);
    
    // Remove user from list
    const userItem = userList.querySelector(`[data-username="${data.username}"]`);
    if (userItem) {
        userItem.remove();
    }
    
    // Remove from force shuffle dropdown
    const option = forceShuffleUser.querySelector(`option[value="${data.username}"]`);
    if (option) {
        option.remove();
    }
    
    updateStats();
});
            
            socket.on('teamMapping', (data) => {
                teamMapping.classList.remove('hidden');
                teamList.innerHTML = '';
                
                data.mapping.forEach(item => {
                    const teamItem = document.createElement('div');
                    teamItem.className = 'user-item glass-panel rounded-xl p-4 slide-in';
                    teamItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="font-medium">${item.username}</span>
                            <span class="bg-gradient-to-r from-yellow-400 to-orange-400 bg-clip-text text-transparent font-bold">
                                ${item.team}
                            </span>
                        </div>
                    `;
                    teamList.appendChild(teamItem);
                });
                
                startRetentionBtn.disabled = false;
                
                updateStats();
            });
            
            socket.on('teamShuffled', (data) => {
    console.log('üîÑ Team shuffled:', data);
    
    // Update team mapping display
    const items = teamList.querySelectorAll('.user-item');
    for (let item of items) {
        if (item.textContent.includes(data.username)) {
            item.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="font-medium">${data.username}</span>
                    <span class="bg-gradient-to-r from-yellow-400 to-orange-400 bg-clip-text text-transparent font-bold">${data.team}</span>
                </div>
            `;
            break;
        }
    }
    
    // Also update in the user list if shown
    const userItems = userList.querySelectorAll('.user-item');
    for (let item of userItems) {
        if (item.textContent.includes(data.username)) {
            // Add a visual indicator that team was shuffled
            item.classList.add('bg-gradient-to-r', 'from-yellow-900/20', 'to-orange-900/20');
            break;
        }
    }
    
    showAlert('Team Shuffled', `${data.username} shuffled to ${data.team}`, 'üîÑ');
});
            socket.on('retentionSubmitted', (data) => {
                retentionProgress.classList.remove('hidden');
                
                // Check if already added
                const existingItems = Array.from(submissionList.children);
                const alreadyExists = existingItems.some(item => 
                    item.textContent.includes(data.username)
                );
                
                if (!alreadyExists) {
                    const subItem = document.createElement('div');
                    subItem.className = 'user-item glass-panel rounded-xl p-4 slide-in';
                    subItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                                <div>
                                    <div class="font-medium">${data.username}</div>
                                    <div class="text-xs text-gray-500">${data.team}</div>
                                </div>
                            </div>
                            <div class="px-3 py-1 bg-blue-500/20 text-blue-300 rounded-full text-sm font-semibold">
                                ${data.count} players
                            </div>
                        </div>
                    `;
                    submissionList.appendChild(subItem);
                }
                
                // Enable auction pool button if all users submitted
                const totalUsers = parseInt(userCount.textContent);
                const submittedCount = submissionList.children.length;
                
                if (totalUsers > 0 && submittedCount >= totalUsers) {
                    startAuctionPoolBtn.disabled = false;
                    showAlert('All Submissions Received', 'All users have submitted retention. Ready to start auction pool.', '‚úÖ');
                }
                
                updateStats();
            });

            // Current code in auctioneer.html (look for this):
socket.on('retentionSubmitted', (data) => {
    retentionProgress.classList.remove('hidden');
    
    // Check if already added
    const existingItems = Array.from(submissionList.children);
    const alreadyExists = existingItems.some(item => 
        item.textContent.includes(data.username)
    );
    
    if (!alreadyExists) {
        const subItem = document.createElement('div');
        subItem.className = 'user-item glass-panel rounded-xl p-4 slide-in';
        subItem.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 rounded-full bg-green-500 ${data.autoSubmitted ? 'animate-pulse' : ''}"></div>
                    <div>
                        <div class="font-medium">${data.username}</div>
                        <div class="text-xs text-gray-500">${data.team}</div>
                        ${data.autoSubmitted ? '<div class="text-xs text-yellow-500 mt-1">Auto-submitted</div>' : ''}
                    </div>
                </div>
                <div class="px-3 py-1 ${data.count > 0 ? 'bg-blue-500/20 text-blue-300' : 'bg-gray-500/20 text-gray-300'} rounded-full text-sm font-semibold">
                    ${data.count} players
                </div>
            </div>
        `;
        submissionList.appendChild(subItem);
    }
    
    // Get total users count
    const userListItems = document.querySelectorAll('#userList .user-item');
    const totalUsers = userListItems.length;
    const submittedCount = submissionList.children.length;
    
    console.log(`üìä Retention progress: ${submittedCount}/${totalUsers}`);
    
    // If all users submitted, enable auction pool button
    if (totalUsers > 0 && submittedCount >= totalUsers) {
        console.log('üéØ All users have submitted retention!');
        
        // Enable auction pool button
        startAuctionPoolBtn.disabled = false;
        
        // Add visual feedback
        const allCompleteItem = document.createElement('div');
        allCompleteItem.className = 'user-item glass-panel rounded-xl p-4 slide-in border-2 border-green-500/30 bg-green-900/10';
        allCompleteItem.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <div>
                        <div class="font-medium text-green-400">READY FOR AUCTION</div>
                        <div class="text-xs text-gray-500">All users submitted retention</div>
                    </div>
                </div>
                <div class="px-3 py-1 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full text-sm font-semibold animate-pulse">
                    ‚úÖ Complete
                </div>
            </div>
        `;
        submissionList.appendChild(allCompleteItem);
        
        // Show alert
        showAlert('Ready for Auction Pool', 
            `All ${totalUsers} users have submitted their retention selections. You can now start the auction pool.`, 
            '‚úÖ');
    }
});

// ‚úÖ ADD THIS NEW HANDLER AFTER the retentionSubmitted handler
// Add this socket handler inside the setupSocketEvents function in auctioneer.html:
socket.on('allRetentionSubmitted', (data) => {
    console.log('‚úÖ All retention submissions received:', data);
    
    // Enable the auction pool button
    startAuctionPoolBtn.disabled = false;
    startAuctionPoolBtn.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
    
    // Show success message
    showAlert('Ready for Auction Pool', 
        `${data.message}\n\n${data.submittedCount}/${data.totalUsers} users submitted`, 
        '‚úÖ');
    
    // Update the retention progress display
    if (data.submittedCount === data.totalUsers) {
        const progressItem = document.createElement('div');
        progressItem.className = 'user-item glass-panel rounded-xl p-4 slide-in';
        progressItem.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <div>
                        <div class="font-medium text-green-400">ALL USERS COMPLETED</div>
                        <div class="text-xs text-gray-500">Retention phase complete</div>
                    </div>
                </div>
                <div class="px-3 py-1 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full text-sm font-semibold">
                    ‚úÖ Complete
                </div>
            </div>
        `;
        submissionList.appendChild(progressItem);
        
        // Also add a visual indicator to the button
        startAuctionPoolBtn.innerHTML = `
            <span class="flex items-center justify-center space-x-2">
                <span class="animate-pulse">üöÄ</span>
                <span>START AUCTION POOL</span>
                <span class="animate-pulse">‚≠ê</span>
            </span>
        `;
    }
});
            
            // Auction events
            socket.on('auctionStarted', (data) => {
                console.log('üöÄ Auction pool started:', data);
                showAlert('Auction Pool Started', data.message, 'üöÄ');
            });
            
            socket.on('auctionUpdate', (data) => {
                console.log('üìä Auction update:', data);
                auctioneerCategory.textContent = data.category || '-';
                auctioneerCurrentBid.textContent = data.currentBid ? `‚Çπ${data.currentBid} Cr` : '-';
                auctioneerPlayersLeft.textContent = data.playersLeft || '-';
                auctioneerUnsold.textContent = data.unsoldCount || '0';
            });
            
            socket.on('bidUpdate', (data) => {
                console.log('üí∞ Bid update:', data);
                addBidToLog(data.team, data.bid, 'BID');
            });
            
            socket.on('playerSold', (data) => {
                console.log('‚úÖ Player sold:', data);
                addBidToLog('SOLD', `${data.player} ‚Üí ${data.team} for ‚Çπ${data.price} Cr`, 'SOLD');
            });
            
            socket.on('playerUnsold', (data) => {
                console.log('‚ùå Player unsold:', data);
                addBidToLog('UNSOLD', `${data.player} unsold`, 'UNSOLD');
            });
            
            socket.on('auctionComplete', (data) => {
                console.log('üèÜ Auction complete:', data);
                showAlert('Auction Complete', 'All players have been auctioned!', 'üèÜ');
                addBidToLog('SYSTEM', 'Auction pool completed!', 'COMPLETE');
            });
            
            socket.on('error', (data) => {
                console.error('‚ùå Socket error:', data);
                showAlert('Error', data.message, '‚ùå');
                
                // If session error, redirect to login
                if (data.message.includes('session') || data.message.includes('Session') || data.message.includes('unauthorized') || data.message.includes('invalid')) {
                    setTimeout(() => {
                        redirectToLogin();
                    }, 2000);
                }
            });
            
            socket.on('roomDestroyed', () => {
                showAlert('Room Closed', 'Room has been reset', 'üö™');
                setTimeout(() => {
                    localStorage.removeItem('auctioneerRoomCode');
                    location.reload();
                }, 3000);
            });

            socket.on('retentionStatusUpdate', (data) => {
    console.log('üìä Retention status update:', data);
    showAlert('Retention Status', 
        `Submitted: ${data.submitted}/${data.total}\n\n${data.message}`, 
        data.submitted >= data.total ? '‚úÖ' : '‚ö†Ô∏è');
});
            
            socket.on('forceShuffleResult', (data) => {
                console.log('üîÑ Force shuffle result:', data);
                showAlert('Force Shuffle', `${data.username} shuffled from ${data.oldTeam} to ${data.team}`, 'üîÑ');
            });
        }
        
        // Click on individual shuffle button
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('force-shuffle-btn')) {
                const username = e.target.dataset.username;
                if (!currentSessionId || !currentRoomCode) {
                    showAlert('Session Error', 'Please create a room first', '‚ùå');
                    return;
                }
                
                if (confirm(`Force shuffle team for ${username}?`)) {
                    socket.emit('forceShuffle', { 
                        roomCode: currentRoomCode,
                        username: username,
                        sessionId: currentSessionId 
                    });
                    
                    e.target.innerHTML = '‚è≥';
                    e.target.disabled = true;
                    
                    setTimeout(() => {
                        e.target.innerHTML = 'üîÄ';
                        e.target.disabled = false;
                    }, 2000);
                }
            }
        });
        // ========== MANUAL RETENTION CHECK ==========
function forceCheckRetention() {
    if (!currentRoomCode || !currentSessionId) {
        showAlert('Error', 'No active room or session', '‚ùå');
        return;
    }
    
    console.log('üîç Manual retention check triggered');
    
    socket.emit('checkRetentionStatus', {
        roomCode: currentRoomCode,
        sessionId: currentSessionId
    });
    
    showAlert('Checking Retention', 'Checking retention submission status...', 'üîç');
}

        // ========== HELPER FUNCTIONS ==========
        function updateConnectionStatus(status, color) {
            const colorClass = color === 'green' ? 'bg-green-500' : 'bg-red-500';
            const textColor = color === 'green' ? 'text-green-400' : 'text-red-400';
            
            connectionStatus.innerHTML = `
                <div class="w-2 h-2 rounded-full ${colorClass} mr-2 ${color === 'green' ? 'animate-pulse' : ''}"></div>
                <span class="${textColor} text-sm">${status}</span>
            `;
        }
        
        function updateUserCount(count) {
            userCount.textContent = `${count} users`;
            connectedCount.textContent = count;
        }
        
        function updateStats() {
            // Update total players (from users list)
            const userItems = userList.querySelectorAll('.user-item');
            totalPlayers.textContent = userItems.length;
            
            // Update teams assigned
            const teamItems = teamList.querySelectorAll('.user-item');
            teamsAssigned.textContent = teamItems.length;
            
            // Update retention done
            const retentionItems = submissionList.querySelectorAll('.user-item');
            retentionDone.textContent = retentionItems.length;
        }
        
        

        function addBidToLog(team, bid, type = 'BID') {
            const bidItem = document.createElement('div');
            bidItem.className = `bid-log-item glass-panel rounded-xl p-4 new`;
            
            // Get color based on type
            let color = '#FFFFFF';
            let icon = 'üí∞';
            
            switch(type) {
                case 'SOLD':
                    color = '#10B981';
                    icon = '‚úÖ';
                    break;
                case 'UNSOLD':
                    color = '#EF4444';
                    icon = '‚ùå';
                    break;
                case 'COMPLETE':
                    color = '#8B5CF6';
                    icon = 'üèÜ';
                    break;
                default:
                    color = '#3B82F6';
                    icon = 'üí∞';
            }
            
            bidItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="text-xl">${icon}</div>
                        <div>
                            <div class="font-semibold" style="color: ${color}">${team.toUpperCase()}</div>
                            <div class="text-xs text-gray-400">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                    </div>
                    <span class="font-bold text-yellow-400">${bid}</span>
                </div>
            `;
            
            bidLog.prepend(bidItem);
            
            // Limit log to 20 items
            if (bidLog.children.length > 20) {
                bidLog.removeChild(bidLog.lastChild);
            }
        }
        
        function showAlert(title, message, icon = '‚ö†Ô∏è') {
            const modal = document.getElementById('alertModal');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            
            modalIcon.textContent = icon;
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            modal.classList.remove('hidden');
        }
        
        function closeModal() {
            document.getElementById('alertModal').classList.add('hidden');
        }
        
        function updateDebugPanel() {
            debugSessionId.textContent = currentSessionId ? currentSessionId.substring(0, 8) + '...' : '---';
            debugUsername.textContent = currentUsername || '---';
            debugRole.textContent = currentRole || '---';
            debugRoom.textContent = currentRoomCode || '---';
        }
        
        function toggleDebug() {
            debugPanel.classList.toggle('hidden');
        }
        
        window.closeModal = closeModal;
        window.logout = logout;
        window.toggleDebug = toggleDebug;
        
        console.log('‚úÖ Auctioneer page loaded with enhanced session management');
    </script>
</body>
</html>