<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retention Phase - IPL Auction</title>
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Poppins', sans-serif; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .player-card {
            transition: all 0.3s ease;
        }
        
        .player-card:hover {
            transform: translateY(-5px);
        }
        
        .player-card.selected {
            border-color: #F59E0B;
            box-shadow: 0 10px 25px -5px rgba(245, 158, 11, 0.3);
            position: relative;
        }
        
        .player-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #F59E0B;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .pulse-timer {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .player-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #1e293b, #475569);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            overflow: hidden;
        }
        
        .overseas-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(45deg, #8B5CF6, #7C3AED);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 9px;
        }
        
        .stat-value {
            color: #f1f5f9;
            font-weight: 600;
        }
        
        .role-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .role-bat { background: rgba(34, 197, 94, 0.2); color: #22C55E; }
        .role-bowl { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .role-ar { background: rgba(168, 85, 247, 0.2); color: #A855F7; }
        .role-wk { background: rgba(245, 158, 11, 0.2); color: #F59E0B; }
        
        .timer-warning {
            animation: warning-pulse 1s infinite;
        }
        
        @keyframes warning-pulse {
            0%, 100% { color: #f1f5f9; }
            50% { color: #ef4444; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-blue-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
                    Retention Phase
                </h1>
                <div id="teamHeader" class="flex items-center justify-center md:justify-start space-x-3">
                    <!-- Team logo and name will be inserted here -->
                </div>
            </div>
            
            <!-- Timer -->
            <div class="bg-gradient-to-r from-red-900/30 to-rose-900/30 rounded-xl p-4 md:p-6 text-center">
                <div class="text-sm text-gray-300 mb-1">TIME REMAINING</div>
                <div id="timer" class="text-3xl md:text-4xl font-bold pulse-timer">01:30</div>
                <div class="text-xs text-gray-400 mt-1">Select players to retain</div>
            </div>
        </header>

        <!-- Selection Stats -->
        <div class="glass-panel rounded-2xl p-6 mb-8 slide-in">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center p-4 rounded-lg bg-blue-900/20">
                    <div class="text-2xl font-bold text-blue-400" id="selectedCount">0</div>
                    <div class="text-sm text-gray-400">Selected Players</div>
                </div>
                <div class="text-center p-4 rounded-lg bg-green-900/20">
                    <div class="text-2xl font-bold text-green-400" id="indianCount">0</div>
                    <div class="text-sm text-gray-400">Indian Players</div>
                </div>
                <div class="text-center p-4 rounded-lg bg-purple-900/20">
                    <div class="text-2xl font-bold text-purple-400" id="overseasCount">0</div>
                    <div class="text-sm text-gray-400">Overseas Players</div>
                </div>
                <div class="text-center p-4 rounded-lg bg-yellow-900/20">
                    <div class="text-2xl font-bold text-yellow-400" id="remainingTime">90s</div>
                    <div class="text-sm text-gray-400">Time Left</div>
                </div>
            </div>
            
            <!-- Limits Display -->
            <div class="mt-4 text-center">
                <div class="text-sm text-gray-400">
                    Limits: Max <span id="maxIndianLimit" class="text-green-400 font-bold">4</span> Indian ‚Ä¢ 
                    Max <span id="maxOverseasLimit" class="text-purple-400 font-bold">3</span> Overseas
                </div>
            </div>
        </div>

        <!-- Players Grid -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4 text-yellow-400">Select Players to Retain</h2>
            <div id="playersGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                <!-- Players will be loaded here -->
            </div>
        </div>
       
        <!-- Empty State -->
        <div id="emptyState" class="text-center py-16">
            <div class="text-6xl mb-4">‚è≥</div>
            <h3 class="text-2xl font-bold text-gray-300 mb-2">Waiting for Retention Data</h3>
            <p class="text-gray-500">Please wait while the auctioneer starts the retention phase...</p>
            <div class="mt-4 flex items-center justify-center space-x-2">
                <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
            </div>
        </div>

        <!-- Manual Submit Button -->
<div class="text-center mb-6" id="manualSubmitSection">
    <button onclick="submitRetention()" 
            class="px-8 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-xl font-bold text-lg transition-all duration-300 hover:scale-[1.02] active:scale-95">
        ‚úÖ Submit Retention Selections
    </button>
    <p class="text-sm text-gray-400 mt-2">
        You can also wait for auto-submission when timer ends
    </p>
</div>

<!-- Auto-Submit Notice -->
<div class="glass-panel rounded-2xl p-6 fixed bottom-6 left-1/2 transform -translate-x-1/2 w-11/12 max-w-2xl z-10 hidden" id="autoSubmitNotice">

        <!-- Auto-Submit Notice -->
        <div class="glass-panel rounded-2xl p-6 fixed bottom-6 left-1/2 transform -translate-x-1/2 w-11/12 max-w-2xl z-10 hidden" id="autoSubmitNotice">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="text-center md:text-left">
                    <h3 class="font-semibold text-gray-300">‚ö†Ô∏è Auto-Submission Notice</h3>
                    <p class="text-sm text-gray-400">
                        Your selections will be automatically submitted when the timer ends.
                        <br>If no players are selected, you'll enter auction with zero retained players.
                    </p>
                </div>
                
                <div class="flex space-x-4">
                    <button onclick="clearAllSelections()" 
                            class="px-6 py-3 bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-800 hover:to-gray-900 rounded-xl font-semibold transition-all duration-300">
                        Clear All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="statsModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black/70"></div>
        <div class="glass-panel rounded-2xl p-6 max-w-2xl w-11/12 max-h-[80vh] overflow-y-auto z-10">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-yellow-400" id="statsPlayerName">Player Stats</h2>
                <button onclick="closeStatsModal()" class="text-2xl hover:text-yellow-400">‚úï</button>
            </div>
            
            <div class="space-y-4">
                <div id="statsContent">
                    <!-- Stats will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black/70"></div>
        <div class="glass-panel rounded-2xl p-6 max-w-md mx-4 z-10">
            <div class="text-center">
                <div class="text-4xl mb-4" id="modalIcon">‚ö†Ô∏è</div>
                <h3 class="text-2xl font-bold mb-2" id="modalTitle">Alert</h3>
                <p class="text-gray-300 mb-6" id="modalMessage">This is a modal message</p>
                <button onclick="closeModal()" 
                        class="px-6 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg font-semibold">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== GLOBAL VARIABLES ==========
        let socket = null;
        let retentionData = null;
        let selectedPlayers = new Map(); // Use Map to store player objects
        let countdownInterval = null;
        let timeLeft = 90;
        let autoSubmitted = false;
        let currentRoomCode = null;
        let currentUsername = null;
        let maxIndian = 4;
        let maxOverseas = 3;

        // ========== DOM ELEMENTS ==========
        const teamHeader = document.getElementById('teamHeader');
        const timer = document.getElementById('timer');
        const playersGrid = document.getElementById('playersGrid');
        const emptyState = document.getElementById('emptyState');
        const autoSubmitNotice = document.getElementById('autoSubmitNotice');
        const selectedCount = document.getElementById('selectedCount');
        const indianCount = document.getElementById('indianCount');
        const overseasCount = document.getElementById('overseasCount');
        const remainingTime = document.getElementById('remainingTime');
        const maxIndianLimit = document.getElementById('maxIndianLimit');
        const maxOverseasLimit = document.getElementById('maxOverseasLimit');

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîÑ Retention page loading...');
            
            // Get user info from localStorage
            const auctionUser = JSON.parse(localStorage.getItem('auctionUser') || '{}');
            currentRoomCode = auctionUser.roomCode;
            currentUsername = auctionUser.username;
            
            console.log('üìä User data:', { 
                roomCode: currentRoomCode, 
                username: currentUsername 
            });
            
            if (!currentRoomCode || !currentUsername) {
                showAlert('Session Error', 'No session found. Please rejoin from user page.', '‚ùå');
                setTimeout(() => {
                    window.location.href = 'user.html';
                }, 3000);
                return;
            }
            
            // Initialize socket connection
            initializeSocket();
        });

        // ========== SOCKET FUNCTIONS ==========
        function initializeSocket() {
            console.log('üîå Connecting to socket server...');
            socket = io(window.BACKEND_URL,{ transports: ["websocket", "polling"],}
        );
            
            socket.on('connect', () => {
                console.log('‚úÖ Connected to server');
                
                // Join retention with session data
                const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
                const currentSession = JSON.parse(localStorage.getItem('currentSession') || '{}');
                
                socket.emit('joinRetention', {
                    roomCode: currentRoomCode,
                    username: currentUsername,
                    sessionId: userSession.sessionId || currentSession.sessionId
                });
                
                console.log('üì§ Sent joinRetention request');
            });
            
            socket.on('connect_error', (error) => {
                console.error('‚ùå Connection error:', error);
                showAlert('Connection Error', 'Cannot connect to server. Please refresh.', '‚ùå');
            });
            
            socket.on('retentionData', (data) => {
                console.log('üéØ Received retention data:', data);
                retentionData = data;
                
                // Set limits from rules
                if (data.rules) {
                    maxIndian = data.rules.maxIndian || 4;
                    maxOverseas = data.rules.maxOverseas || 3;
                    maxIndianLimit.textContent = maxIndian;
                    maxOverseasLimit.textContent = maxOverseas;
                }
                
                initializePage();
            });
            
            socket.on('redirectToAuctionPool', (data) => {
                console.log('üöÄ Redirecting to auction pool:', data);
                showAlert('Auction Pool Starting', 'Retention phase complete. Moving to auction pool...', 'üí∞');
                
                // Update localStorage with current data
                // In retention.html's autoSubmitRetention function:
localStorage.setItem('userSession', JSON.stringify({
    username: currentUsername,
    roomCode: currentRoomCode,
    team: retentionData?.team,
    sessionId: userSession.sessionId
}));
                
                setTimeout(() => {
                    window.location.href = 'auctionpool.html';
                }, 2000);
            });
            
            socket.on('roomClosed', () => {
                showAlert('Room Closed', 'Auctioneer has disconnected.', 'üö™');
                setTimeout(() => {
                    window.location.href = 'user.html';
                }, 3000);
            });
            
            socket.on('error', (data) => {
                showAlert('Error', data.message, '‚ùå');
            });
                // ... existing socket handlers ...

    // ‚úÖ ADD THESE NEW HANDLERS BEFORE THE CLOSING BRACE
    socket.on('retentionSubmitSuccess', (data) => {
        console.log('‚úÖ Retention submit success:', data);
        // Success is already handled in the callback
    });

    socket.on('retentionSubmitError', (data) => {
        console.error('‚ùå Retention submit error:', data);
        showAlert('Submission Error', data.message || 'Failed to submit retention', '‚ùå');
    });
    
    // Make socket available globally
    window.socket = socket;
    
    console.log('üîå Socket initialized for retention');
} // This is the closing brace of initializeSocket()
        

        // ========== PAGE FUNCTIONS ==========
        function initializePage() {
    console.log('üîÑ Initializing page with retention data...');
    
    if (!retentionData) {
        console.error('‚ùå No retention data available');
        showErrorState('No retention data received');
        return;
    }
    
    if (!retentionData.team) {
        console.error('‚ùå No team data in retention data');
        showErrorState('No team assigned');
        return;
    }
    
    console.log(`üèÜ User team: ${retentionData.team.name}`);
    console.log(`üìä Players received: ${retentionData.players?.length || 0}`);
    
    // Hide loading state
    emptyState.classList.add('hidden');
    
    // Display team info
    displayTeamInfo();
    
    // Load players
    loadPlayers();
    
    // Show submit button and auto-submit notice
    document.getElementById('manualSubmitSection').classList.remove('hidden');
    autoSubmitNotice.classList.remove('hidden');
    
    // Start timer
    startTimer();
    
    // Update counts
    updateCounts();
    
    console.log('‚úÖ Page initialized successfully');
}
        
        function displayTeamInfo() {
            if (!retentionData.team) return;
            
            teamHeader.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center relative" 
                         style="background: ${retentionData.team.color}20; border: 2px solid ${retentionData.team.color}">
                        <div class="w-12 h-12 rounded-full bg-gray-900/80 flex items-center justify-center overflow-hidden">
                            <img src="${retentionData.team.logo || 'default-player.svg'}" 
                                 alt="${retentionData.team.name}" 
                                 class="w-full h-full object-contain p-1"
                                 onerror="this.onerror=null; this.src='default-player.svg';">
                        </div>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold" style="color: ${retentionData.team.color}">${retentionData.team.name}</h2>
                        <p class="text-gray-400 text-sm">Retention Phase</p>
                        <p class="text-gray-500 text-xs">${currentUsername}</p>
                    </div>
                </div>
            `;
        }
        
        function showErrorState(message) {
            emptyState.classList.remove('hidden');
            emptyState.innerHTML = `
                <div class="text-6xl mb-4">‚ùå</div>
                <h3 class="text-2xl font-bold text-gray-300 mb-2">Error</h3>
                <p class="text-gray-500 mb-4">${message}</p>
                <button onclick="window.location.href='rules.html'" 
                        class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg font-semibold">
                    Return to Rules
                </button>
            `;
        }

        // ========== PLAYERS MANAGEMENT ==========
        function loadPlayers() {
            const players = retentionData.players || [];
            
            console.log(`üîÑ Loading ${players.length} players...`);
            
            if (players.length === 0) {
                emptyState.classList.remove('hidden');
                emptyState.innerHTML = `
                    <div class="text-6xl mb-4">üèè</div>
                    <h3 class="text-2xl font-bold text-gray-300 mb-2">No Players Available</h3>
                    <p class="text-gray-500">There are no players in ${retentionData.team?.name || 'your team'} for retention.</p>
                `;
                return;
            }
            
            playersGrid.innerHTML = '';
            
            players.forEach((player, index) => {
                createPlayerCard(player, index);
            });
            
            console.log(`‚úÖ Created ${players.length} player cards`);
        }
        
        function createPlayerCard(player, index) {
            const playerCard = document.createElement('div');
            playerCard.className = 'player-card glass-panel rounded-xl p-4 cursor-pointer hover:transform hover:-translate-y-1 transition-all duration-300 relative';
            playerCard.dataset.id = player.id || `player_${index}`;
            playerCard.dataset.index = index;
            
            // Determine if overseas
            let isOverseas = player.isOverseas || false;
            if (!player.isOverseas && player.nationality) {
                const natLower = player.nationality.toString().toLowerCase().trim();
                isOverseas = !(
                    natLower === 'indian' ||
                    natLower === 'india' ||
                    natLower === 'ind' ||
                    natLower.includes('indian')
                );
            }
            playerCard.dataset.isOverseas = isOverseas;
            
            // Determine role class and display name
            const role = player.role || 'Player';
            let roleClass = 'role-bat';
            let roleDisplay = role;
            
            if (role) {
                const roleLower = role.toLowerCase();
                if (roleLower.includes('bowl') || roleLower.includes('pace') || roleLower.includes('spin') || roleLower === 'bow') {
                    roleClass = 'role-bowl';
                    roleDisplay = 'Bowler';
                } else if (roleLower.includes('all') || roleLower.includes('ar')) {
                    roleClass = 'role-ar';
                    roleDisplay = 'All-Rounder';
                } else if (roleLower.includes('wk') || roleLower.includes('keep')) {
                    roleClass = 'role-wk';
                    roleDisplay = 'WK-Batsman';
                } else if (roleLower.includes('bat')) {
                    roleClass = 'role-bat';
                    roleDisplay = 'Batsman';
                }
            }
            
            // Determine bowling type
            const bowlingType = player.bowlingType || 'N/A';
            
            playerCard.innerHTML = `
                ${isOverseas ? '<div class="overseas-badge">‚úàÔ∏è Overseas</div>' : ''}
                <div class="flex items-start space-x-4">
                    <div class="player-image relative">
                        <span class="text-2xl">${getPlayerEmoji(role)}</span>
                        <button onclick="showPlayerStats(event, ${index})" 
                                class="absolute -bottom-1 -right-1 w-6 h-6 bg-yellow-500 rounded-full flex items-center justify-center text-xs hover:bg-yellow-600 transition-colors"
                                title="View Stats">
                            üìä
                        </button>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-lg mb-1">${player.name || 'Unknown Player'}</h3>
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="${roleClass} role-badge">${roleDisplay}</span>
                            ${bowlingType !== 'NO' && bowlingType !== 'N/A' ? 
                                `<span class="text-xs px-2 py-1 bg-gray-800 text-gray-300 rounded">${bowlingType}</span>` : ''}
                        </div>
                        <div class="text-sm text-gray-400">
                            <div class="mb-1">${player.nationality || 'Indian'}</div>
                            <div>Base Price: ‚Çπ${player.basePrice || '2.00'} Cr</div>
                        </div>
                    </div>
                </div>
            `;
            
            playerCard.addEventListener('click', () => {
                if (autoSubmitted) return;
                togglePlayerSelection(playerCard, player, isOverseas);
            });
            
            playersGrid.appendChild(playerCard);
        }
        
        function getPlayerEmoji(role) {
            const roleLower = role.toLowerCase();
            if (roleLower.includes('wk') || roleLower.includes('keep')) return 'üß§';
            if (roleLower.includes('bowl') || roleLower.includes('pace') || roleLower.includes('spin')) return 'üéØ';
            if (roleLower.includes('all') || roleLower.includes('ar')) return '‚ö°';
            return 'üèè';
        }
        
        function togglePlayerSelection(playerCard, player, isOverseas) {
            const playerId = playerCard.dataset.id;
            
            // Check current counts
            let currentIndian = 0;
            let currentOverseas = 0;
            
            selectedPlayers.forEach(p => {
                if (p.isOverseas) {
                    currentOverseas++;
                } else {
                    currentIndian++;
                }
            });
            
            if (selectedPlayers.has(playerId)) {
                // Deselect player
                selectedPlayers.delete(playerId);
                playerCard.classList.remove('selected');
            } else {
                // Check limits before selecting
                if (isOverseas && currentOverseas >= maxOverseas) {
                    showAlert('Limit Reached', `Maximum ${maxOverseas} overseas players allowed`, '‚úàÔ∏è');
                    return;
                }
                if (!isOverseas && currentIndian >= maxIndian) {
                    showAlert('Limit Reached', `Maximum ${maxIndian} Indian players allowed`, 'üáÆüá≥');
                    return;
                }
                
                // Select player
                selectedPlayers.set(playerId, {
                    ...player,
                    isOverseas: isOverseas,
                    index: playerCard.dataset.index
                });
                playerCard.classList.add('selected');
            }
            
            updateCounts();
        }
        
        function updateCounts() {
            let indian = 0;
            let overseas = 0;
            
            selectedPlayers.forEach(player => {
                if (player.isOverseas) {
                    overseas++;
                } else {
                    indian++;
                }
            });
            
            selectedCount.textContent = selectedPlayers.size;
            indianCount.textContent = indian;
            overseasCount.textContent = overseas;
            
            // Update color based on limits
            indianCount.className = `text-2xl font-bold ${indian > maxIndian ? 'text-red-400' : 'text-green-400'}`;
            overseasCount.className = `text-2xl font-bold ${overseas > maxOverseas ? 'text-red-400' : 'text-purple-400'}`;
        }

        // ========== SUBMISSION FUNCTIONS ==========
function getSelectedPlayers() {
    // Convert Map to array of player objects
    const selectedArray = Array.from(selectedPlayers.values());
    
    console.log('üìã Selected players:', selectedArray);
    console.log('üìä Count:', selectedArray.length);
    
    // Ensure each player has required properties
    return selectedArray.map(player => ({
        id: player.id || `player_${player.index}`,
        name: player.name || 'Unknown Player',
        role: player.role || 'Player',
        nationality: player.nationality || 'Indian',
        basePrice: player.basePrice || 2.00,
        isOverseas: player.isOverseas || false,
        // Include any other relevant player data
        ...(player.totalRuns !== undefined && { totalRuns: player.totalRuns }),
        ...(player.wickets !== undefined && { wickets: player.wickets }),
        // Include index for reference
        index: player.index
    }));
}

function submitRetention() {
    if (autoSubmitted) {
        console.log('Already submitted');
        showAlert('Already Submitted', 'Your retention has already been submitted.', '‚ÑπÔ∏è');
        return;
    }
    
    // Get selected players
    const selectedPlayersArray = Array.from(selectedPlayers.values());
    
    // Get session
    const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
    const currentSession = JSON.parse(localStorage.getItem('currentSession') || '{}');
    const sessionId = userSession.sessionId || currentSession.sessionId;
    
    if (!sessionId) {
        console.error('‚ùå No session ID found');
        showAlert('Session Error', 'Cannot submit without session. Please refresh.', '‚ùå');
        return;
    }
    
    console.log('üì§ Manual retention submission:', {
        roomCode: currentRoomCode,
        username: currentUsername,
        count: selectedPlayersArray.length,
        sessionId: sessionId
    });
    
    // Show loading state
    const submitBtn = document.querySelector('#manualSubmitSection button');
    const originalHTML = submitBtn ? submitBtn.innerHTML : null;
    
    if (submitBtn) {
        submitBtn.innerHTML = '<span class="flex items-center justify-center space-x-2"><span class="animate-spin">‚è≥</span><span>Submitting...</span></span>';
        submitBtn.disabled = true;
    }
    
    // Format players for submission
    const formattedPlayers = selectedPlayersArray.map(player => ({
        id: player.id || `player_${player.index}`,
        name: player.name || 'Unknown Player',
        role: player.role || 'Player',
        nationality: player.nationality || 'Indian',
        basePrice: player.basePrice || 2.00,
        isOverseas: player.isOverseas || false,
        index: player.index
    }));
    
    // Send with acknowledgment
    socket.emit('submitRetention', {
        roomCode: currentRoomCode,
        username: currentUsername,
        selectedPlayers: formattedPlayers,
        sessionId: sessionId
    }, (response) => {
        console.log('üì® Server response:', response);
        
        if (response && response.success) {
            console.log('‚úÖ Submit successful');
            autoSubmitted = true;
            
            // Update button to show success
            submitBtn = document.querySelector('#manualSubmitSection button');
            if (submitBtn) {
                submitBtn.innerHTML = '<span class="flex items-center justify-center space-x-2"><span>‚úÖ</span><span>Submitted Successfully!</span></span>';
                submitBtn.disabled=true;
                submitBtn.classList.remove('bg-gradient-to-r', 'from-green-500', 'to-emerald-600');
                submitBtn.classList.add('bg-gradient-to-r', 'from-green-900/20', 'to-emerald-900/20', 'border', 'border-green-500/30');
            }
            socket.emit('retentionSubmittedSuccess', {
                username: currentUsername,
                roomCode: currentRoomCode,
                sessionId: sessionId,
                count: formattedPlayers.length
            });
            // Store locally
            localStorage.setItem('retentionSubmitted', 'true');
            localStorage.setItem('retainedPlayers', JSON.stringify(formattedPlayers));
            
            // Disable player selection
            document.querySelectorAll('.player-card').forEach(card => {
                card.style.pointerEvents = 'none';
                card.style.opacity = '0.5';
            });
            
            // Hide auto-submit notice
            autoSubmitNotice.classList.add('hidden');
            
            showAlert('Success!', 
                formattedPlayers.length > 0 
                    ? `Your ${formattedPlayers.length} selected players have been retained.` 
                    : 'You submitted with zero retained players.',
                formattedPlayers.length > 0 ? '‚úÖ' : '‚ö†Ô∏è');
            
        } else {
            console.error('‚ùå Submit failed:', response?.message);
            
            // Reset button on error
            if (submitBtn && originalHTML) {
                submitBtn.innerHTML = originalHTML;
                submitBtn.disabled = false;
            }
            
            showAlert('Submission Failed', 
                response?.message || 'Failed to submit retention. Please try again.', 
                '‚ùå');
        }
    });
}

        // ========== TIMER FUNCTIONS ==========
        function startTimer() {
            if (timeLeft < 0) timeLeft = 0;
            updateTimerDisplay();
            
            countdownInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    timeLeft = 0;
                    updateTimerDisplay();
                    autoSubmitRetention();
                    return;
                }
                timeLeft--;
                updateTimerDisplay();
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            
            timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            remainingTime.textContent = `${timeLeft}s`;
            
            timer.classList.remove('text-red-400', 'text-yellow-400', 'text-white', 'pulse-timer', 'timer-warning');
            
            if (timeLeft <= 30) {
                timer.classList.add('text-red-400', 'timer-warning');
            } else if (timeLeft <= 60) {
                timer.classList.add('text-yellow-400');
            } else {
                timer.classList.add('text-white', 'pulse-timer');
            }
        }
        
        // Replace the autoSubmitRetention function in retention.html:
function autoSubmitRetention() {
    if (autoSubmitted) {
        console.log('Already auto-submitted');
        return;
    }
    
    autoSubmitted = true;
    clearInterval(countdownInterval);
    
    const selectedPlayersData = Array.from(selectedPlayers.values());
    
    console.log('üì§ Auto-submitting retention:'); 
        submitRetention();
    
    
    // Get session ID properly
    const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
    const currentSession = JSON.parse(localStorage.getItem('currentSession') || '{}');
    const sessionId = userSession.sessionId || currentSession.sessionId;
    
    if (!sessionId) {
        console.error('‚ùå No session ID found for auto-submit');
        showAlert('Session Error', 'Cannot submit without session. Please refresh.', '‚ùå');
        return;
    }
    
    // Send to server with PROPER error handling
    socket.emit('submitRetention', {
        roomCode: currentRoomCode,
        username: currentUsername,
        selectedPlayers: selectedPlayersData,
        sessionId: sessionId
    }, (response) => {
        // Add acknowledgment callback
        if (response && response.success) {
            console.log('‚úÖ Auto-submit acknowledged by server');
            
            // Store retention data in localStorage
            localStorage.setItem('retentionSubmitted', 'true');
            localStorage.setItem('retainedPlayers', JSON.stringify(selectedPlayersData));
            
            // Show auto-submitted message
            showAlert('Retention Auto-Submitted', 
                selectedPlayersData.length > 0 
                    ? `Your ${selectedPlayersData.length} selected players have been retained.` 
                    : 'No players selected. You will enter auction with zero retained players.',
                selectedPlayersData.length > 0 ? '‚úÖ' : '‚ö†Ô∏è');
            
            // Disable all player cards
            document.querySelectorAll('.player-card').forEach(card => {
                card.style.pointerEvents = 'none';
                card.style.opacity = '0.5';
            });
            
            // Wait 3 seconds then show redirect message
            setTimeout(() => {
                showAlert('Auction Pool Starting', 'Moving to auction pool in 5 seconds...', 'üí∞');
                setTimeout(() => {
                    window.location.href = 'auctionpool.html';
                }, 5000);
            }, 3000);
        } else {
            console.error('‚ùå Auto-submit failed:', response?.message);
            showAlert('Submission Failed', 'Failed to submit retention. Please refresh.', '‚ùå');
        }
    });
    
    // Fallback in case server doesn't respond
    setTimeout(() => {
        if (!autoSubmitted) return;
        
        // Even if server doesn't respond, store locally and redirect
        localStorage.setItem('retentionSubmitted', 'true');
        localStorage.setItem('retainedPlayers', JSON.stringify(selectedPlayersData));
        
        setTimeout(() => {
            showAlert('Moving to Auction', 'Redirecting to auction pool...', 'üí∞');
            window.location.href = 'auctionpool.html';
        }, 3000);
    }, 5000);
}

        // ========== STATS MODAL FUNCTIONS ==========
        function showPlayerStats(e, index) {
            e.stopPropagation();
            
            const players = retentionData.players || [];
            if (index >= players.length) return;
            
            const player = players[index];
            if (!player) return;
            
            document.getElementById('statsPlayerName').textContent = player.name || 'Player Stats';
            
            // Get all stats except marqueeSet and basePrice
            const statsContent = document.getElementById('statsContent');
            statsContent.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    ${player.totalRuns !== undefined ? `
                        <div class="bg-gray-800/30 p-4 rounded-lg">
                            <div class="text-sm text-gray-400">Total Runs</div>
                            <div class="text-lg font-bold text-green-400">${player.totalRuns}</div>
                        </div>
                    ` : ''}
                    
                    ${player.highestScore !== undefined ? `
                        <div class="bg-gray-800/30 p-4 rounded-lg">
                            <div class="text-sm text-gray-400">Highest Score</div>
                            <div class="text-lg font-bold text-yellow-400">${player.highestScore}</div>
                        </div>
                    ` : ''}
                    
                    ${player.strikeRate !== undefined ? `
                        <div class="bg-gray-800/30 p-4 rounded-lg">
                            <div class="text-sm text-gray-400">Strike Rate</div>
                            <div class="text-lg font-bold text-blue-400">${player.strikeRate}</div>
                        </div>
                    ` : ''}
                    
                    ${player.wickets !== undefined ? `
                        <div class="bg-gray-800/30 p-4 rounded-lg">
                            <div class="text-sm text-gray-400">Wickets</div>
                            <div class="text-lg font-bold text-red-400">${player.wickets}</div>
                        </div>
                    ` : ''}
                    
                    ${player.economyRate !== undefined ? `
                        <div class="bg-gray-800/30 p-4 rounded-lg">
                            <div class="text-sm text-gray-400">Economy Rate</div>
                            <div class="text-lg font-bold text-purple-400">${player.economyRate}</div>
                        </div>
                    ` : ''}
                    
                    ${player.bestBowling !== undefined ? `
                        <div class="bg-gray-800/30 p-4 rounded-lg">
                            <div class="text-sm text-gray-400">Best Bowling</div>
                            <div class="text-lg font-bold text-cyan-400">${player.bestBowling}</div>
                        </div>
                    ` : ''}
                    
                    ${player.fours !== undefined ? `
                        <div class="bg-gray-800/30 p-4 rounded-lg">
                            <div class="text-sm text-gray-400">4's</div>
                            <div class="text-lg font-bold text-green-400">${player.fours}</div>
                        </div>
                    ` : ''}
                    
                    ${player.sixes !== undefined ? `
                        <div class="bg-gray-800/30 p-4 rounded-lg">
                            <div class="text-sm text-gray-400">6's</div>
                            <div class="text-lg font-bold text-yellow-400">${player.sixes}</div>
                        </div>
                    ` : ''}
                    
                    ${player.fifties !== undefined ? `
                        <div class="bg-gray-800/30 p-4 rounded-lg">
                            <div class="text-sm text-gray-400">50's</div>
                            <div class="text-lg font-bold text-blue-400">${player.fifties}</div>
                        </div>
                    ` : ''}
                    
                    ${player.hundreds !== undefined ? `
                        <div class="bg-gray-800/30 p-4 rounded-lg">
                            <div class="text-sm text-gray-400">100's</div>
                            <div class="text-lg font-bold text-red-400">${player.hundreds}</div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="mt-6 pt-6 border-t border-gray-700">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm text-gray-400">Role</div>
                            <div class="font-medium">${player.role || 'N/A'}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Bowling Type</div>
                            <div class="font-medium">${player.bowlingType || 'N/A'}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Nationality</div>
                            <div class="font-medium">${player.nationality || 'Indian'}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Base Price</div>
                            <div class="font-medium text-yellow-400">‚Çπ${player.basePrice || '2.00'} Cr</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statsModal').classList.remove('hidden');
        }
        
        function closeStatsModal() {
            document.getElementById('statsModal').classList.add('hidden');
        }

        // ========== HELPER FUNCTIONS ==========
        function clearAllSelections() {
            if (autoSubmitted) return;
            
            selectedPlayers.clear();
            updateCounts();
            
            // Remove selected class from all cards
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            showAlert('Cleared', 'All selections have been cleared.', 'üîÑ');
        }
        
        function showAlert(title, message, icon = '‚ÑπÔ∏è') {
            const modal = document.getElementById('alertModal');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            
            modalIcon.textContent = icon;
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            modal.classList.remove('hidden');
        }
        
        function closeModal() {
            document.getElementById('alertModal').classList.add('hidden');
        }
        
        // Expose functions to global scope
        window.closeModal = closeModal;
        window.closeStatsModal = closeStatsModal;
        window.showPlayerStats = showPlayerStats;
        window.clearAllSelections = clearAllSelections;
        window.submitRetention = submitRetention;

        console.log('‚úÖ Retention page loaded with auto-submission');
    </script>
</body>
</html>