<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playing 11 Selection - IPL Auction</title>
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        
        .drag-area {
            min-height: 200px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .drag-area.drag-over {
            border-color: #F59E0B;
            background: rgba(245, 158, 11, 0.1);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.2);
        }
        
        .player-drag-item {
            cursor: move;
            transition: all 0.2s;
            user-select: none;
        }
        
        .player-drag-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            z-index: 1000;
        }
        
        .slot-item {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            transition: all 0.3s;
        }
        
        .slot-item.has-player {
            border-color: rgba(34, 197, 94, 0.5);
            background: rgba(34, 197, 94, 0.1);
        }
        
        .slot-item.drag-over {
            border-color: #F59E0B;
            background: rgba(245, 158, 11, 0.2);
        }
        
        .role-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .role-batsman { background: rgba(34, 197, 94, 0.2); color: #22C55E; }
        .role-bowler { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .role-allrounder { background: rgba(168, 85, 247, 0.2); color: #A855F7; }
        .role-wk { background: rgba(245, 158, 11, 0.2); color: #F59E0B; }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .team-name-gradient {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .player-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.7), rgba(15, 23, 42, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }
        
        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 6px;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #F59E0B, #D97706);
            border-radius: 3px;
        }
        
        /* Animated gradients */
        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        
        .shimmer-text {
            background: linear-gradient(90deg, #FFD700 0%, #FFA500 25%, #FFD700 50%, #FFA500 75%, #FFD700 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 3s linear infinite;
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="glass-panel rounded-2xl p-6 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-center md:text-left">
                    <h1 class="text-3xl md:text-4xl font-bold mb-2 shimmer-text">
                        üèè Playing 11 Selection
                    </h1>
                    <div id="teamHeader" class="flex items-center justify-center md:justify-start space-x-3">
                        <!-- Team info will be loaded here -->
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row items-center space-y-3 md:space-y-0 md:space-x-4">
                    <!-- Session Info -->
                    <div class="text-center md:text-right">
                        <div class="text-sm text-gray-400">Room: <span id="roomCodeDisplay" class="font-bold text-yellow-400"></span></div>
                        <div class="text-sm text-gray-400">User: <span id="usernameDisplay" class="font-bold text-cyan-400"></span></div>
                    </div>
                    
                    <!-- Validation Status -->
                    <div id="validationStatus" class="hidden">
                        <div class="flex items-center space-x-2 px-4 py-2 rounded-lg" id="statusBadge">
                            <div class="w-2 h-2 rounded-full"></div>
                            <span class="text-sm font-medium">Status</span>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <button id="submitPlaying11Btn" 
                            class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
                            disabled>
                        ‚úÖ Submit Playing 11
                    </button>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Available Squad -->
            <div class="space-y-6">
                <!-- Available Squad -->
                <div class="glass-panel rounded-2xl p-6">
                    <h2 class="text-xl font-bold text-green-400 mb-4 flex items-center justify-between">
                        <span>Your Squad</span>
                        <span id="squadCount" class="text-sm font-normal text-gray-400">0 players</span>
                    </h2>
                    <div id="availablePlayers" class="drag-area p-4 min-h-[300px] max-h-[400px] overflow-y-auto">
                        <!-- Players will be loaded here -->
                        <div class="text-center text-gray-500 py-12">
                            <div class="text-4xl mb-4 animate-pulse">‚è≥</div>
                            <p>Loading your squad...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Squad Statistics -->
                <div class="glass-panel rounded-2xl p-6">
                    <h2 class="text-xl font-bold text-blue-400 mb-4">Squad Statistics</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-3 player-card rounded-lg">
                            <div class="text-2xl font-bold text-green-400" id="totalPlayers">0</div>
                            <div class="text-xs text-gray-400">Total Players</div>
                        </div>
                        <div class="text-center p-3 player-card rounded-lg">
                            <div class="text-2xl font-bold text-yellow-400" id="totalSpent">‚Çπ0</div>
                            <div class="text-xs text-gray-400">Total Spent</div>
                        </div>
                        <div class="text-center p-3 player-card rounded-lg">
                            <div class="text-2xl font-bold text-purple-400" id="rtmCards">2</div>
                            <div class="text-xs text-gray-400">RTM Cards Left</div>
                        </div>
                        <div class="text-center p-3 player-card rounded-lg">
                            <div class="text-2xl font-bold text-cyan-400" id="remainingBudget">‚Çπ100</div>
                            <div class="text-xs text-gray-400">Purse Left</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Playing 11 & Impact Players -->
            <div class="space-y-8">
                <!-- Playing 11 Selection -->
                <div class="glass-panel rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-yellow-400">Playing 11</h2>
                        <span id="playing11Count" class="text-sm font-normal text-gray-400">0/11 selected</span>
                    </div>
                    <div id="playing11Slots" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 p-4">
                        <!-- 11 slots will be created dynamically -->
                    </div>
                    
                    <!-- Validation Messages -->
                    <div id="playing11Validation" class="mt-4 text-sm space-y-1 hidden">
                        <!-- Validation messages will appear here -->
                    </div>
                </div>
                
                <!-- Impact Players Selection -->
                <div id="impactPlayersSection" class="glass-panel rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-purple-400">Impact Players</h2>
                        <span id="impactPlayersCount" class="text-sm font-normal text-gray-400">0 selected</span>
                    </div>
                    <div id="impactPlayerSlots" class="grid grid-cols-2 md:grid-cols-3 gap-3 p-4">
                        <!-- Impact player slots will be created dynamically -->
                    </div>
                    
                    <div class="text-xs text-gray-500 mt-3">
                        <div class="flex items-center space-x-2">
                            <span>üìå</span>
                            <span>Impact players cannot be in both Playing 11 and Impact Players list</span>
                        </div>
                    </div>
                </div>
                
                <!-- Captain Selection -->
                <div class="glass-panel rounded-2xl p-6" id="captainSection">
                    <h2 class="text-xl font-bold text-green-400 mb-4">Captain Selection</h2>
                    <div id="captainSelection" class="text-center p-4 bg-gray-800/30 rounded-lg">
                        <p class="text-gray-400 mb-3">Select your captain from Playing 11:</p>
                        <div id="captainCandidates" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                            <!-- Captain candidates will appear here -->
                        </div>
                        <div class="mt-4">
                            <div id="selectedCaptainDisplay" class="hidden">
                                <div class="flex items-center justify-center space-x-3">
                                    <span class="text-green-400">‚úÖ</span>
                                    <span class="text-yellow-400 font-bold" id="captainName">Captain Name</span>
                                    <span class="text-green-400">(Captain)</span>
                                </div>
                            </div>
                            <div id="noCaptainWarning" class="text-red-400 text-sm mt-2 hidden">
                                ‚ö†Ô∏è Please select a captain
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Role Distribution -->
                <div class="glass-panel rounded-2xl p-6">
                    <h2 class="text-xl font-bold text-cyan-400 mb-4">Role Distribution</h2>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300 flex items-center space-x-2">
                                <span>üèè</span>
                                <span>Batsmen</span>
                            </span>
                            <span id="batsmenCount" class="font-bold text-green-400">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300 flex items-center space-x-2">
                                <span>üéØ</span>
                                <span>Bowlers</span>
                            </span>
                            <span id="bowlersCount" class="font-bold text-red-400">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300 flex items-center space-x-2">
                                <span>‚ö°</span>
                                <span>All-Rounders</span>
                            </span>
                            <span id="allroundersCount" class="font-bold text-purple-400">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300 flex items-center space-x-2">
                                <span>üß§</span>
                                <span>Wicket Keepers</span>
                            </span>
                            <span id="keepersCount" class="font-bold text-yellow-400">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="mt-8 glass-panel rounded-2xl p-6">
            <h3 class="text-lg font-bold text-gray-300 mb-3 flex items-center space-x-2">
                <span>üìã</span>
                <span>Instructions</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="flex items-start space-x-3 p-3 player-card rounded-lg">
                    <div class="text-2xl text-yellow-400">üë•</div>
                    <div>
                        <h4 class="font-semibold text-yellow-400">Select Playing 11</h4>
                        <p class="text-sm text-gray-400">Drag exactly 11 players from your squad to the Playing 11 area</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3 p-3 player-card rounded-lg">
                    <div class="text-2xl text-purple-400">‚≠ê</div>
                    <div>
                        <h4 class="font-semibold text-purple-400">Choose Impact Players</h4>
                        <p class="text-sm text-gray-400">Select impact players from remaining squad (cannot be in Playing 11)</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3 p-3 player-card rounded-lg">
                    <div class="text-2xl text-green-400">‚úÖ</div>
                    <div>
                        <h4 class="font-semibold text-green-400">Submit Team</h4>
                        <p class="text-sm text-gray-400">Submit your final team for auctioneer review and rating</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
        <div class="glass-panel rounded-2xl p-8 max-w-md w-11/12 z-10 text-center transform transition-all duration-300 scale-95 animate-fadeIn">
            <div class="text-6xl mb-4 animate-bounce">üéâ</div>
            <h3 class="text-2xl font-bold text-green-400 mb-2">Team Submitted Successfully!</h3>
            <p class="text-gray-300 mb-6">Your playing 11 has been submitted to the auctioneer for review.</p>
            <p class="text-yellow-400 text-sm mb-6">Wait for auctioneer to rate your team</p>
            <button onclick="closeSuccessModal()" 
                    class="px-6 py-3 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-xl font-semibold hover:scale-105 transition-all duration-300 shadow-lg">
                OK
            </button>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
        <div class="glass-panel rounded-2xl p-6 max-w-md w-11/12 z-10 transform transition-all duration-300 scale-95 animate-fadeIn">
            <div class="text-center">
                <div class="text-4xl mb-4 animate-pulse" id="modalIcon">‚ö†Ô∏è</div>
                <h3 class="text-2xl font-bold mb-2" id="modalTitle">Alert</h3>
                <p class="text-gray-300 mb-6" id="modalMessage">This is a modal message</p>
                <button onclick="closeAlertModal()" 
                        class="px-6 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg font-semibold hover:scale-105 transition-all duration-300">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Animation styles -->
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        
        .highlight {
            animation: highlight 0.5s ease-out;
        }
        
        @keyframes highlight {
            0% { background-color: rgba(245, 158, 11, 0); }
            50% { background-color: rgba(245, 158, 11, 0.3); }
            100% { background-color: rgba(245, 158, 11, 0); }
        }
    </style>

    <script>
        // ‚úÖ FIX 5: Add Data Loading on Page Load - PASTE THIS AT THE BEGINNING
        document.addEventListener('DOMContentLoaded', function() {
    console.log('üèè Playing 11 page loading...');
    
    // Check if we have squad data from auction
    const squadData = JSON.parse(localStorage.getItem('playing11SquadData') || '{}');
    const auctionCompleted = localStorage.getItem('auctionCompleted') === 'true';
    
    // Check if we have REAL data (not dummy data)
    const hasRealAuctionData = squadData.auctionPlayers && 
                              squadData.auctionPlayers.length > 0 && 
                              squadData.auctionPlayers[0].name !== 'Player 1';
    
    if (!auctionCompleted || !squadData.roomCode || !hasRealAuctionData) {
        console.error('‚ùå No valid squad data found:', {
            auctionCompleted,
            hasRoomCode: !!squadData.roomCode,
            auctionPlayers: squadData.auctionPlayers?.length || 0,
            hasRealData: hasRealAuctionData
        });
        
        showAlert('Data Loading', 'Loading your squad data from server...', '‚è≥');
        
        // Try to load from localStorage backup
        const backupData = loadBackupSquadData();
        if (backupData) {
            console.log('‚úÖ Loaded backup squad data');
            initializePlaying11Page(backupData);
        } else {
            // Show error and try to reconnect
            setTimeout(() => {
                showAlert('Data Error', 
                    'Could not load your squad data. Please wait or contact auctioneer.', 
                    '‚ùå');
                
                // Add retry button
                const waitingDiv = document.createElement('div');
                waitingDiv.className = 'text-center mt-4';
                waitingDiv.innerHTML = `
                    <button onclick="retryLoadSquadData()" 
                            class="px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-lg font-semibold">
                        üîÑ Retry Loading Squad Data
                    </button>
                `;
                document.getElementById('availablePlayers')?.appendChild(waitingDiv);
            }, 2000);
        }
        
        return;
    }
    
    console.log('‚úÖ Valid squad data loaded:', {
        retained: squadData.retainedPlayers?.length || 0,
        auction: squadData.auctionPlayers?.length || 0,
        total: (squadData.retainedPlayers?.length || 0) + (squadData.auctionPlayers?.length || 0)
    });
    
    // Initialize page with squad data
    initializePlaying11Page(squadData);
});

// Helper function to load backup squad data
function loadBackupSquadData() {
    try {
        // Try to get from user session
        const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
        if (userSession.squadData) {
            return userSession.squadData;
        }
        
        // Try to get from auction buys
        const auctionBuys = JSON.parse(localStorage.getItem('auctionBuys') || '[]');
        const retainedPlayers = JSON.parse(localStorage.getItem('retainedPlayers') || '[]');
        
        if (auctionBuys.length > 0 || retainedPlayers.length > 0) {
            return {
                roomCode: userSession.roomCode,
                username: userSession.username,
                team: userSession.team,
                retainedPlayers: retainedPlayers,
                auctionPlayers: auctionBuys,
                budget: 100,
                timestamp: Date.now()
            };
        }
        
        return null;
    } catch (error) {
        console.error('Error loading backup data:', error);
        return null;
    }
}

// Retry function
function retryLoadSquadData() {
    console.log('üîÑ Retrying to load squad data...');
    location.reload();
}

// Expose to window
window.retryLoadSquadData = retryLoadSquadData;

        function initializePlaying11Page(squadData) {
            console.log('üèÜ Total squad players:', 
                (squadData.retainedPlayers?.length || 0) + 
                (squadData.auctionPlayers?.length || 0)
            );
            
            // Set global variables
            window.squadData = squadData;
            window.currentRoomCode = squadData.roomCode;
            window.currentUsername = squadData.username;
            window.userTeam = squadData.team;
            window.userSessionId = squadData.sessionId;
            
            // Display team info
            if (squadData.team) {
                displayTeamInfo(squadData.team);
                roomCodeDisplay.textContent = squadData.roomCode;
                usernameDisplay.textContent = squadData.username;
            }
            
            // Process squad data
            processSquadData(squadData);
            
            // Initialize UI components
            initializeDragAndDrop();
            createPlaying11Slots();
            createImpactPlayerSlots();
            
            // Update statistics
            updateStatistics(squadData);
            
            // Initialize socket connection
            initializeSocket();
            
            console.log('‚úÖ Playing 11 page initialized successfully');
        }

        // ========== GLOBAL VARIABLES ==========
        let socket = null;
        let currentUsername = null;
        let currentRoomCode = null;
        let userTeam = null;
        let squadData = null;
        let allPlayers = [];
        let playing11 = [];
        let impactPlayers = [];
        let draggedPlayer = null;
        let maxImpactPlayers = 1;
        let userSessionId = null;
        window.selectedCaptain = null;

        // ========== DOM ELEMENTS ==========
        const teamHeader = document.getElementById('teamHeader');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const validationStatus = document.getElementById('validationStatus');
        const statusBadge = document.getElementById('statusBadge');
        const submitPlaying11Btn = document.getElementById('submitPlaying11Btn');
        const availablePlayers = document.getElementById('availablePlayers');
        const squadCount = document.getElementById('squadCount');
        const playing11Slots = document.getElementById('playing11Slots');
        const playing11Count = document.getElementById('playing11Count');
        const playing11Validation = document.getElementById('playing11Validation');
        const impactPlayersSection = document.getElementById('impactPlayersSection');
        const impactPlayerSlots = document.getElementById('impactPlayerSlots');
        const impactPlayersCount = document.getElementById('impactPlayersCount');
        const totalPlayers = document.getElementById('totalPlayers');
        const totalSpent = document.getElementById('totalSpent');
        const rtmCards = document.getElementById('rtmCards');
        const remainingBudget = document.getElementById('remainingBudget');
        const batsmenCount = document.getElementById('batsmenCount');
        const bowlersCount = document.getElementById('bowlersCount');
        const allroundersCount = document.getElementById('allroundersCount');
        const keepersCount = document.getElementById('keepersCount');

        // ========== SQUAD DATA PROCESSING ==========
        function processSquadData(data) {
            console.log('üîÑ Processing squad data:', {
                retained: data.retainedPlayers?.length || 0,
                auction: data.auctionPlayers?.length || 0
            });
            
            allPlayers = [];
            
            // Combine retained and auction players
            if (data.retainedPlayers && data.retainedPlayers.length > 0) {
                data.retainedPlayers.forEach(player => {
                    allPlayers.push({
                        id: player.id || player.name?.replace(/\s+/g, '_'),
                        name: player.name,
                        role: player.role,
                        isOverseas: player.isOverseas,
                        nationality: player.nationality,
                        price: 0, // Retained players don't cost auction money
                        source: 'retained',
                        stats: player.stats || {}
                    });
                });
            }
            
            if (data.auctionPlayers && data.auctionPlayers.length > 0) {
                data.auctionPlayers.forEach(player => {
                    allPlayers.push({
                        id: player.id || player.name?.replace(/\s+/g, '_'),
                        name: player.name,
                        role: player.role,
                        isOverseas: player.isOverseas,
                        nationality: player.nationality,
                        price: player.price || 0,
                        source: 'auction',
                        stats: player.stats || {}
                    });
                });
            }
            
            console.log(`üìä Total players in squad: ${allPlayers.length}`);
            
            // Update squad count
            squadCount.textContent = `${allPlayers.length} players`;
            
            // Display available players
            displayAvailablePlayers();
            
            // Highlight if this is initial load
            if (allPlayers.length > 0) {
                highlightAvailablePlayers();
                showAlert('Squad Ready', `Loaded ${allPlayers.length} players from your squad`, '‚úÖ');
            }
        }
        
        function displayAvailablePlayers() {
            availablePlayers.innerHTML = '';
            
            if (allPlayers.length === 0) {
                availablePlayers.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <div class="text-4xl mb-4">üòï</div>
                        <p>No players in your squad</p>
                        <button onclick="requestSquadFromServer()" 
                                class="mt-4 px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-lg font-semibold">
                            üîÑ Load Squad
                        </button>
                    </div>
                `;
                return;
            }
            
            allPlayers.forEach(player => {
                const playerEl = createPlayerElement(player);
                availablePlayers.appendChild(playerEl);
            });
        }
        
        function createPlayerElement(player) {
    const playerEl = document.createElement('div');
    playerEl.className = 'player-drag-item player-card rounded-xl p-3 mb-3 hover:scale-[1.02] transition-transform duration-200';
    playerEl.setAttribute('data-player-id', player.id);
    playerEl.setAttribute('draggable', 'true');
    
    // Determine role class and icon
    let roleClass = 'role-batsman';
    let roleDisplay = player.role || 'Player';
    let roleIcon = 'üèè';
    
    if (player.role) {
        const roleLower = player.role.toLowerCase();
        if (roleLower.includes('bowl') || roleLower.includes('pace') || roleLower.includes('spin')) {
            roleClass = 'role-bowler';
            roleIcon = 'üéØ';
        } else if (roleLower.includes('all') || roleLower.includes('ar')) {
            roleClass = 'role-allrounder';
            roleIcon = '‚ö°';
        } else if (roleLower.includes('wk') || roleLower.includes('keep')) {
            roleClass = 'role-wk';
            roleIcon = 'üß§';
        }
    }
    
    // ‚úÖ FIX: Show correct overseas status
    const isOverseas = player.isOverseas === true || 
                      (player.nationality && player.nationality.toString().toLowerCase() !== 'IND');
    
    playerEl.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center shadow-lg">
                    <span class="text-lg">${roleIcon}</span>
                </div>
                <div class="min-w-0 flex-1">
                    <div class="font-medium truncate">${player.name}</div>
                    <div class="flex items-center space-x-2 mt-1">
                        <span class="${roleClass} role-badge">${roleDisplay}</span>
                        ${isOverseas ? 
                            '<span class="text-xs px-2 py-1 bg-gradient-to-r from-purple-900/30 to-pink-900/30 text-purple-300 rounded">‚úàÔ∏è Overseas</span>' : 
                            '<span class="text-xs px-2 py-1 bg-gradient-to-r from-green-900/30 to-emerald-900/30 text-green-300 rounded">üáÆüá≥ Indian</span>'}
                    </div>
                    ${player.nationality ? `<div class="text-xs text-gray-500 mt-1">${player.nationality}</div>` : ''}
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-400">${player.source === 'retained' ? 'Retained' : 'Bought'}</div>
                <div class="font-bold text-yellow-400">${player.source === 'retained' ? 'Free' : `‚Çπ${player.price} Cr`}</div>
            </div>
        </div>
    `;
    
    // Add drag event listeners
    playerEl.addEventListener('dragstart', handleDragStart);
    playerEl.addEventListener('dragend', handleDragEnd);
    
    return playerEl;
}
        
        function requestSquadFromServer() {
            if (socket && socket.connected) {
                socket.emit('requestSquad', {
                    roomCode: currentRoomCode,
                    username: currentUsername,
                    sessionId: userSessionId
                });
                showAlert('Request Sent', 'Requesting squad data from server...', '‚è≥');
            }
        }

        // ========== SLOT CREATION ==========
        function createPlaying11Slots() {
            playing11Slots.innerHTML = '';
            playing11 = new Array(11).fill(null);
            
            for (let i = 1; i <= 11; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot-item hover:border-yellow-400/50 transition-all duration-200';
                slot.setAttribute('data-slot-type', 'playing11');
                slot.setAttribute('data-slot-index', i - 1);
                slot.setAttribute('data-slot-number', i); // Add slot number
                slot.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl mb-1 text-yellow-400/50">${i}</div>
                        <div class="text-xs text-gray-500">Slot ${i}</div>
                    </div>
                `;
                
                // Add drag event listeners
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('dragenter', handleDragEnter);
                slot.addEventListener('dragleave', handleDragLeave);
                slot.addEventListener('drop', handleDrop);
                
                playing11Slots.appendChild(slot);
            }
        }
        
        function createImpactPlayerSlots() {
            impactPlayerSlots.innerHTML = '';
            impactPlayers = new Array(maxImpactPlayers).fill(null);
            
            // Create slots based on max impact players (default 1, can be up to 3)
            for (let i = 1; i <= maxImpactPlayers; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot-item hover:border-purple-400/50 transition-all duration-200';
                slot.setAttribute('data-slot-type', 'impact');
                slot.setAttribute('data-slot-index', i - 1);
                slot.innerHTML = `
                    <div class="text-center">
                        <div class="text-xl mb-1 text-purple-400/50">‚≠ê</div>
                        <div class="text-xs text-gray-500">Impact ${i}</div>
                    </div>
                `;
                
                // Add drag event listeners
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('dragenter', handleDragEnter);
                slot.addEventListener('dragleave', handleDragLeave);
                slot.addEventListener('drop', handleDrop);
                
                impactPlayerSlots.appendChild(slot);
            }
            
            updateImpactPlayerSlots();
        }
        
        function updateImpactPlayerSlots() {
            impactPlayersCount.textContent = `${impactPlayers.filter(p => p !== null).length}/${maxImpactPlayers} selected`;
        }

        // ========== DRAG AND DROP FUNCTIONS ==========
        function initializeDragAndDrop() {
            // Add drag events to available players area
            availablePlayers.addEventListener('dragover', handleDragOver);
            availablePlayers.addEventListener('dragenter', (e) => {
                e.preventDefault();
                availablePlayers.classList.add('drag-over');
            });
            availablePlayers.addEventListener('dragleave', (e) => {
                if (!availablePlayers.contains(e.relatedTarget)) {
                    availablePlayers.classList.remove('drag-over');
                }
            });
            availablePlayers.addEventListener('drop', (e) => {
                e.preventDefault();
                availablePlayers.classList.remove('drag-over');
                
                if (draggedPlayer) {
                    const playerId = draggedPlayer.getAttribute('data-player-id');
                    removePlayerFromAllSlots(playerId);
                    updateAllCounts();
                }
            });
        }
        
        function handleDragStart(e) {
            draggedPlayer = e.target.closest('.player-drag-item');
            if (!draggedPlayer) return;
            
            e.dataTransfer.setData('text/plain', draggedPlayer.getAttribute('data-player-id'));
            draggedPlayer.classList.add('dragging');
            
            // Add clone for drag image
            setTimeout(() => {
                draggedPlayer.classList.add('opacity-0');
            }, 0);
        }
        
        function handleDragEnd(e) {
            if (draggedPlayer) {
                draggedPlayer.classList.remove('dragging', 'opacity-0');
                draggedPlayer = null;
            }
            
            // Remove drag-over class from all slots
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            availablePlayers.classList.remove('drag-over');
        }
        
        function handleDragOver(e) {
            e.preventDefault();
        }
        
        function handleDragEnter(e) {
            e.preventDefault();
            e.target.closest('.slot-item')?.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            if (!e.target.contains(e.relatedTarget)) {
                e.target.classList.remove('drag-over');
            }
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            const playerId = e.dataTransfer.getData('text/plain');
            const slot = e.target.closest('.slot-item');
            
            if (!playerId || !slot) return;
            
            const slotType = slot.getAttribute('data-slot-type');
            const slotIndex = parseInt(slot.getAttribute('data-slot-index'));
            
            const playerData = getPlayerById(playerId);
            if (!playerData) return;
            
            // Check if player is already in playing11 or impact players
            if (isPlayerInPlaying11(playerId) && slotType !== 'playing11') {
                showAlert('Duplicate Player', 'This player is already in Playing 11. Cannot add to Impact Players.', '‚ùå');
                return;
            }
            
            if (isPlayerInImpactPlayers(playerId) && slotType !== 'impact') {
                showAlert('Duplicate Player', 'This player is already in Impact Players. Cannot add to Playing 11.', '‚ùå');
                return;
            }
            
            // Add to appropriate slot
            if (slotType === 'playing11') {
                addToPlaying11(playerData, slotIndex);
            } else if (slotType === 'impact') {
                addToImpactPlayers(playerData, slotIndex);
            }
            
            // Remove from available players
            removeFromAvailablePlayers(playerId);
            
            updateAllCounts();
        }
        
        // ========== PLAYER MANAGEMENT FUNCTIONS ==========
        function getPlayerById(playerId) {
            return allPlayers.find(player => player.id === playerId);
        }
        
        function isPlayerInPlaying11(playerId) {
            return playing11.some(player => player && player.id === playerId);
        }
        
        function isPlayerInImpactPlayers(playerId) {
            return impactPlayers.some(player => player && player.id === playerId);
        }
        
        function addToPlaying11(playerData, slotIndex) {
            // If slot already has a player, remove it first
            if (playing11[slotIndex]) {
                const oldPlayerId = playing11[slotIndex].id;
                returnToAvailablePlayers(oldPlayerId);
            }
            
            // Add to playing11 array with slot position
            playing11[slotIndex] = {
                ...playerData,
                slotPosition: slotIndex + 1 // Store the exact position (1-11)
            };
            
            // Update slot display
            updateSlotDisplay('playing11', slotIndex, playerData);
            
            // Highlight the slot
            highlightSlot('playing11', slotIndex);
            
            // Update captain selection if needed
            updateCaptainSelection();
        }
        
        function addToImpactPlayers(playerData, slotIndex) {
            // Check if player is already in playing11
            if (isPlayerInPlaying11(playerData.id)) {
                showAlert('Duplicate Player', 'This player is already in Playing 11. Cannot add to Impact Players.', '‚ùå');
                return;
            }
            
            // Check impact player limit
            if (impactPlayers.filter(p => p !== null).length >= maxImpactPlayers && !impactPlayers[slotIndex]) {
                showAlert('Limit Reached', `Maximum ${maxImpactPlayers} impact players allowed`, '‚ùå');
                return;
            }
            
            // If slot already has a player, remove it first
            if (impactPlayers[slotIndex]) {
                const oldPlayerId = impactPlayers[slotIndex].id;
                returnToAvailablePlayers(oldPlayerId);
            }
            
            // Add to impactPlayers array
            impactPlayers[slotIndex] = playerData;
            
            // Update slot display
            updateSlotDisplay('impact', slotIndex, playerData);
            
            // Highlight the slot
            highlightSlot('impact', slotIndex);
        }
        
        function removePlayerFromAllSlots(playerId) {
            // Remove from playing11
            const playing11Index = playing11.findIndex(player => player && player.id === playerId);
            if (playing11Index !== -1) {
                playing11[playing11Index] = null;
                clearSlotDisplay('playing11', playing11Index);
            }
            
            // Remove from impact players
            const impactIndex = impactPlayers.findIndex(player => player && player.id === playerId);
            if (impactIndex !== -1) {
                impactPlayers[impactIndex] = null;
                clearSlotDisplay('impact', impactIndex);
            }
            
            // Return to available players
            returnToAvailablePlayers(playerId);
            
            // Update captain selection if needed
            updateCaptainSelection();
        }
        
        function returnToAvailablePlayers(playerId) {
            const playerData = getPlayerById(playerId);
            if (playerData) {
                const playerEl = createPlayerElement(playerData);
                availablePlayers.appendChild(playerEl);
                highlightPlayer(playerEl);
            }
        }
        
        function removeFromAvailablePlayers(playerId) {
            const playerEl = availablePlayers.querySelector(`[data-player-id="${playerId}"]`);
            if (playerEl) {
                playerEl.remove();
            }
        }
        
        function updateSlotDisplay(slotType, slotIndex, playerData) {
            const slots = slotType === 'playing11' ? playing11Slots : impactPlayerSlots;
            const slot = slots.children[slotIndex];
            
            // Determine role class and icon
            let roleClass = 'role-batsman';
            let roleIcon = 'üèè';
            
            if (playerData.role) {
                const roleLower = playerData.role.toLowerCase();
                if (roleLower.includes('bowl') || roleLower.includes('pace') || roleLower.includes('spin')) {
                    roleClass = 'role-bowler';
                    roleIcon = 'üéØ';
                } else if (roleLower.includes('all') || roleLower.includes('ar')) {
                    roleClass = 'role-allrounder';
                    roleIcon = '‚ö°';
                } else if (roleLower.includes('wk') || roleLower.includes('keep')) {
                    roleClass = 'role-wk';
                    roleIcon = 'üß§';
                }
            }
            
            slot.innerHTML = `
                <div class="text-center w-full p-2">
                    <div class="font-medium text-sm truncate mb-1">${playerData.name}</div>
                    <div class="flex items-center justify-center space-x-2 mb-2">
                        <span class="text-xs">${roleIcon}</span>
                        <span class="${roleClass} role-badge text-xs">${playerData.role || 'Player'}</span>
                    </div>
                    ${playerData.isOverseas ? '<div class="text-xs text-purple-300 mt-1">‚úàÔ∏è Overseas</div>' : ''}
                    <div class="text-xs text-gray-400 mt-2">${slotType === 'playing11' ? `Slot ${slotIndex + 1}` : 'Impact'}</div>
                </div>
            `;
            slot.classList.add('has-player');
        }

        function updateCaptainSelection() {
            const captainCandidates = document.getElementById('captainCandidates');
            const selectedCaptainDisplay = document.getElementById('selectedCaptainDisplay');
            const captainName = document.getElementById('captainName');
            
            if (!captainCandidates) return;
            
            captainCandidates.innerHTML = '';
            
            // Get all players in playing11
            const playing11Players = playing11.filter(p => p !== null);
            
            if (playing11Players.length === 0) {
                captainCandidates.innerHTML = '<p class="text-gray-500 text-center col-span-full py-4">Add players to Playing 11 first</p>';
                selectedCaptainDisplay.classList.add('hidden');
                return;
            }
            
            // Create captain selection cards
            playing11Players.forEach((player, index) => {
                const isCurrentCaptain = window.selectedCaptain?.id === player.id;
                const captainCard = document.createElement('div');
                captainCard.className = `text-center p-3 rounded-lg cursor-pointer transition-all ${
                    isCurrentCaptain ? 'bg-green-900/30 border-2 border-green-500' : 'bg-gray-800/30 hover:bg-gray-800/50'
                }`;
                captainCard.innerHTML = `
                    <div class="text-2xl mb-2">${getPlayerEmoji(player.role)}</div>
                    <div class="font-medium text-sm truncate">${player.name.split(' ')[0]}</div>
                    <div class="text-xs text-gray-400">${player.role?.substring(0, 3) || 'Play'}</div>
                    <div class="text-xs text-yellow-400">Slot ${player.slotPosition || '?'}</div>
                    ${isCurrentCaptain ? '<div class="text-green-400 text-xs mt-1 font-bold">CAPTAIN</div>' : ''}
                `;
                
                captainCard.addEventListener('click', () => selectCaptain(player));
                captainCandidates.appendChild(captainCard);
            });
            
            // Update selected captain display
            if (window.selectedCaptain) {
                captainName.textContent = window.selectedCaptain.name;
                selectedCaptainDisplay.classList.remove('hidden');
            } else {
                selectedCaptainDisplay.classList.add('hidden');
            }
        }

        function selectCaptain(player) {
            window.selectedCaptain = player;
            updateCaptainSelection();
            validateSelection();
            showAlert('Captain Selected', `${player.name} is now your team captain!`, '‚≠ê');
        }

        function getPlayerEmoji(role) {
            if (!role) return 'üèè';
            const roleLower = role.toLowerCase();
            if (roleLower.includes('wk') || roleLower.includes('keep')) return 'üß§';
            if (roleLower.includes('bowl')) return 'üéØ';
            if (roleLower.includes('all')) return '‚ö°';
            return 'üèè';
        }
        
        function clearSlotDisplay(slotType, slotIndex) {
            const slots = slotType === 'playing11' ? playing11Slots : impactPlayerSlots;
            const slot = slots.children[slotIndex];
            
            slot.innerHTML = `
                <div class="text-center">
                    <div class="text-2xl mb-1 ${slotType === 'playing11' ? 'text-yellow-400/50' : 'text-purple-400/50'}">${slotType === 'playing11' ? slotIndex + 1 : '‚≠ê'}</div>
                    <div class="text-xs text-gray-500">${slotType === 'playing11' ? `Slot ${slotIndex + 1}` : 'Impact'}</div>
                </div>
            `;
            slot.classList.remove('has-player');
        }
        
        function highlightSlot(slotType, slotIndex) {
            const slots = slotType === 'playing11' ? playing11Slots : impactPlayerSlots;
            const slot = slots.children[slotIndex];
            slot.classList.add('highlight');
            setTimeout(() => {
                slot.classList.remove('highlight');
            }, 500);
        }
        
        function highlightPlayer(playerEl) {
            playerEl.classList.add('highlight');
            setTimeout(() => {
                playerEl.classList.remove('highlight');
            }, 500);
        }
        
        function highlightAvailablePlayers() {
            const players = availablePlayers.querySelectorAll('.player-drag-item');
            players.forEach((player, index) => {
                setTimeout(() => {
                    player.classList.add('highlight');
                    setTimeout(() => {
                        player.classList.remove('highlight');
                    }, 300);
                }, index * 100);
            });
        }

        // ========== VALIDATION & UPDATES ==========
        function updateAllCounts() {
            // Update counts
            const playing11CountValue = playing11.filter(player => player !== null).length;
            const impactPlayersCountValue = impactPlayers.filter(player => player !== null).length;
            
            playing11Count.textContent = `${playing11CountValue}/11 selected`;
            updateImpactPlayerSlots();
            
            // Update role distribution
            updateRoleDistribution();

            // Update captain selection
            updateCaptainSelection();
            
            // Validate and update submit button
            validateSelection();
        }
        
        function updateRoleDistribution() {
            let batsmen = 0;
            let bowlers = 0;
            let allrounders = 0;
            let keepers = 0;
            
            // Count roles in playing11
            playing11.forEach(player => {
                if (player) {
                    const role = player.role?.toLowerCase() || '';
                    if (role.includes('bat')) batsmen++;
                    else if (role.includes('bowl') || role.includes('pace') || role.includes('spin')) bowlers++;
                    else if (role.includes('all') || role.includes('ar')) allrounders++;
                    else if (role.includes('wk') || role.includes('keep')) keepers++;
                    else batsmen++; // Default to batsman
                }
            });
            
            batsmenCount.textContent = batsmen;
            bowlersCount.textContent = bowlers;
            allroundersCount.textContent = allrounders;
            keepersCount.textContent = keepers;
        }
        
        function validateSelection() {
            const playing11CountValue = playing11.filter(player => player !== null).length;
            const impactPlayersCountValue = impactPlayers.filter(player => player !== null).length;
            
            // Get selected captain
            const hasCaptain = window.selectedCaptain !== undefined && window.selectedCaptain !== null;
            
            // Check overseas count (max 4)
            const overseasCount = playing11.filter(player => 
                player && player.isOverseas
            ).length;
            
            // Check wicket keeper count (min 1)
            const wkCount = playing11.filter(player => 
                player && player.role && (player.role.toLowerCase().includes('wk') || player.role.toLowerCase().includes('keep'))
            ).length;
            
            let isValid = true;
            let messages = [];
            
            // Check playing11 count
            if (playing11CountValue !== 11) {
                isValid = false;
                messages.push(`Need exactly 11 players in Playing 11 (currently ${playing11CountValue})`);
            }
            
            // Check overseas limit (max 4)
            if (overseasCount > 4) {
                isValid = false;
                messages.push(`Maximum 4 overseas players allowed in Playing 11 (currently ${overseasCount})`);
            }
            
            // Check wicket keeper (min 1)
            if (wkCount < 1) {
                isValid = false;
                messages.push(`At least 1 wicket keeper required in Playing 11 (currently ${wkCount})`);
            }
            
            // Check captain selection
            if (!hasCaptain) {
                isValid = false;
                messages.push(`Please select a captain from your Playing 11`);
            }
            
            // Check for duplicate players
            const playing11Ids = playing11.filter(p => p).map(p => p.id);
            const impactIds = impactPlayers.filter(p => p).map(p => p.id);
            const duplicates = playing11Ids.filter(id => impactIds.includes(id));
            
            if (duplicates.length > 0) {
                isValid = false;
                messages.push('Players cannot be in both Playing 11 and Impact Players');
            }
            
            // Check impact players limit
            if (impactPlayersCountValue > maxImpactPlayers) {
                isValid = false;
                messages.push(`Maximum ${maxImpactPlayers} impact players allowed`);
            }
            
            // Update validation UI
            if (isValid) {
                validationStatus.classList.remove('hidden');
                statusBadge.className = 'flex items-center space-x-2 px-4 py-2 rounded-lg bg-green-900/30';
                statusBadge.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-sm font-medium text-green-400">Ready to Submit</span>
                `;
                submitPlaying11Btn.disabled = false;
                playing11Validation.classList.add('hidden');
                
                // Hide captain warning
                document.getElementById('noCaptainWarning')?.classList.add('hidden');
            } else {
                validationStatus.classList.remove('hidden');
                statusBadge.className = 'flex items-center space-x-2 px-4 py-2 rounded-lg bg-red-900/30';
                statusBadge.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    <span class="text-sm font-medium text-red-400">Needs Fixes</span>
                `;
                submitPlaying11Btn.disabled = true;
                
                // Show captain warning if no captain
                if (!hasCaptain) {
                    document.getElementById('noCaptainWarning')?.classList.remove('hidden');
                } else {
                    document.getElementById('noCaptainWarning')?.classList.add('hidden');
                }
                
                // Show validation messages
                playing11Validation.classList.remove('hidden');
                playing11Validation.innerHTML = messages.map(msg => 
                    `<div class="text-red-400 text-sm flex items-center space-x-2">
                        <span>‚ùå</span>
                        <span>${msg}</span>
                    </div>`
                ).join('');
            }
            
            return isValid;
        }

        // ========== SUBMISSION FUNCTIONS ==========
        submitPlaying11Btn.addEventListener('click', () => {
            if (!validateSelection()) {
                showAlert('Validation Error', 'Please fix all validation errors before submitting.', '‚ùå');
                return;
            }
            
            // Prepare submission data WITH POSITIONS
            const playing11Final = playing11
                .filter(player => player !== null)
                .map((player, index) => ({
                    ...player,
                    slotPosition: index + 1, // Exact position (1-11)
                    isCaptain: window.selectedCaptain?.id === player.id
                }));
            
            const impactPlayersFinal = impactPlayers
                .filter(player => player !== null)
                .map((player, index) => ({
                    ...player,
                    impactSlot: index + 1 // Impact player position
                }));
            
            // Check if we have a captain
            if (!window.selectedCaptain) {
                showAlert('Captain Required', 'Please select a captain from your Playing 11.', '‚ùå');
                return;
            }
            
            // Show confirmation
            const confirmationMessage = `
                Confirm submission of your Playing 11?
                
                Playing 11: ${playing11Final.length} players (with positions)
                Impact Players: ${impactPlayersFinal.length} player(s)
                Captain: ${window.selectedCaptain.name}
                
                This action cannot be undone.
            `;
            
            if (confirm(confirmationMessage.replace(/\n\s*/g, '\n'))) {
                submitPlaying11WithPositions(playing11Final, impactPlayersFinal);
            }
        });

        function submitPlaying11WithPositions(playing11Data, impactPlayersData) {
            // Prepare complete submission data with positions
            const submissionData = {
                roomCode: currentRoomCode,
                username: currentUsername,
                team: userTeam,
                playing11: playing11Data, // Includes positions and captain flag
                impactPlayers: impactPlayersData,
                captain: window.selectedCaptain,
                submittedAt: new Date().toISOString(),
                sessionId: userSessionId
            };
            
            console.log('üì§ Submitting Playing 11 with positions:', {
                playing11: playing11Data.map(p => ({name: p.name, position: p.slotPosition, captain: p.isCaptain})),
                impact: impactPlayersData.length,
                captain: window.selectedCaptain.name
            });
            
            // Send to server
            socket.emit('submitPlaying11', submissionData);
            
            // Update UI
            submitPlaying11Btn.disabled = true;
            submitPlaying11Btn.innerHTML = `
                <div class="flex items-center justify-center space-x-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    <span>Submitting...</span>
                </div>
            `;
            
            // Store in localStorage as backup
            localStorage.setItem('lastPlaying11Submission', JSON.stringify(submissionData));
        }
        
        // ========== DISPLAY FUNCTIONS ==========
        function displayTeamInfo(team) {
            if (!team) return;
            
            teamHeader.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center relative shadow-xl" 
                         style="background: ${team.color}20; border: 2px solid ${team.color}">
                        <div class="w-12 h-12 rounded-full bg-gray-900/80 flex items-center justify-center overflow-hidden p-1">
                            ${team.logo ? 
                                `<img src="${team.logo}" 
                                      alt="${team.name}" 
                                      class="w-full h-full object-contain"
                                      onerror="this.onerror=null; this.src='https://via.placeholder.com/48/1e293b/ffffff?text=${team.name.charAt(0)}';">` :
                                `<div class="w-full h-full flex items-center justify-center font-bold text-lg" style="color: ${team.color}">
                                    ${team.name.charAt(0)}
                                </div>`
                            }
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold team-name-gradient">${team.name}</h2>
                        <p class="text-gray-400 text-sm">Playing 11 Selection Phase</p>
                        <p class="text-gray-500 text-xs mt-1">Player: ${currentUsername}</p>
                    </div>
                </div>
            `;
        }
        
        function updateStatistics(data) {
            if (!data) return;
            
            const totalPlayersValue = allPlayers.length;
            const totalSpentValue = data.auctionPlayers?.reduce((sum, player) => sum + (player.price || 0), 0) || 0;
            const rtmCardsValue = data.rtmCards || 0;
            const remainingBudgetValue = data.budget || 100;
            
            totalPlayers.textContent = totalPlayersValue;
            totalSpent.textContent = `‚Çπ${totalSpentValue.toFixed(2)} Cr`;
            rtmCards.textContent = rtmCardsValue;
            remainingBudget.textContent = `‚Çπ${remainingBudgetValue.toFixed(2)} Cr`;
        }

        // ========== SOCKET FUNCTIONS ==========
        function initializeSocket() {
            console.log('üîå Connecting to socket server...');
            socket = io(window.BACKEND_URL,{ transports: ["websocket", "polling"],}
        );
            
            socket.on('connect', () => {
                console.log('‚úÖ Connected to server');
                
                // Join the playing11 room
                socket.emit('joinPlaying11', {
                    roomCode: currentRoomCode,
                    username: currentUsername,
                    sessionId: userSessionId
                });
            });
            
            socket.on('connect_error', (error) => {
                console.error('‚ùå Connection error:', error);
                showAlert('Connection Error', 'Cannot connect to server. Please refresh.', '‚ùå');
            });
            
            socket.on('playing11Joined', (data) => {
                console.log('‚úÖ Joined playing11 room:', data);
                
                // Request squad data if we don't have it yet
                if (!squadData || !squadData.retainedPlayers) {
                    console.log('üîÑ Requesting squad data from server...');
                    socket.emit('requestSquad', {
                        roomCode: currentRoomCode,
                        username: currentUsername,
                        sessionId: userSessionId
                    });
                } else {
                    console.log('‚úÖ Already have squad data, no need to request');
                }
            });
            
            socket.on('squadUpdate', (data) => {
                console.log('üë• Received squad data from server:', data);
                squadData = data;
                userTeam = data.team;
                maxImpactPlayers = data.rules?.impactPlayers || 1;
                
                // Store in localStorage for persistence
                localStorage.setItem('userSquadData', JSON.stringify(data));
                
                // Process squad data
                processSquadData(data);
                
                // Display team info
                displayTeamInfo(data.team);
                
                // Update statistics
                updateStatistics(data);
                
                // Update impact player slots based on rules
                updateImpactPlayerSlots();
                
                showAlert('Squad Loaded', `Your squad of ${allPlayers.length} players is ready!`, '‚úÖ');
            });
            
            socket.on('playing11SubmittedSuccess', (data) => {
                console.log('‚úÖ Playing 11 submitted successfully:', data);
                
                // Store submission status
                localStorage.setItem('playing11Submitted', 'true');
                localStorage.setItem('submissionTime', new Date().toISOString());
                localStorage.setItem('submissionData', JSON.stringify(data));
                
                // Update UI
                submitPlaying11Btn.innerHTML = '‚úÖ Submitted Successfully!';
                submitPlaying11Btn.disabled = true;
                
                // Show success modal
                showSuccessModal();
                
                // Update status badge
                validationStatus.classList.remove('hidden');
                statusBadge.className = 'flex items-center space-x-2 px-4 py-2 rounded-lg bg-green-900/30';
                statusBadge.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-sm font-medium text-green-400">Submitted ‚úì</span>
                `;
                
                // Disable drag and drop
                document.querySelectorAll('.player-drag-item').forEach(item => {
                    item.setAttribute('draggable', 'false');
                    item.classList.add('opacity-50');
                });
                
                // Disable slot interactions
                document.querySelectorAll('.slot-item').forEach(slot => {
                    slot.style.pointerEvents = 'none';
                    slot.style.opacity = '0.7';
                });
            });

            socket.on('playing11Error', (data) => {
                console.error('‚ùå Playing 11 submission error:', data);
                showAlert('Submission Error', data.message, '‚ùå');
                
                // Re-enable submit button
                submitPlaying11Btn.disabled = false;
                submitPlaying11Btn.innerHTML = '‚úÖ Submit Playing 11';
            });
            
            socket.on('teamRated', (data) => {
                console.log('Team rated by auctioneer:', data);
                showAlert('Team Rated', `Your team has been rated: ${data.rating}/10`, '‚≠ê');
            });
            
            socket.on('error', (data) => {
                console.error('‚ùå Error:', data);
                showAlert('Error', data.message, '‚ùå');
            });
            
            socket.on('disconnect', () => {
                console.log('üîå Disconnected from server');
                showAlert('Disconnected', 'Lost connection to server. Attempting to reconnect...', '‚ö†Ô∏è');
            });
        }

        // ========== MODAL FUNCTIONS ==========
        function showSuccessModal() {
            document.getElementById('successModal').classList.remove('hidden');
        }
        
        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
        }
        
        function showAlert(title, message, icon = '‚ö†Ô∏è') {
            const modal = document.getElementById('alertModal');
            document.getElementById('modalIcon').textContent = icon;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            modal.classList.remove('hidden');
        }
        
        function closeAlertModal() {
            document.getElementById('alertModal').classList.add('hidden');
        }
        
        // Expose functions to global scope
        window.closeSuccessModal = closeSuccessModal;
        window.closeAlertModal = closeAlertModal;
        window.requestSquadFromServer = requestSquadFromServer;

        console.log('‚úÖ Playing 11 page loaded');
    </script>
       
</body>
</html>