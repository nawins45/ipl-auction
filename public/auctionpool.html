<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Auction - IPL Auction</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gradient-to-br from-gray-900 to-blue-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
                    Live Auction Pool
                </h1>
                <div id="teamHeader" class="flex items-center justify-center md:justify-start space-x-3">
                    <!-- Team info will be loaded -->
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row items-center gap-4">
                <!-- Auction Status -->
                <div class="bg-gradient-to-r from-blue-900/30 to-purple-900/30 rounded-xl p-4 text-center min-w-[140px]">
                    <div class="text-sm text-gray-300 mb-1">AUCTION STATUS</div>
                    <div id="auctionStatus" class="text-2xl font-bold text-yellow-400">LIVE</div>
                    <div class="text-xs text-gray-400">Auctioneer Controlled</div>
                </div>
                
                <!-- Purse -->
                <div class="bg-gradient-to-r from-green-900/30 to-emerald-900/30 rounded-xl p-4 text-center min-w-[140px]">
                    <div class="text-sm text-gray-300 mb-1">TEAM PURSE</div>
                    <div class="text-2xl font-bold text-green-400">‚Çπ<span id="purseRemaining">100</span> Cr</div>
                    <div class="text-xs text-gray-400">Remaining</div>
                </div>
                
                <!-- Squad Button -->
                <button id="viewSquadBtn" 
                        class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 rounded-lg font-semibold transition-all duration-300">
                    üë• View Squad
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left: Current Player & Bidding -->
            <div class="lg:col-span-2">
                <!-- Current Player Card -->
                <div id="currentPlayerCard" class="glass-panel rounded-2xl p-6 slide-in hidden">
                    <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
                        <!-- Player Image -->
                        <div class="w-48 h-48 rounded-xl bg-gray-800/50 flex items-center justify-center overflow-hidden">
                            <img id="playerImage" src="default-player.png" alt="Player" 
                                 class="w-full h-full object-cover">
                        </div>
                        
                        <!-- Player Details -->
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h2 id="playerName" class="text-3xl font-bold mb-1">Player Name</h2>
                                    <div class="flex items-center space-x-3 mb-3">
                                        <span id="playerRole" class="px-3 py-1 bg-blue-900/30 text-blue-300 rounded-lg">Role</span>
                                        <span id="playerType" class="px-3 py-1 bg-purple-900/30 text-purple-300 rounded-lg">Type</span>
                                        <span id="playerNationality" class="px-3 py-1 bg-yellow-900/30 text-yellow-300 rounded-lg">Nationality</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-yellow-400 mb-1">Current Bid</div>
                                    <div id="currentBid" class="text-4xl font-black">‚Çπ0 Cr</div>
                                </div>
                            </div>
                            
                            <!-- Stats Grid -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-gray-800/30 p-3 rounded-lg">
                                    <div class="text-sm text-gray-400">Total Runs</div>
                                    <div id="statRuns" class="text-lg font-semibold">0</div>
                                </div>
                                <div class="bg-gray-800/30 p-3 rounded-lg">
                                    <div class="text-sm text-gray-400">Strike Rate</div>
                                    <div id="statStrikeRate" class="text-lg font-semibold">0</div>
                                </div>
                                <div class="bg-gray-800/30 p-3 rounded-lg">
                                    <div class="text-sm text-gray-400">Wickets</div>
                                    <div id="statWickets" class="text-lg font-semibold">0</div>
                                </div>
                                <div class="bg-gray-800/30 p-3 rounded-lg">
                                    <div class="text-sm text-gray-400">Economy</div>
                                    <div id="statEconomy" class="text-lg font-semibold">0</div>
                                </div>
                            </div>
                            
                            <!-- Bidding Controls -->
                            <div id="biddingControls" class="space-y-4 hidden">
                                <div class="flex flex-wrap gap-3">
                                    <button class="bid-btn px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-xl font-semibold transition-all duration-300" 
                                            data-increment="0.1">
                                        +‚Çπ0.1 Cr
                                    </button>
                                    <button class="bid-btn px-4 py-3 bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 rounded-xl font-semibold transition-all duration-300" 
                                            data-increment="0.25">
                                        +‚Çπ0.25 Cr
                                    </button>
                                    <button class="bid-btn px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 rounded-xl font-semibold transition-all duration-300" 
                                            data-increment="0.5">
                                        +‚Çπ0.5 Cr
                                    </button>
                                    <button class="bid-btn px-4 py-3 bg-gradient-to-r from-red-500 to-orange-600 hover:from-red-600 hover:to-orange-700 rounded-xl font-semibold transition-all duration-300" 
                                            data-increment="1">
                                        +‚Çπ1 Cr
                                    </button>
                                </div>
                                <div class="text-sm text-gray-400">
                                    Minimum bid increment: <span id="minIncrement" class="text-yellow-400">‚Çπ0.10 Cr</span>
                                </div>
                            </div>
                            
                            <!-- RTM Panel (Hidden initially) -->
                            <div id="rtmPanel" class="bg-gradient-to-r from-yellow-900/20 to-orange-900/20 rounded-xl p-4 border border-yellow-500/30 hidden">
                                <h3 class="text-xl font-bold text-yellow-400 mb-2">RTM (Right To Match) Active</h3>
                                <p class="text-gray-300 mb-3">This player was originally from <span id="originalTeam" class="font-bold"></span>. They can match your bid.</p>
                                <button id="useRtmBtn" class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 rounded-lg font-semibold">
                                    Use RTM Card
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Waiting for Auction -->
                <div id="waitingAuction" class="glass-panel rounded-2xl p-12 text-center">
                    <div class="text-6xl mb-4">‚è≥</div>
                    <h3 class="text-2xl font-bold text-gray-300 mb-2">Waiting for Auction to Start</h3>
                    <p class="text-gray-500">The auctioneer will begin the auction pool shortly...</p>
                    <div class="mt-6 flex items-center justify-center space-x-2">
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                    </div>
                </div>
            </div>

            <!-- Right: Bid Log & Info -->
            <div class="space-y-6">
                <!-- Auction Info -->
                <div class="glass-panel rounded-2xl p-6 slide-in">
                    <h3 class="text-xl font-bold text-yellow-400 mb-4">Auction Status</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Category:</span>
                            <span id="auctionCategory" class="font-semibold">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Players Left:</span>
                            <span id="playersLeft" class="font-semibold">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Unsold Players:</span>
                            <span id="unsoldCount" class="font-semibold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">RTM Cards:</span>
                            <span id="rtmCards" class="font-semibold">2</span>
                        </div>
                    </div>
                </div>
                
                <!-- Live Bid Log -->
                <div class="glass-panel rounded-2xl p-6 slide-in">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-yellow-400">Live Bid Log</h3>
                        <button id="clearLogBtn" class="text-xs text-gray-400 hover:text-gray-300">Clear</button>
                    </div>
                    <div id="bidLog" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                        <!-- Bid messages will appear here -->
                        <div class="text-center text-gray-500 py-4">No bids yet</div>
                    </div>
                </div>
                
                <!-- Squad Status -->
                <div class="glass-panel rounded-2xl p-6 slide-in">
                    <h3 class="text-xl font-bold text-yellow-400 mb-4">Squad Status</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gradient-to-r from-green-900/30 to-emerald-900/30 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-green-400" id="squadSize">0</div>
                            <div class="text-sm text-gray-400">Squad Size</div>
                            <div class="text-xs text-gray-500">Max: <span id="maxSquad">25</span></div>
                        </div>
                        <div class="bg-gradient-to-r from-blue-900/30 to-cyan-900/30 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-400" id="remainingSlots">25</div>
                            <div class="text-sm text-gray-400">Remaining Slots</div>
                            <div class="text-xs text-gray-500">Can buy: <span id="canBuy">25</span> more</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Squad Modal -->
    <div id="squadModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black/80"></div>
        <div class="glass-panel rounded-2xl p-6 max-w-4xl w-11/12 max-h-[80vh] overflow-y-auto z-10">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-yellow-400" id="squadTeamName">Team Squad</h2>
                <button onclick="closeSquadModal()" class="text-2xl hover:text-yellow-400">‚úï</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Retained Players -->
                <div>
                    <h3 class="text-xl font-bold mb-4 text-green-400">Retained Players</h3>
                    <div id="retainedPlayers" class="space-y-3">
                        <!-- Will be populated -->
                    </div>
                </div>
                
                <!-- Auction Buys -->
                <div>
                    <h3 class="text-xl font-bold mb-4 text-blue-400">Auction Purchases</h3>
                    <div id="auctionBuys" class="space-y-3">
                        <div class="text-gray-500 text-center py-4">No players bought yet</div>
                    </div>
                </div>
            </div>
            
            <!-- Totals -->
            <div class="mt-6 pt-6 border-t border-gray-700">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center p-3 bg-gray-800/30 rounded-lg">
                        <div class="text-sm text-gray-400">Total Players</div>
                        <div class="text-2xl font-bold" id="totalPlayers">0</div>
                    </div>
                    <div class="text-center p-3 bg-gray-800/30 rounded-lg">
                        <div class="text-sm text-gray-400">Total Spent</div>
                        <div class="text-2xl font-bold text-yellow-400">‚Çπ<span id="totalSpent">0</span> Cr</div>
                    </div>
                    <div class="text-center p-3 bg-gray-800/30 rounded-lg">
                        <div class="text-sm text-gray-400">Purse Remaining</div>
                        <div class="text-2xl font-bold text-green-400">‚Çπ<span id="modalPurseRemaining">100</span> Cr</div>
                    </div>
                    <div class="text-center p-3 bg-gray-800/30 rounded-lg">
                        <div class="text-sm text-gray-400">RTM Cards Left</div>
                        <div class="text-2xl font-bold text-purple-400" id="modalRtmCards">2</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RTM Modal -->
    <div id="rtmModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black/80"></div>
        <div class="glass-panel rounded-2xl p-6 max-w-md w-11/12 z-10">
            <div class="text-center mb-6">
                <div class="text-4xl mb-4">üîÑ</div>
                <h3 class="text-2xl font-bold text-yellow-400 mb-2">RTM Decision Required</h3>
                <p class="text-gray-300">
                    <span id="rtmTeamName" class="font-bold"></span> has the Right To Match for 
                    <span id="rtmPlayerName" class="font-bold text-yellow-300"></span>
                </p>
                <p class="text-gray-400 text-sm mt-2">Winning bid: <span id="rtmWinningBid" class="font-bold"></span></p>
                <p class="text-gray-400 text-xs mt-1">You have <span id="rtmCardsRemaining" class="font-bold text-purple-400">2</span> RTM cards left</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block mb-2 text-gray-300">RTM Amount (must be ‚â• winning bid, integer only)</label>
                    <input type="number" id="rtmAmount" 
                           class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-center text-xl"
                           min="0" step="1" placeholder="Enter amount in Cr">
                </div>
                
                <div class="flex space-x-4">
                    <button onclick="declineRTM()" 
                            class="flex-1 py-3 bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-800 hover:to-gray-900 rounded-xl font-semibold">
                        Decline RTM
                    </button>
                    <button onclick="acceptRTM()" 
                            class="flex-1 py-3 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 rounded-xl font-semibold">
                        Use RTM Card
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Toast -->
    <div id="alertToast" class="fixed top-4 right-4 glass-panel rounded-xl p-4 max-w-md z-50 hidden slide-in">
        <div class="flex items-start space-x-3">
            <div class="text-2xl" id="alertIcon">‚ö†Ô∏è</div>
            <div>
                <h4 class="font-bold text-lg" id="alertTitle">Alert</h4>
                <p class="text-gray-300" id="alertMessage">This is an alert message</p>
            </div>
            <button onclick="closeAlert()" class="text-gray-400 hover:text-white">‚úï</button>
        </div>
    </div>

    <script>
        // ========== GLOBAL VARIABLES ==========
        let socket = null;
        let auctionData = null;
        let currentPlayer = null;
        let currentUsername = null;
        let currentRoomCode = null;
        let userTeam = null;
        let teamBudget = 100;
        let squadLimits = { 
            indian: 0, 
            overseas: 0, 
            total: 0,
            maxSquad: 25,
            maxIndian: 4,
            maxOverseas: 3 
        };
        let rtmCards = 2;
        let retentionData = { rules: { squadSize: 25 } };
        let currentRtmData = null;

        // ========== DOM ELEMENTS ==========
        const teamHeader = document.getElementById('teamHeader');
        const purseRemaining = document.getElementById('purseRemaining');
        const viewSquadBtn = document.getElementById('viewSquadBtn');
        const currentPlayerCard = document.getElementById('currentPlayerCard');
        const waitingAuction = document.getElementById('waitingAuction');
        const playerImage = document.getElementById('playerImage');
        const playerName = document.getElementById('playerName');
        const playerRole = document.getElementById('playerRole');
        const playerType = document.getElementById('playerType');
        const playerNationality = document.getElementById('playerNationality');
        const currentBid = document.getElementById('currentBid');
        const statRuns = document.getElementById('statRuns');
        const statStrikeRate = document.getElementById('statStrikeRate');
        const statWickets = document.getElementById('statWickets');
        const statEconomy = document.getElementById('statEconomy');
        const biddingControls = document.getElementById('biddingControls');
        const minIncrement = document.getElementById('minIncrement');
        const auctionCategory = document.getElementById('auctionCategory');
        const playersLeft = document.getElementById('playersLeft');
        const unsoldCount = document.getElementById('unsoldCount');
        const rtmCardsEl = document.getElementById('rtmCards');
        const bidLog = document.getElementById('bidLog');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const squadSize = document.getElementById('squadSize');
        const maxSquad = document.getElementById('maxSquad');
        const remainingSlots = document.getElementById('remainingSlots');
        const canBuy = document.getElementById('canBuy');
        const rtmPanel = document.getElementById('rtmPanel');
        const originalTeam = document.getElementById('originalTeam');
        const useRtmBtn = document.getElementById('useRtmBtn');

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Auction Pool loading...');
            
            // Get user info from localStorage
            const auctionUser = JSON.parse(localStorage.getItem('auctionUser') || '{}');
            currentRoomCode = auctionUser.roomCode;
            currentUsername = auctionUser.username;
            
            console.log('üìä User data:', { 
                roomCode: currentRoomCode, 
                username: currentUsername 
            });
            
            if (!currentRoomCode || !currentUsername) {
                showAlert('Session Error', 'No session found. Returning to join page.', '‚ùå');
                setTimeout(() => {
                    window.location.href = 'user.html';
                }, 3000);
                return;
            }
            
            // Initialize socket connection
            initializeSocket();
            
            // Event Listeners
            clearLogBtn.addEventListener('click', clearBidLog);
            viewSquadBtn.addEventListener('click', openSquadModal);
            useRtmBtn.addEventListener('click', () => openRtmModal());
            
            // Bid button delegation
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('bid-btn')) {
                    const increment = parseFloat(e.target.dataset.increment);
                    placeBid(increment);
                }
            });
        });

        // ========== SOCKET FUNCTIONS ==========
        function initializeSocket() {
            console.log('üîå Connecting to socket server...');
            socket = io();
            
            socket.on('connect', () => {
                console.log('‚úÖ Connected to auction pool');
                
                // Join auction pool
                socket.emit('joinAuctionPool', {
                    roomCode: currentRoomCode,
                    username: currentUsername
                });
            });
            
            socket.on('connect_error', (error) => {
                console.error('‚ùå Connection error:', error);
                showAlert('Connection Error', 'Cannot connect to server. Please refresh.', '‚ùå');
            });
            
            socket.on('auctionData', (data) => {
                console.log('üéØ Received auction data:', data);
                auctionData = data;
                userTeam = data.team;
                teamBudget = data.purse || 100;
                squadLimits = data.squadLimits || squadLimits;
                rtmCards = data.rtmCards || 2;
                
                // Update UI
                updateUserSession();
                initializePage();
                updateSquadLimits();
            });
            
            socket.on('playerUpForAuction', (data) => {
                console.log('üë§ Player up for auction:', data);
                currentPlayer = data.player;
                waitingAuction.classList.add('hidden');
                currentPlayerCard.classList.remove('hidden');
                displayCurrentPlayer();
                biddingControls.classList.remove('hidden');
                updateBidButtons(currentPlayer.currentBid);
                
                // Show RTM panel if player's original team is different
                if (data.player.originalTeam && data.player.originalTeam !== userTeam?.name) {
                    rtmPanel.classList.remove('hidden');
                    originalTeam.textContent = data.player.originalTeam;
                } else {
                    rtmPanel.classList.add('hidden');
                }
                
                updateBidIncrement(currentPlayer.currentBid || currentPlayer.basePrice || 0);
            });
            
            socket.on('bidUpdate', (data) => {
                console.log('üí∞ Bid update:', data);
                
                // Update current player data
                if (currentPlayer && currentPlayer.id === data.playerId) {
                    currentPlayer.currentBid = data.bid;
                    currentPlayer.currentBidder = data.team;
                    
                    // Update UI
                    currentBid.textContent = `‚Çπ${data.bid} Cr`;
                    currentBid.classList.add('bounce');
                    setTimeout(() => currentBid.classList.remove('bounce'), 500);
                    
                    updateBidIncrement(data.bid);
                }
                
                // Add to bid log
                addBidToLog(data.team, data.bid);
            });
            
            socket.on('playerSold', (data) => {
                console.log('‚úÖ Player sold:', data);
                
                // Add to bid log
                const soldItem = document.createElement('div');
                soldItem.className = 'p-3 rounded-lg bg-green-900/30 border-l-4 border-green-500';
                soldItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-bold">${data.player}</span>
                            <span class="text-gray-400 ml-2">‚Üí ${data.team.toUpperCase()}</span>
                        </div>
                        <span class="font-bold text-green-400">‚Çπ${data.price} Cr</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">SOLD at ${new Date().toLocaleTimeString()}</div>
                `;
                bidLog.prepend(soldItem);
                
                // Update squad if it's our team
                if (data.team === userTeam?.id) {
                    updateTeamAfterPurchase(data.player, data.price, data.isOverseas);
                    teamBudget -= data.price;
                    purseRemaining.textContent = teamBudget.toFixed(2);
                    
                    // Update squad limits
                    if (data.isOverseas) {
                        squadLimits.overseas++;
                    } else {
                        squadLimits.indian++;
                    }
                    squadLimits.total = squadLimits.indian + squadLimits.overseas;
                    
                    updateSquadLimits();
                    
                    // Request updated squad data
                    socket.emit('requestSquadUpdate', {
                        roomCode: currentRoomCode,
                        username: currentUsername
                    });
                }
                
                // Show RTM notification if applicable
                if (currentPlayer && currentPlayer.originalTeam && currentPlayer.originalTeam !== data.team) {
                    setTimeout(() => {
                        const rtmItem = document.createElement('div');
                        rtmItem.className = 'p-3 rounded-lg bg-yellow-900/30 border-l-4 border-yellow-500 mt-2';
                        rtmItem.innerHTML = `
                            <div class="flex items-center space-x-2">
                                <span class="text-yellow-400">üîÑ</span>
                                <span>RTM available for <span class="font-bold">${currentPlayer.originalTeam}</span></span>
                            </div>
                        `;
                        bidLog.prepend(rtmItem);
                    }, 1000);
                }
                
                // Clear current player after delay
                setTimeout(() => {
                    currentPlayerCard.classList.add('hidden');
                    waitingAuction.classList.remove('hidden');
                    biddingControls.classList.add('hidden');
                    rtmPanel.classList.add('hidden');
                }, 3000);
            });
            
            socket.on('playerUnsold', (data) => {
                console.log('‚ùå Player unsold:', data);
                
                const unsoldItem = document.createElement('div');
                unsoldItem.className = 'p-3 rounded-lg bg-red-900/30 border-l-4 border-red-500';
                unsoldItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold">${data.player}</span>
                        <span class="font-bold text-red-400">UNSOLD</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">${new Date().toLocaleTimeString()}</div>
                `;
                bidLog.prepend(unsoldItem);
                
                // Clear current player after delay
                setTimeout(() => {
                    currentPlayerCard.classList.add('hidden');
                    waitingAuction.classList.remove('hidden');
                    biddingControls.classList.add('hidden');
                    rtmPanel.classList.add('hidden');
                }, 3000);
            });
            
            socket.on('auctionUpdate', (data) => {
                console.log('üìä Auction update:', data);
                updateAuctionStatus(data);
            });
            
            socket.on('rtmTriggered', (data) => {
                console.log('üîÑ RTM triggered:', data);
                openRtmModal(data);
            });
            
            socket.on('rtmResult', (data) => {
                console.log('üìù RTM result:', data);
                
                const rtmItem = document.createElement('div');
                rtmItem.className = 'p-3 rounded-lg bg-purple-900/30 border-l-4 border-purple-500';
                rtmItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-bold">${data.player}</span>
                            <span class="text-gray-400 ml-2">‚Üí ${data.success ? 'RTM USED' : 'RTM DECLINED'}</span>
                        </div>
                        ${data.success ? `<span class="font-bold text-purple-400">‚Çπ${data.rtmAmount} Cr</span>` : ''}
                    </div>
                    <div class="text-xs text-gray-400 mt-1">${data.success ? 'Retained by original team' : 'Goes to winning team'}</div>
                `;
                bidLog.prepend(rtmItem);
                
                if (data.success) {
                    if (data.originalTeam === userTeam?.name) {
                        // We used RTM
                        rtmCards--;
                        rtmCardsEl.textContent = rtmCards;
                        teamBudget -= data.rtmAmount;
                        purseRemaining.textContent = teamBudget.toFixed(2);
                        
                        // Update squad
                        socket.emit('requestSquadUpdate', {
                            roomCode: currentRoomCode,
                            username: currentUsername
                        });
                    } else if (data.previousTeam === userTeam?.id) {
                        // Our player was taken via RTM, refund us
                        teamBudget += data.rtmAmount;
                        purseRemaining.textContent = teamBudget.toFixed(2);
                        
                        // Update squad
                        socket.emit('requestSquadUpdate', {
                            roomCode: currentRoomCode,
                            username: currentUsername
                        });
                    }
                }
            });
            
            socket.on('squadUpdate', (data) => {
                console.log('üë• Squad update:', data);
                updateSquadDisplay(data);
            });
            
            socket.on('auctionComplete', (data) => {
                console.log('üèÜ Auction complete:', data);
                showAlert('Auction Complete', 'All players have been auctioned!', 'üèÜ');
                
                // Redirect to playing 11 after delay
                setTimeout(() => {
                    window.location.href = 'playing11.html';
                }, 3000);
            });
            
            socket.on('bidError', (data) => {
                console.error('‚ùå Bid error:', data);
                showAlert('Bid Error', data.message, '‚ùå');
            });
            
            socket.on('rtmError', (data) => {
                console.error('‚ùå RTM error:', data);
                showAlert('RTM Error', data.message, '‚ùå');
            });
            
            socket.on('error', (data) => {
                console.error('‚ùå Auction error:', data);
                showAlert('Error', data.message, '‚ùå');
            });
            
            socket.on('redirectToPlaying11', (data) => {
                console.log('üöÄ Redirecting to playing 11:', data);
                showAlert('Auction Complete', 'Redirecting to playing 11 selection...', '‚úÖ');
                
                setTimeout(() => {
                    window.location.href = 'playing11.html';
                }, 2000);
            });
        }

        // ========== PAGE FUNCTIONS ==========
        function initializePage() {
            console.log('üîÑ Initializing auction page...');
            
            if (!userTeam) {
                console.error('‚ùå No team data');
                showErrorState('No team assigned');
                return;
            }
            
            // Display team info
            displayTeamInfo();
            
            // Update UI
            purseRemaining.textContent = teamBudget.toFixed(2);
            rtmCardsEl.textContent = rtmCards;
            maxSquad.textContent = squadLimits.maxSquad;
            
            console.log('‚úÖ Auction page initialized');
        }
        
        function displayTeamInfo() {
            if (!userTeam) return;
            
            teamHeader.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center relative" 
                         style="background: ${userTeam.color}20; border: 2px solid ${userTeam.color}">
                        <div class="w-12 h-12 rounded-full bg-gray-900/80 flex items-center justify-center overflow-hidden">
                            <img src="${userTeam.logo || 'default-player.png'}" 
                                 alt="${userTeam.name}" 
                                 class="w-full h-full object-contain p-1"
                                 onerror="this.onerror=null; this.src='default-player.png';">
                        </div>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold" style="color: ${userTeam.color}">${userTeam.name}</h2>
                        <p class="text-gray-400 text-sm">Live Auction Pool</p>
                        <p class="text-gray-500 text-xs">${currentUsername}</p>
                    </div>
                </div>
            `;
        }
        
        function displayCurrentPlayer() {
            if (!currentPlayer) return;
            
            currentPlayerCard.classList.remove('hidden');
            waitingAuction.classList.add('hidden');
            
            // Update player info
            playerName.textContent = currentPlayer.name || 'Unknown Player';
            playerRole.textContent = currentPlayer.role || 'Player';
            playerType.textContent = currentPlayer.bowlingType || 'N/A';
            playerNationality.textContent = currentPlayer.nationality || 'Indian';
            currentBid.textContent = `‚Çπ${currentPlayer.currentBid || currentPlayer.basePrice || 2} Cr`;
            
            // Update stats
            statRuns.textContent = currentPlayer.totalRuns || 0;
            statStrikeRate.textContent = currentPlayer.strikeRate || 0;
            statWickets.textContent = currentPlayer.wickets || 0;
            statEconomy.textContent = currentPlayer.economyRate || 0;
            
            // Update player image
            const playerNameSlug = (currentPlayer.name || '').toLowerCase().replace(/\s+/g, '_');
            playerImage.src = `images/players/${playerNameSlug}.jpg`;
            playerImage.onerror = () => {
                playerImage.src = 'default-player.png';
            };
        }
        
        function showErrorState(message) {
            waitingAuction.innerHTML = `
                <div class="text-6xl mb-4">‚ùå</div>
                <h3 class="text-2xl font-bold text-gray-300 mb-2">Error</h3>
                <p class="text-gray-500 mb-4">${message}</p>
                <button onclick="window.location.href='rules.html'" 
                        class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg font-semibold">
                    Return to Rules
                </button>
            `;
        }

        // ========== BIDDING FUNCTIONS ==========
        function updateBidIncrement(currentBid) {
            console.log(`üîÑ Current bid: ‚Çπ${currentBid} Cr`);
            
            // ALL buttons are always enabled - no restrictions
            document.querySelectorAll('.bid-btn').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('opacity-40', 'cursor-not-allowed');
                btn.classList.add('cursor-pointer');
            });
            
            // Just show minimum increment
            minIncrement.textContent = '‚Çπ0.10 Cr';
        }
        
        function updateBidButtons(currentBid) {
            // Enable all bid buttons
            document.querySelectorAll('.bid-btn').forEach(btn => {
                btn.disabled = false;
            });
        }

        function placeBid(increment) {
            if (!currentPlayer || !userTeam) {
                console.log('‚ùå No current player or user team');
                return;
            }
            
            const currentBidValue = parseFloat(currentPlayer.currentBid || currentPlayer.basePrice || 2);
            const newBid = currentBidValue + increment;
            
            // Round to 2 decimal places
            const roundedBid = Math.round(newBid * 100) / 100;
            
            console.log(`üéØ Bid attempt: ${userTeam.id} bidding ‚Çπ${roundedBid} Cr`);
            console.log(`   Current: ‚Çπ${currentBidValue} Cr, Increment: ‚Çπ${increment} Cr`);
            
            // Validate bid
            if (roundedBid > teamBudget) {
                showAlert('Insufficient Funds', `Your purse is only ‚Çπ${teamBudget.toFixed(2)} Cr`, '‚ùå');
                return;
            }
            
            // Check squad size limit
            const totalSquadSize = squadLimits.total;
            const maxSquadValue = squadLimits.maxSquad || 25;
            
            if (totalSquadSize >= maxSquadValue) {
                showAlert('Squad Full', `Maximum squad size (${maxSquadValue}) reached. You cannot buy more players.`, 'üèè');
                return;
            }
            
            // Send bid to server
            socket.emit('placeBid', {
                roomCode: currentRoomCode,
                playerId: currentPlayer.id,
                team: userTeam.id,
                bid: roundedBid,
                increment: increment
            });
            
            console.log(`üì§ Bid sent: ‚Çπ${roundedBid} Cr`);
        }
        
        function addBidToLog(team, bid) {
            const bidItem = document.createElement('div');
            bidItem.className = 'bid-log-item new p-3 rounded-lg bg-gray-800/30';
            
            // Get team color from predefined teams
            const teamColors = {
                'csk': '#FFCC00', 'mi': '#0048A0', 'rcb': '#D5152C',
                'kkr': '#3A225D', 'dc': '#004C93', 'pbks': '#ED1B24',
                'rr': '#FF4C93', 'srh': '#FF6F3D', 'gt': '#1E2D4A', 'lsg': '#A5E1F4'
            };
            
            const teamColor = teamColors[team] || '#FFFFFF';
            
            bidItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full" style="background: ${teamColor}"></div>
                        <span class="font-semibold" style="color: ${teamColor}">${team.toUpperCase()}</span>
                    </div>
                    <span class="font-bold text-yellow-400">‚Çπ${bid} Cr</span>
                </div>
                <div class="text-xs text-gray-400 mt-1">${new Date().toLocaleTimeString()}</div>
            `;
            
            bidLog.prepend(bidItem);
            
            // Remove "new" class after animation
            setTimeout(() => {
                bidItem.classList.remove('new');
            }, 1000);
            
            // Limit log to 20 items
            if (bidLog.children.length > 20) {
                bidLog.removeChild(bidLog.lastChild);
            }
        }
        
        function clearBidLog() {
            bidLog.innerHTML = '<div class="text-center text-gray-500 py-4">No bids yet</div>';
        }

        // ========== AUCTION STATUS FUNCTIONS ==========
        function updateAuctionStatus(data) {
            auctionCategory.textContent = data.category || '-';
            playersLeft.textContent = data.playersLeft || '-';
            unsoldCount.textContent = data.unsoldCount || 0;
        }
        
        function updateSquadLimits() {
            // Calculate squad size
            const totalSquadSize = squadLimits.total;
            const maxSquadValue = squadLimits.maxSquad || 25;
            const remaining = Math.max(0, maxSquadValue - totalSquadSize);
            
            squadSize.textContent = totalSquadSize;
            maxSquad.textContent = maxSquadValue;
            remainingSlots.textContent = remaining;
            canBuy.textContent = remaining;
            
            // Update color based on limits
            squadSize.className = `text-lg font-bold ${
                totalSquadSize > maxSquadValue ? 'text-red-400' : 'text-green-400'
            }`;
            
            remainingSlots.className = `text-lg font-bold ${
                remaining === 0 ? 'text-red-400' : 'text-blue-400'
            }`;
        }
        
        function updateTeamAfterPurchase(playerName, price, isOverseas) {
            // Budget already updated in playerSold handler
            // Update squad counts
            if (isOverseas) {
                squadLimits.overseas++;
            } else {
                squadLimits.indian++;
            }
            squadLimits.total = squadLimits.indian + squadLimits.overseas;
            
            updateSquadLimits();
        }

        // ========== SQUAD MODAL FUNCTIONS ==========
        function openSquadModal() {
            socket.emit('requestSquad', {
                roomCode: currentRoomCode,
                username: currentUsername
            });
        }
        
        function closeSquadModal() {
            document.getElementById('squadModal').classList.add('hidden');
        }
        
        function updateSquadDisplay(data) {
            document.getElementById('squadTeamName').textContent = data.team?.name || 'Team Squad';
            document.getElementById('modalPurseRemaining').textContent = teamBudget.toFixed(2);
            document.getElementById('modalRtmCards').textContent = rtmCards;
            
            // Update retained players
            const retainedContainer = document.getElementById('retainedPlayers');
            retainedContainer.innerHTML = '';
            
            if (data.retainedPlayers && data.retainedPlayers.length > 0) {
                data.retainedPlayers.forEach(player => {
                    const playerEl = document.createElement('div');
                    playerEl.className = 'flex justify-between items-center p-3 bg-gray-800/30 rounded-lg';
                    playerEl.innerHTML = `
                        <div>
                            <div class="font-medium">${player.name}</div>
                            <div class="text-sm text-gray-400">${player.role}</div>
                        </div>
                        <div class="text-green-400 font-bold">Retained</div>
                    `;
                    retainedContainer.appendChild(playerEl);
                });
            } else {
                retainedContainer.innerHTML = '<div class="text-gray-500 text-center py-4">No retained players</div>';
            }
            
            // Update auction purchases
            const auctionContainer = document.getElementById('auctionBuys');
            auctionContainer.innerHTML = '';
            
            if (data.auctionPlayers && data.auctionPlayers.length > 0) {
                let totalSpent = 0;
                data.auctionPlayers.forEach(player => {
                    totalSpent += player.price;
                    const playerEl = document.createElement('div');
                    playerEl.className = 'flex justify-between items-center p-3 bg-gray-800/30 rounded-lg';
                    playerEl.innerHTML = `
                        <div>
                            <div class="font-medium">${player.name}</div>
                            <div class="text-sm text-gray-400">${player.role}</div>
                        </div>
                        <div class="text-yellow-400 font-bold">‚Çπ${player.price} Cr</div>
                    `;
                    auctionContainer.appendChild(playerEl);
                });
                
                document.getElementById('totalSpent').textContent = totalSpent.toFixed(2);
                document.getElementById('totalPlayers').textContent = 
                    (data.retainedPlayers?.length || 0) + data.auctionPlayers.length;
            } else {
                auctionContainer.innerHTML = '<div class="text-gray-500 text-center py-4">No players bought yet</div>';
                document.getElementById('totalSpent').textContent = '0';
                document.getElementById('totalPlayers').textContent = data.retainedPlayers?.length || 0;
            }
            
            document.getElementById('squadModal').classList.remove('hidden');
        }

        // ========== RTM FUNCTIONS ==========
        function openRtmModal(data) {
            currentRtmData = data;
            
            // If opening from RTM panel
            if (!data && currentPlayer) {
                data = {
                    playerId: currentPlayer.id,
                    player: currentPlayer.name,
                    originalTeam: currentPlayer.originalTeam,
                    winningBid: currentPlayer.currentBid || currentPlayer.basePrice || 2
                };
            }
            
            if (!data) return;
            
            document.getElementById('rtmPlayerName').textContent = data.player;
            document.getElementById('rtmTeamName').textContent = data.originalTeam;
            document.getElementById('rtmWinningBid').textContent = `‚Çπ${data.winningBid} Cr`;
            document.getElementById('rtmCardsRemaining').textContent = rtmCards;
            
            // Set min value on input
            const rtmInput = document.getElementById('rtmAmount');
            rtmInput.min = Math.ceil(data.winningBid);
            rtmInput.value = Math.ceil(data.winningBid);
            
            document.getElementById('rtmModal').classList.remove('hidden');
        }
        
        function closeRtmModal() {
            document.getElementById('rtmModal').classList.add('hidden');
            currentRtmData = null;
        }
        
        function declineRTM() {
            if (!currentRtmData) return;
            
            socket.emit('submitRtmDecision', {
                roomCode: currentRoomCode,
                playerId: currentRtmData.playerId,
                rtmAmount: 0,
                accept: false
            });
            
            closeRtmModal();
        }
        
        function acceptRTM() {
            if (!currentRtmData) return;
            
            const rtmAmount = parseInt(document.getElementById('rtmAmount').value);
            const winningBid = currentRtmData.winningBid;
            
            if (rtmAmount < winningBid) {
                showAlert('Invalid RTM Amount', `RTM amount must be ‚â• winning bid (‚Çπ${winningBid} Cr)`, '‚ùå');
                return;
            }
            
            if (!Number.isInteger(rtmAmount)) {
                showAlert('Invalid Amount', 'RTM amount must be an integer (no decimals)', '‚ùå');
                return;
            }
            
            if (rtmAmount > teamBudget) {
                showAlert('Insufficient Funds', `Your purse is only ‚Çπ${teamBudget.toFixed(2)} Cr`, '‚ùå');
                return;
            }
            
            if (rtmCards <= 0) {
                showAlert('No RTM Cards', 'You have no RTM cards remaining', '‚ùå');
                return;
            }
            
            socket.emit('submitRtmDecision', {
                roomCode: currentRoomCode,
                playerId: currentRtmData.playerId,
                rtmAmount: rtmAmount,
                accept: true
            });
            
            closeRtmModal();
        }

        // ========== HELPER FUNCTIONS ==========
        function showAlert(title, message, icon = '‚ÑπÔ∏è') {
            const alertDiv = document.getElementById('alertToast');
            document.getElementById('alertIcon').textContent = icon;
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            alertDiv.classList.remove('hidden');
            
            setTimeout(() => {
                alertDiv.classList.add('hidden');
            }, 5000);
        }
        
        function closeAlert() {
            document.getElementById('alertToast').classList.add('hidden');
        }
        
        function updateUserSession() {
            const auctionUser = JSON.parse(localStorage.getItem('auctionUser') || '{}');
            localStorage.setItem('auctionUser', JSON.stringify({
                ...auctionUser,
                username: currentUsername,
                roomCode: currentRoomCode,
                team: userTeam,
                budget: teamBudget,
                rtmCards: rtmCards,
                squadLimits: squadLimits
            }));
        }

        // ========== EXPOSE FUNCTIONS TO GLOBAL SCOPE ==========
        window.closeSquadModal = closeSquadModal;
        window.closeRtmModal = closeRtmModal;
        window.openRtmModal = openRtmModal;
        window.declineRTM = declineRTM;
        window.acceptRTM = acceptRTM;
        window.closeAlert = closeAlert;
    </script>
</body>
</html>