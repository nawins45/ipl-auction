<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Auction - IPL Auction</title>
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        .player-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .player-card.expanded {
            border-color: #F59E0B;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 10px;
            margin-bottom: 4px;
        }
        
        .stat-value {
            color: #f1f5f9;
            font-weight: 600;
            font-size: 14px;
        }
        
        .overseas-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(45deg, #8B5CF6, #7C3AED);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .role-badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .role-bat { background: rgba(34, 197, 94, 0.2); color: #22C55E; }
        .role-bowl { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .role-ar { background: rgba(168, 85, 247, 0.2); color: #A855F7; }
        .role-wk { background: rgba(245, 158, 11, 0.2); color: #F59E0B; }
        
        .bid-log-item.new {
            animation: highlight 1s ease-out;
        }
        
        @keyframes highlight {
            from { background: rgba(245, 158, 11, 0.3); }
            to { background: rgba(245, 158, 11, 0.1); }
        }
        
        .team-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .bounce {
            animation: bounce 0.5s;
        }
        
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .sync-status {
            transition: all 0.3s ease;
        }
        
        .sync-status.syncing {
            color: #F59E0B;
        }
        
        .sync-status.synced {
            color: #10B981;
        }
        
        .sync-status.error {
            color: #EF4444;
        }
        
        /* Team background with opacity */
        .team-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -10;
            opacity: 0.1;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none;
        }

        /* Unsold Popup Animation */
        @keyframes unsoldSlideIn {
            from { 
                transform: translate(-50%, -40px); 
                opacity: 0; 
            }
            to { 
                transform: translate(-50%, 0); 
                opacity: 1; 
            }
        }

        .unsold-popup {
            animation: unsoldSlideIn 0.4s ease-out;
        }
        
        /* Back Button Protection */
        #backButtonWarning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #EF4444, #DC2626);
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        #backButtonWarning.show {
            transform: translateY(0);
        }
        
        /* Reconnection Overlay */
        #reconnectionOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        #reconnectionOverlay.show {
            display: flex;
        }
        
        .connection-loader {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3B82F6;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-blue-900 min-h-screen text-white">
    <!-- Back Button Warning -->
    <div id="backButtonWarning" class="back-button-warning">
        <div class="flex items-center justify-center space-x-3">
            <span class="text-xl">‚ö†Ô∏è</span>
            <span class="font-bold">Warning: Do not use the back button during auction!</span>
            <button onclick="closeBackWarning()" class="ml-4 px-3 py-1 bg-white/20 rounded-lg hover:bg-white/30">
                Dismiss
            </button>
        </div>
    </div>
    
    <!-- Reconnection Overlay -->
    <div id="reconnectionOverlay" class="reconnection-overlay">
        <div class="connection-loader mb-6"></div>
        <h2 class="text-2xl font-bold mb-2 text-blue-400">Reconnecting...</h2>
        <p class="text-gray-300 mb-4">Please wait while we reconnect you to the auction</p>
        <p id="reconnectionTimer" class="text-gray-400 text-sm">Attempting in 5 seconds...</p>
        <button onclick="forceReconnect()" class="mt-4 px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-lg font-semibold">
            Reconnect Now
        </button>
    </div>

    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
                    Live Auction Pool
                </h1>
                <div id="teamHeader" class="flex items-center justify-center md:justify-start space-x-3">
                    <!-- Team info will be loaded -->
                </div>
                <div class="flex items-center space-x-2 mt-2">
                    <div id="syncStatus" class="text-xs sync-status synced flex items-center space-x-1">
                        <span class="w-2 h-2 rounded-full bg-green-500"></span>
                        <span>State Synced</span>
                    </div>
                    <button id="manualSyncBtn" class="text-xs text-gray-400 hover:text-yellow-400 px-2 py-1 bg-gray-800/50 rounded-lg transition-colors">
                        üîÑ Sync Now
                    </button>
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row items-center gap-4">
                <!-- Auction Status -->
                <div class="bg-gradient-to-r from-blue-900/30 to-purple-900/30 rounded-xl p-4 text-center min-w-[140px]">
                    <div class="text-sm text-gray-300 mb-1">AUCTION STATUS</div>
                    <div id="auctionStatus" class="text-2xl font-bold text-yellow-400 pulse-animation">LIVE</div>
                    <div class="text-xs text-gray-400">Auctioneer Controlled</div>
                </div>
                
                <!-- Purse -->
                <div class="bg-gradient-to-r from-green-900/30 to-emerald-900/30 rounded-xl p-4 text-center min-w-[140px]">
                    <div class="text-sm text-gray-300 mb-1">TEAM PURSE</div>
                    <div class="text-2xl font-bold text-green-400">‚Çπ<span id="purseRemaining">100</span> Cr</div>
                    <div class="text-xs text-gray-400">Remaining</div>
                </div>
                
                <!-- Squad Button -->
                <button id="viewSquadBtn" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-semibold hover:scale-105 transition-transform">
                    üë• View Squad
                </button>
                <!-- ADD THIS DEBUG BUTTON -->
    <button id="debugRedirectBtn" 
            onclick="redirectToPlaying11Fallback()" 
            class="px-4 py-2 bg-gradient-to-r from-red-500 to-orange-500 rounded-lg font-semibold text-sm hidden"
            title="Manual redirect to Playing 11">
        üîß Debug Redirect
    </button>
            </div>
            <!-- Add this button for debugging -->
<button onclick="redirectToPlaying11Fallback()" 
        class="px-4 py-2 bg-gradient-to-r from-red-500 to-orange-500 rounded-lg font-semibold text-sm hidden"
        id="debugRedirectBtn">
    üîß Debug Redirect
</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left: Current Player & Bidding -->
            <div class="lg:col-span-2">
                <!-- Current Player Card -->
                <div id="currentPlayerCard" class="glass-panel rounded-2xl p-6 slide-in hidden">
                    <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
                        <!-- Player Image -->
                        <div class="w-48 h-48 rounded-xl bg-gray-800/50 flex items-center justify-center overflow-hidden relative">
                            <div id="playerImage" class="w-full h-full bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center">
                                <span class="text-5xl">üèè</span>
                            </div>
                            <div id="playerOverseasBadge" class="overseas-badge hidden">
                                ‚úàÔ∏è Overseas
                            </div>
                        </div>
                        
                        <!-- Player Details -->
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h2 id="playerName" class="text-3xl font-bold mb-1">Player Name</h2>
                                    <div class="flex items-center space-x-3 mb-3">
                                        <span id="playerRole" class="role-badge role-bat">BAT</span>
                                        <span id="playerType" class="px-3 py-1 bg-purple-900/30 text-purple-300 rounded-lg">Type</span>
                                        <span id="playerNationality" class="px-3 py-1 bg-yellow-900/30 text-yellow-300 rounded-lg">Nationality</span>
                                    </div>
                                    <div class="text-sm text-gray-400 mb-2">
                                        Original Team: <span id="originalTeamName" class="text-yellow-300">-</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-yellow-400 mb-1">Current Bid</div>
                                    <div id="currentBid" class="text-4xl font-black">‚Çπ0 Cr</div>
                                    <div id="highestBidder" class="text-lg text-gray-300 mt-2">No bids yet</div>
                                </div>
                            </div>
                            
                            <!-- Base Price -->
                            <div class="mb-6">
                                <div class="text-sm text-gray-400">Base Price: <span id="basePrice" class="text-yellow-300 font-bold">‚Çπ2 Cr</span></div>
                            </div>
                            
                            <!-- Show Stats Button -->
                            <button id="showStatsBtn" 
                                    class="w-full py-3 bg-gradient-to-r from-blue-900/30 to-cyan-900/30 hover:from-blue-900/50 hover:to-cyan-900/50 rounded-xl font-semibold mb-4 transition-all duration-300">
                                üìä Show Full Player Stats
                            </button>
                            
                            <!-- Stats Grid (Hidden by default) -->
                            <div id="playerStats" class="hidden slide-in">
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <div class="stat-label">Total Runs</div>
                                        <div id="statRuns" class="stat-value">0</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-label">Highest Score</div>
                                        <div id="statHighestScore" class="stat-value">0</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-label">Strike Rate</div>
                                        <div id="statStrikeRate" class="stat-value">0</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-label">Wickets</div>
                                        <div id="statWickets" class="stat-value">0</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-label">Economy Rate</div>
                                        <div id="statEconomy" class="stat-value">0</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-label">Best Bowling</div>
                                        <div id="statBestBowling" class="stat-value">0/0</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-label">4's</div>
                                        <div id="statFours" class="stat-value">0</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-label">6's</div>
                                        <div id="statSixes" class="stat-value">0</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-label">50's</div>
                                        <div id="statFifties" class="stat-value">0</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-label">100's</div>
                                        <div id="statHundreds" class="stat-value">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bidding Controls -->
                            <div id="biddingControls" class="space-y-4 mt-6 hidden">
                                <div class="text-sm text-gray-400">
                                    Minimum bid increment: <span id="minIncrement" class="text-yellow-400">‚Çπ0.10 Cr</span>
                                </div>
                                
                                <div class="flex flex-wrap gap-3">
                                    <button class="bid-btn px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-xl font-semibold transition-all duration-300" 
                                            data-increment="0.1">
                                        +‚Çπ0.1 Cr
                                    </button>
                                    <button class="bid-btn px-4 py-3 bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 rounded-xl font-semibold transition-all duration-300" 
                                            data-increment="0.25">
                                        +‚Çπ0.25 Cr
                                    </button>
                                    <button class="bid-btn px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 rounded-xl font-semibold transition-all duration-300" 
                                            data-increment="0.5">
                                        +‚Çπ0.5 Cr
                                    </button>
                                    <button class="bid-btn px-4 py-3 bg-gradient-to-r from-red-500 to-orange-600 hover:from-red-600 hover:to-orange-700 rounded-xl font-semibold transition-all duration-300" 
                                            data-increment="1">
                                        +‚Çπ1 Cr
                                    </button>
                                </div>                           
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Waiting for Auction -->
                <div id="waitingAuction" class="glass-panel rounded-2xl p-12 text-center">
                    <div class="text-6xl mb-4">‚è≥</div>
                    <h3 class="text-2xl font-bold text-gray-300 mb-2">Waiting for Auction to Start</h3>
                    <p class="text-gray-500">The auctioneer will begin the auction pool shortly...</p>
                    <div class="mt-6 flex items-center justify-center space-x-2">
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                    </div>
                </div>
            </div>

            <!-- Right: Bid Log & Info -->
            <div class="space-y-6">
                <!-- Auction Info -->
                <div class="glass-panel rounded-2xl p-6 slide-in">
                    <h3 class="text-xl font-bold text-yellow-400 mb-4">Auction Status</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Category:</span>
                            <span id="auctionCategory" class="font-semibold">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Players Left:</span>
                            <span id="playersLeft" class="font-semibold">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Unsold Players:</span>
                            <span id="unsoldCount" class="font-semibold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Current Player:</span>
                            <span id="currentPlayerCount" class="font-semibold">0/0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Live Bid Log -->
                <div class="glass-panel rounded-2xl p-6 slide-in">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-yellow-400">Live Bid Log</h3>
                        <button id="clearLogBtn" class="text-xs text-gray-400 hover:text-gray-300 px-3 py-1 bg-gray-800/50 rounded-lg">
                            Clear
                        </button>
                    </div>
                    <div id="bidLog" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                        <!-- Bid messages will appear here -->
                        <div class="text-center text-gray-500 py-4">No bids yet</div>
                    </div>
                </div>
                
                <!-- Squad Status -->
                <div class="glass-panel rounded-2xl p-6 slide-in">
                    <h3 class="text-xl font-bold text-yellow-400 mb-4">Squad Status</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gradient-to-r from-green-900/30 to-emerald-900/30 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-green-400" id="squadSize">0</div>
                            <div class="text-sm text-gray-400">Squad Size</div>
                            <div class="text-xs text-gray-500">Max: <span id="maxSquad">25</span></div>
                        </div>
                        <div class="bg-gradient-to-r from-blue-900/30 to-cyan-900/30 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-400" id="remainingSlots">25</div>
                            <div class="text-sm text-gray-400">Remaining Slots</div>
                            <div class="text-xs text-gray-500">Can buy: <span id="canBuy">25</span> more</div>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div class="bg-gradient-to-r from-green-900/20 to-emerald-900/20 p-2 rounded-lg text-center">
                            <div class="text-sm font-bold text-green-400" id="indianCount">0</div>
                            <div class="text-xs text-gray-400">Indian</div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-900/20 to-pink-900/20 p-2 rounded-lg text-center">
                            <div class="text-sm font-bold text-purple-400" id="overseasCount">0</div>
                            <div class="text-xs text-gray-400">Overseas</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Check Modal -->
    <div id="sessionCheckModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black/80"></div>
        <div class="glass-panel rounded-2xl p-6 max-w-md w-11/12 z-10">
            <div class="text-center">
                <div class="text-4xl mb-4">üîê</div>
                <h3 class="text-2xl font-bold mb-2">Session Required</h3>
                <p class="text-gray-300 mb-6">You need a valid session to join the auction pool.</p>
                <div class="space-y-3">
                    <button onclick="reconnectWithSession()" 
                            class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-xl font-semibold transition-all duration-300">
                        Reconnect with Existing Session
                    </button>
                    <button onclick="goToLogin()" 
                            class="w-full py-3 bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 rounded-xl font-semibold transition-all duration-300">
                        Go to Login Page
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Toast -->
    <div id="alertToast" class="fixed top-4 right-4 glass-panel rounded-xl p-4 max-w-md z-50 hidden slide-in">
        <div class="flex items-start space-x-3">
            <div class="text-2xl" id="alertIcon">‚ö†Ô∏è</div>
            <div>
                <h4 class="font-bold text-lg" id="alertTitle">Alert</h4>
                <p class="text-gray-300" id="alertMessage">This is an alert message</p>
            </div>
            <button onclick="closeAlert()" class="text-gray-400 hover:text-white">‚úï</button>
        </div>
    </div>

    <script>
        // ========== GLOBAL VARIABLES ==========
        let socket = io(window.BACKEND_URL,{ transports: ["websocket", "polling"],}
);


        let auctionData = null;
        let currentPlayer = null;
        let currentUsername = null;
        let currentRoomCode = null;
        let userTeam = null;
        let teamBudget = 100;
        let squadLimits = { 
            indian: 0, 
            overseas: 0, 
            total: 0,
            maxSquad: 25
        };
        let userSession = null;
        let lastSyncTime = null;
        let syncRetryCount = 0;
        const MAX_SYNC_RETRIES = 3;
        let reconnectTimer = null;
        let reconnectCount = 0;
        let isPageVisible = true;
        let isBackButtonWarningShown = false;
        let countdownInterval = null; // Add this line

        // ========== DOM ELEMENTS ==========
        const teamHeader = document.getElementById('teamHeader');
        const purseRemaining = document.getElementById('purseRemaining');
        const viewSquadBtn = document.getElementById('viewSquadBtn');
        const currentPlayerCard = document.getElementById('currentPlayerCard');
        const waitingAuction = document.getElementById('waitingAuction');
        const playerName = document.getElementById('playerName');
        const playerRole = document.getElementById('playerRole');
        const playerType = document.getElementById('playerType');
        const playerNationality = document.getElementById('playerNationality');
        const originalTeamName = document.getElementById('originalTeamName');
        const currentBid = document.getElementById('currentBid');
        const highestBidder = document.getElementById('highestBidder');
        const basePrice = document.getElementById('basePrice');
        const playerOverseasBadge = document.getElementById('playerOverseasBadge');
        const showStatsBtn = document.getElementById('showStatsBtn');
        const playerStats = document.getElementById('playerStats');
        const biddingControls = document.getElementById('biddingControls');
        const auctionCategory = document.getElementById('auctionCategory');
        const playersLeft = document.getElementById('playersLeft');
        const unsoldCount = document.getElementById('unsoldCount');
        const bidLog = document.getElementById('bidLog');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const squadSize = document.getElementById('squadSize');
        const maxSquad = document.getElementById('maxSquad');
        const remainingSlots = document.getElementById('remainingSlots');
        const canBuy = document.getElementById('canBuy');
        const indianCount = document.getElementById('indianCount');
        const overseasCount = document.getElementById('overseasCount');
        const sessionCheckModal = document.getElementById('sessionCheckModal');
        const minIncrement = document.getElementById('minIncrement');
        const syncStatus = document.getElementById('syncStatus');
        const manualSyncBtn = document.getElementById('manualSyncBtn');
        const currentPlayerCount = document.getElementById('currentPlayerCount');
        const reconnectionOverlay = document.getElementById('reconnectionOverlay');
        const reconnectionTimer = document.getElementById('reconnectionTimer');
        const backButtonWarning = document.getElementById('backButtonWarning');

        // ========== PAGE VISIBILITY & BACK BUTTON PROTECTION ==========
        function setupPageProtection() {
            // 1. Warn user if they try to leave the page
            window.addEventListener('beforeunload', function(e) {
                if (socket && socket.connected) {
                    const confirmationMessage = '‚ö†Ô∏è Are you sure you want to leave the auction? You may lose your connection!';
                    e.returnValue = confirmationMessage;
                    return confirmationMessage;
                }
            });
            
            // 2. Detect page visibility changes (tab switching)
            document.addEventListener('visibilitychange', function() {
                isPageVisible = !document.hidden;
                
                if (isPageVisible) {
                    // Page is now visible again - try to reconnect
                    console.log('üîÑ Page is now visible, checking connection...');
                    checkConnectionAndReconnect();
                } else {
                    // Page is hidden - user switched tabs
                    console.log('‚ö†Ô∏è Page hidden - user switched tabs');
                }
            });
            
            // 3. Detect back button navigation
            window.addEventListener('popstate', function(event) {
                if (!isBackButtonWarningShown) {
                    showBackButtonWarning();
                    isBackButtonWarningShown = true;
                    
                    // Push state to prevent going back
                    history.pushState(null, null, window.location.pathname);
                    
                    // Hide warning after 5 seconds
                    setTimeout(() => {
                        hideBackButtonWarning();
                        isBackButtonWarningShown = false;
                    }, 5000);
                }
            });
            
            // 4. Push initial state
            history.pushState(null, null, window.location.pathname);
            
            console.log('‚úÖ Page protection initialized');
        }
        
        function showBackButtonWarning() {
            backButtonWarning.classList.add('show');
        }
        
        function hideBackButtonWarning() {
            backButtonWarning.classList.remove('show');
        }
        
        function closeBackWarning() {
            hideBackButtonWarning();
            isBackButtonWarningShown = false;
        }
        
        function checkConnectionAndReconnect() {
            if (socket && !socket.connected) {
                console.log('üîÑ Connection lost, attempting to reconnect...');
                showReconnectionOverlay();
                startReconnectionTimer();
            } else if (socket && socket.connected) {
                // Still connected, request state sync
                requestStateSync();
            }
        }

        // ========== RECONNECTION SYSTEM ==========
        function showReconnectionOverlay() {
            reconnectionOverlay.classList.add('show');
            reconnectCount = 0;
            updateReconnectionTimer(5);
        }
        
        function hideReconnectionOverlay() {
            reconnectionOverlay.classList.remove('show');
            if (reconnectTimer) {
                clearInterval(reconnectTimer);
                reconnectTimer = null;
            }
        }
        
        function updateReconnectionTimer(seconds) {
            reconnectionTimer.textContent = `Attempting in ${seconds} seconds...`;
        }
        
        function startReconnectionTimer() {
            let seconds = 5;
            
            if (reconnectTimer) {
                clearInterval(reconnectTimer);
            }
            
            reconnectTimer = setInterval(() => {
                seconds--;
                updateReconnectionTimer(seconds);
                
                if (seconds <= 0) {
                    clearInterval(reconnectTimer);
                    forceReconnect();
                }
            }, 1000);
        }
        
        function forceReconnect() {
            console.log('üöÄ Force reconnecting...');
            
            if (socket) {
                // Disconnect and reconnect
                socket.disconnect();
                socket.connect();
                
                // Show reconnection status
                updateSyncStatus('syncing', 'Reconnecting...');
                
                // Increment reconnect count
                reconnectCount++;
                
                if (reconnectCount > 3) {
                    showAlert('Connection Failed', 'Unable to reconnect. Please refresh the page.', '‚ùå');
                    hideReconnectionOverlay();
                }
            }
        }

        // ========== STATE SYNCHRONIZATION SYSTEM ==========
        function requestStateSync() {
            if (!socket || !socket.connected || !currentUsername || !currentRoomCode) {
                console.log('‚ùå Cannot sync: Missing connection or credentials');
                updateSyncStatus('error', 'Not connected');
                showReconnectionOverlay();
                return false;
            }
            
            console.log('üîÑ Requesting auction state sync...');
            updateSyncStatus('syncing', 'Syncing state...');
            
            // Save current state to localStorage before sync
            saveCurrentState();
            
            socket.emit('requestAuctionState', {
                roomCode: currentRoomCode,
                username: currentUsername,
                timestamp: Date.now()
            }, (response) => {
                if (response && response.success) {
                    console.log('‚úÖ State sync confirmed by server');
                    updateSyncStatus('synced', 'Live Auction State');
                    hideReconnectionOverlay();
                    
                    // Update last sync time
                    lastSyncTime = Date.now();
                    syncRetryCount = 0;
                } else {
                    console.log('‚ö†Ô∏è State sync not confirmed, retrying...');
                    setTimeout(requestStateSync, 2000);
                }
            });
            
            return true;
        }
        
        function saveCurrentState() {
            const state = {
                currentPlayer: currentPlayer,
                teamBudget: teamBudget,
                squadLimits: squadLimits,
                userTeam: userTeam,
                timestamp: Date.now()
            };
            
            localStorage.setItem('auctionStateBackup', JSON.stringify(state));
            console.log('üíæ Saved current state to localStorage');
        }
        
        function loadBackupState() {
            const backup = localStorage.getItem('auctionStateBackup');
            if (backup) {
                try {
                    const state = JSON.parse(backup);
                    console.log('üì• Loading backup state:', state);
                    
                    if (state.currentPlayer) {
                        currentPlayer = state.currentPlayer;
                        displayCurrentPlayer();
                    }
                    
                    if (state.teamBudget) {
                        teamBudget = state.teamBudget;
                        purseRemaining.textContent = teamBudget.toFixed(2);
                    }
                    
                    if (state.squadLimits) {
                        squadLimits = state.squadLimits;
                        updateSquadLimits();
                    }
                    
                    if (state.userTeam) {
                        userTeam = state.userTeam;
                        displayTeamInfo();
                    }
                    
                    return true;
                } catch (error) {
                    console.error('‚ùå Error loading backup state:', error);
                    return false;
                }
            }
            return false;
        }
        
        function updateSyncStatus(status, message = '') {
            const dot = syncStatus.querySelector('.w-2');
            const text = syncStatus.querySelector('span:last-child');
            
            syncStatus.className = `text-xs sync-status ${status} flex items-center space-x-1`;
            
            switch(status) {
                case 'syncing':
                    dot.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
                    text.textContent = message || 'Syncing...';
                    break;
                case 'synced':
                    dot.className = 'w-2 h-2 rounded-full bg-green-500';
                    text.textContent = message || `State Synced ${lastSyncTime ? `at ${new Date(lastSyncTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` : ''}`;
                    break;
                case 'error':
                    dot.className = 'w-2 h-2 rounded-full bg-red-500';
                    text.textContent = message || 'Sync Failed';
                    break;
            }
        }
        
        function handleStateSync(data) {
            console.log('‚úÖ Received state sync:', data);
            
            lastSyncTime = Date.now();
            syncRetryCount = 0;
            
            if (!data.isAuctionActive) {
                console.log('‚ö†Ô∏è Auction not active yet');
                waitingAuction.classList.remove('hidden');
                currentPlayerCard.classList.add('hidden');
                biddingControls.classList.add('hidden');
                updateSyncStatus('synced', 'Waiting for auction start');
                return;
            }
            
            // Update auction info
            if (data.category) auctionCategory.textContent = data.category;
            if (data.playersLeft !== undefined) playersLeft.textContent = data.playersLeft;
            if (data.unsoldCount !== undefined) unsoldCount.textContent = data.unsoldCount;
            if (data.playerPosition) currentPlayerCount.textContent = data.playerPosition;
            
            // If we have a current player, display it
            if (data.currentPlayer) {
                console.log('üéØ Syncing current player:', data.currentPlayer.name);
                currentPlayer = data.currentPlayer;
                waitingAuction.classList.add('hidden');
                currentPlayerCard.classList.remove('hidden');
                displayCurrentPlayer();
                biddingControls.classList.remove('hidden');
                updateBidButtons();
                
                // Reset stats display
                playerStats.classList.add('hidden');
                currentPlayerCard.classList.remove('expanded');
                showStatsBtn.innerHTML = 'üìä Show Full Player Stats';
                
                updateBidIncrement(data.currentPlayer.currentBid || data.currentPlayer.basePrice || 2);
            } else {
                console.log('‚ö†Ô∏è No current player in state sync');
                waitingAuction.classList.remove('hidden');
                currentPlayerCard.classList.add('hidden');
                biddingControls.classList.add('hidden');
            }
            
            updateSyncStatus('synced', 'State Synced');
        }
        
        function retryStateSync() {
            if (syncRetryCount >= MAX_SYNC_RETRIES) {
                console.log('‚ùå Max sync retries reached');
                updateSyncStatus('error', 'Sync failed. Please refresh.');
                showAlert('Connection Error', 'Unable to sync auction state. Please refresh the page.', '‚ùå');
                return;
            }
            
            syncRetryCount++;
            console.log(`üîÑ Retry ${syncRetryCount}/${MAX_SYNC_RETRIES}`);
            
            setTimeout(() => {
                if (socket && socket.connected) {
                    requestStateSync();
                }
            }, 1000 * syncRetryCount);
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üéØ Auction Pool loading with state sync...');
            
            // Setup page protection FIRST
            setupPageProtection();
            
            // Check for user session
            userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
            
            // ‚úÖ ADD: Check if we have force redirect data
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('forceRedirect') || !userSession.sessionId) {
                console.log('‚ö†Ô∏è No valid session or force redirect detected');
                showSessionCheckModal();
                return;
            }
            
            if (userSession.sessionId) {
                currentUsername = userSession.username;
                currentRoomCode = userSession.roomCode;
                userTeam = userSession.team;
                console.log('üîó Found existing session:', { currentUsername, currentRoomCode });
                
                // Load backup state while connecting
                loadBackupState();
                
                // Initialize socket
                initializeSocket();
                
                // Wait for socket connection
                const waitForSocket = () => {
                    return new Promise((resolve) => {
                        if (socket && socket.connected) {
                            resolve();
                        } else {
                            const checkInterval = setInterval(() => {
                                if (socket && socket.connected) {
                                    clearInterval(checkInterval);
                                    resolve();
                                }
                            }, 100);
                        }
                    });
                };
                
                try {
                    await waitForSocket();
                    console.log('‚úÖ Socket connected, setting up event listeners');
                } catch (error) {
                    console.error('‚ùå Failed to connect socket:', error);
                }
            } else {
                console.log('‚ùå No session found');
                showSessionCheckModal();
                return;
            }
            
            // Setup event listeners
            clearLogBtn.addEventListener('click', clearBidLog);
            viewSquadBtn.addEventListener('click', openSquadModal);
            showStatsBtn.addEventListener('click', toggleStats);
            manualSyncBtn.addEventListener('click', () => {
                if (socket && socket.connected) {
                    requestStateSync();
                }
            });
            
            // Bid button delegation
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('bid-btn')) {
                    console.log('üéØ Bid button clicked:', e.target);
                    const increment = parseFloat(e.target.dataset.increment);
                    
                    if (isNaN(increment)) {
                        console.error('‚ùå Invalid bid increment');
                        return;
                    }
                    
                    placeBid(increment);
                }
            });
            
            document.addEventListener('click', function(e) {
                const bidButton = e.target.closest('.bid-btn');
                if (bidButton) {
                    console.log('üéØ Bid button (nested) clicked');
                    const increment = parseFloat(bidButton.dataset.increment);
                    
                    if (isNaN(increment)) {
                        console.error('‚ùå Invalid bid increment');
                        return;
                    }
                    
                    placeBid(increment);
                }
            });
            
            // Setup periodic sync (every 30 seconds as backup)
            setInterval(() => {
                if (socket && socket.connected && lastSyncTime) {
                    const timeSinceLastSync = Date.now() - lastSyncTime;
                    if (timeSinceLastSync > 30000) {
                        console.log('üîÑ Periodic state sync check');
                        requestStateSync();
                    }
                }
            }, 30000);
        });

        // ========== SESSION FUNCTIONS ==========
        function showSessionCheckModal() {
            sessionCheckModal.classList.remove('hidden');
        }

        function reconnectWithSession() {
            userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
            
            if (userSession.sessionId) {
                currentUsername = userSession.username;
                currentRoomCode = userSession.roomCode;
                userTeam = userSession.team;
                
                sessionCheckModal.classList.add('hidden');
                initializeSocket();
            } else {
                showAlert('No Session Found', 'Please go to the login page to reconnect.', '‚ùå');
            }
        }

        function goToLogin() {
            window.location.href = 'login.html';
        }

        // ========== SOCKET FUNCTIONS ==========
        function initializeSocket() {
            console.log('üîå Connecting to socket server with state sync...');
            socket = io(window.BACKEND_URL,{ transports: ["websocket", "polling"],}
        );
            
            socket.on('connect', () => {
                console.log('‚úÖ Connected to auction pool');
                updateSyncStatus('syncing', 'Connecting...');
                hideReconnectionOverlay();
                
                // Join auction pool with session
                socket.emit('joinAuctionPool', {
                    roomCode: currentRoomCode,
                    username: currentUsername,
                    sessionId: userSession.sessionId
                });
                
                // Request initial state sync after join
                setTimeout(() => {
                    requestStateSync();
                }, 500);
            });
            
            socket.on('connect_error', (error) => {
                console.error('‚ùå Connection error:', error);
                updateSyncStatus('error', 'Connection failed');
                showReconnectionOverlay();
            });
            
            socket.on('reconnect', (attemptNumber) => {
                console.log(`üîå Reconnected (attempt ${attemptNumber})`);
                updateSyncStatus('syncing', 'Reconnecting...');
                
                // Re-join auction pool and sync state
                socket.emit('joinAuctionPool', {
                    roomCode: currentRoomCode,
                    username: currentUsername,
                    sessionId: userSession.sessionId
                });
                
                setTimeout(() => {
                    requestStateSync();
                }, 1000);
            });
            
            socket.on('disconnect', (reason) => {
                console.log('‚ö†Ô∏è Disconnected:', reason);
                updateSyncStatus('error', 'Disconnected');
                showReconnectionOverlay();
            });
            
            // ========== STATE SYNC HANDLER ==========
            socket.on('auctionStateSync', (data) => {
                console.log('üîÑ Received auction state sync:', data);
                handleStateSync(data);
            });
            
            socket.on('auctionData', (data) => {
                console.log('üéØ Received auction data:', data);
                auctionData = data;
                userTeam = data.team || userTeam;
                teamBudget = data.purse || 100;
                squadLimits = data.squadLimits || squadLimits;
                
                // Update UI
                initializePage();
                updateSquadLimits();
                
                // Request state sync after getting auction data
                requestStateSync();
            });
            
            socket.on('playerUpForAuction', (data) => {
                console.log('üë§ Player up for auction:', data);
                currentPlayer = data.player;
                
                if (waitingAuction) {
                    waitingAuction.classList.add('hidden');
                }
                if (currentPlayerCard) {
                    currentPlayerCard.classList.remove('hidden');
                }
                
                displayCurrentPlayer();
                
                if (biddingControls) {
                    biddingControls.classList.remove('hidden');
                }
                
                updateBidButtons();
                
                // Reset stats display
                if (playerStats) {
                    playerStats.classList.add('hidden');
                }
                if (currentPlayerCard) {
                    currentPlayerCard.classList.remove('expanded');
                }
                if (showStatsBtn) {
                    showStatsBtn.innerHTML = 'üìä Show Full Player Stats';
                }
                
                updateBidIncrement(currentPlayer.currentBid || currentPlayer.basePrice || 2);
                
                updateSyncStatus('synced', 'Live Auction');
                
                // Save state
                saveCurrentState();
            });
            
            socket.on('bidUpdate', (data) => {
                console.log('üí∞ Bid update:', data);
                
                // Update current player data
                if (currentPlayer && currentPlayer.id === data.playerId) {
                    currentPlayer.currentBid = data.bid;
                    currentPlayer.currentBidder = data.team;
                    
                    // Update UI
                    currentBid.textContent = `‚Çπ${data.bid} Cr`;
                    currentBid.classList.add('bounce');
                    setTimeout(() => currentBid.classList.remove('bounce'), 500);
                    
                    if (data.team) {
                        highestBidder.textContent = data.team.toUpperCase();
                        const teamColors = {
                            'csk': '#FFCC00', 'mi': '#0048A0', 'rcb': '#D5152C',
                            'kkr': '#3A225D', 'dc': '#004C93', 'pbks': '#ED1B24',
                            'rr': '#FF4C93', 'srh': '#FF6F3D', 'gt': '#1E2D4A', 'lsg': '#A5E1F4'
                        };
                        highestBidder.style.color = teamColors[data.team] || '#FFFFFF';
                    }
                    
                    updateBidIncrement(data.bid);
                }
                
                // Add to bid log
                addBidToLog(data.team, data.bid);
                
                // Save state
                saveCurrentState();
            });
            
            socket.on('playerSold', (data) => {
                console.log('‚úÖ Player sold:', data);
                showSoldBroadcast(data.player, data.team, data.price);
                
                // Add to bid log
                const soldItem = document.createElement('div');
                soldItem.className = 'p-3 rounded-lg bg-green-900/30 border-l-4 border-green-500 slide-in';
                soldItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-bold">${data.player}</span>
                            <span class="text-gray-400 ml-2">‚Üí ${data.team.toUpperCase()}</span>
                        </div>
                        <span class="font-bold text-green-400">‚Çπ${data.price} Cr</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">SOLD at ${new Date().toLocaleTimeString()}</div>
                `;
                bidLog.prepend(soldItem);
                
                // Update squad if it's our team
                if (data.team === userTeam?.id) {
                    teamBudget -= data.price;
                    purseRemaining.textContent = teamBudget.toFixed(2);
                    
                    if (data.isOverseas) {
                        squadLimits.overseas++;
                    } else {
                        squadLimits.indian++;
                    }
                    squadLimits.total = squadLimits.indian + squadLimits.overseas;
                    
                    updateSquadLimits();
                    
                    socket.emit('requestSquadUpdate', {
                        roomCode: currentRoomCode,
                        username: currentUsername,
                        sessionId: userSession.sessionId
                    });
                }
                
                // Clear current player after delay
                setTimeout(() => {
                    currentPlayerCard.classList.add('hidden');
                    waitingAuction.classList.remove('hidden');
                    biddingControls.classList.add('hidden');
                    currentPlayer = null;
                    
                    // Save cleared state
                    saveCurrentState();
                    
                    // Request fresh state sync after player sold
                    setTimeout(() => {
                        requestStateSync();
                    }, 1000);
                }, 3000);
            });
            
            socket.on('playerUnsoldBroadcast', (data) => {
                console.log('‚ùå Player unsold popup received:', data);
                showUnsoldPopup(data.player);
            });
            
            socket.on('playerUnsold', (data) => {
                console.log('‚ùå Player unsold:', data);
                
                const unsoldItem = document.createElement('div');
                unsoldItem.className = 'p-3 rounded-lg bg-red-900/30 border-l-4 border-red-500 slide-in';
                unsoldItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold">${data.player}</span>
                        <span class="font-bold text-red-400">UNSOLD</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">${new Date().toLocaleTimeString()}</div>
                `;
                bidLog.prepend(unsoldItem);
                
                // Clear current player after delay
                setTimeout(() => {
                    currentPlayerCard.classList.add('hidden');
                    waitingAuction.classList.remove('hidden');
                    biddingControls.classList.add('hidden');
                    currentPlayer = null;
                    
                    // Save cleared state
                    saveCurrentState();
                    
                    // Request fresh state sync after player unsold
                    setTimeout(() => {
                        requestStateSync();
                    }, 1000);
                }, 3000);
            });
            
            socket.on('auctionUpdate', (data) => {
                console.log('üìä Auction update:', data);
                updateAuctionStatus(data);
            });
            
            socket.on('storePlaying11Data', (data) => {
                console.log('üíæ Storing playing 11 data:', data);
                localStorage.setItem('playing11SquadData', JSON.stringify(data.squadData));
                localStorage.setItem('userSession', JSON.stringify({
                    username: data.username,
                    roomCode: data.roomCode,
                    team: data.squadData.team,
                    sessionId: data.squadData.sessionId
                }));
            });
            
            socket.on('squadUpdate', (data) => {
                console.log('üë• Squad update:', data);
                updateSquadDisplay(data);
            });
            
            socket.on('auctionComplete', (data) => {
    console.log('üèÜ Auction complete:', data);
    
    // ‚úÖ FIXED: Store COMPLETE squad data before redirecting
    const completeSquadData = {
        roomCode: currentRoomCode,
        username: currentUsername,
        team: userTeam,
        budget: teamBudget,
        squadLimits: squadLimits,
        // Get retained players from localStorage
        retainedPlayers: JSON.parse(localStorage.getItem('retainedPlayers') || '[]'),
        // Get auction buys from localStorage or current data
        auctionPlayers: getCurrentAuctionBuys(),
        totalBudget: 100,
        totalSpent: calculateTotalSpent(),
        remainingBudget: teamBudget,
        timestamp: Date.now()
    };
    
    // Store in localStorage for playing11.html
    localStorage.setItem('playing11SquadData', JSON.stringify(completeSquadData));
    localStorage.setItem('auctionCompleted', 'true');
    
    // Show completion message
    showAlert('Auction Complete', 'All players have been auctioned! Redirecting to Playing 11 selection...', 'üèÜ');
    
    // Add to bid log
    addBidToLog('SYSTEM', 'Auction pool completed!', 'COMPLETE');
    
    // Disable all buttons
    document.querySelectorAll('button').forEach(btn => btn.disabled = true);
    
    // Show redirecting message
    waitingAuction.classList.remove('hidden');
    waitingAuction.innerHTML = `
        <div class="text-6xl mb-4">üéâ</div>
        <h3 class="text-2xl font-bold text-green-400 mb-2">Auction Completed!</h3>
        <p class="text-gray-300 mb-4">${data.message || 'Redirecting to Playing 11 selection...'}</p>
        <div class="mobile-loader mx-auto my-4"></div>
        <p class="text-gray-500">Loading your squad data...</p>
        <div class="mt-6 flex items-center justify-center space-x-2">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
        </div>
    `;
    playerInfo.classList.add('hidden');
    
    // Wait 3 seconds to ensure data is saved, then redirect
    setTimeout(() => {
        console.log('üîó Redirecting user to playing11.html with squad data');
        window.location.href = 'playing11.html';
    }, 3000);
});

// ‚úÖ ADD THESE HELPER FUNCTIONS IN auctionpool.html
function getCurrentAuctionBuys() {
    // Try to get auction buys from localStorage
    const auctionBuys = JSON.parse(localStorage.getItem('auctionBuys') || '[]');
    
    // If empty, create from current squad data
    if (auctionBuys.length === 0 && squadLimits.total > 0) {
        return [{
            name: 'Player 1',
            role: 'Batsman',
            price: 2.00,
            isOverseas: false
        }]; // Default fallback
    }
    
    return auctionBuys;
}

function calculateTotalSpent() {
    const auctionBuys = getCurrentAuctionBuys();
    return auctionBuys.reduce((total, player) => total + (player.price || 0), 0);
}
            
            socket.on('forceRedirectToPlaying11', (data) => {
                console.log('üöÄ Force redirect received:', data);
                
                const currentData = {
                    roomCode: currentRoomCode,
                    username: currentUsername,
                    team: userTeam,
                    budget: teamBudget,
                    squadLimits: squadLimits
                };
                
                localStorage.setItem('auctionToPlaying11Data', JSON.stringify(currentData));
                
                showAlert('Auction Complete', 'Redirecting to Playing 11 selection...', 'üèè');
                
                setTimeout(() => {
                    window.location.href = data.url;
                }, 1000);
            });

            // ‚úÖ ADD THIS HANDLER for receiving squad data before redirect
socket.on('preparePlaying11Squad', (data) => {
    console.log('üíæ Preparing squad data for playing 11:', data);
    
    if (data.squadData) {
        // Store complete squad data for playing11.html
        localStorage.setItem('playing11SquadData', JSON.stringify(data.squadData));
        
        // Also store in user session
        localStorage.setItem('userSession', JSON.stringify({
            username: currentUsername,
            roomCode: currentRoomCode,
            team: userTeam,
            sessionId: userSession.sessionId,
            squadData: data.squadData
        }));
        
        console.log('‚úÖ Squad data stored for playing 11:', {
            retained: data.squadData.retainedPlayers?.length || 0,
            auction: data.squadData.auctionPlayers?.length || 0,
            total: (data.squadData.retainedPlayers?.length || 0) + (data.squadData.auctionPlayers?.length || 0)
        });
    }
});

// ‚úÖ ADD THIS HANDLER for redirect with squad data
socket.on('redirectToPlaying11WithSquad', (data) => {
    console.log('üöÄ Redirecting to playing 11 with squad data:', data);
    
    // Show redirect message
    showAlert('Auction Complete', 'All players auctioned! Redirecting to Playing 11 selection...', 'üèÜ');
    
    // Update UI to show redirecting
    waitingAuction.classList.remove('hidden');
    waitingAuction.innerHTML = `
        <div class="text-6xl mb-4">üéâ</div>
        <h3 class="text-2xl font-bold text-green-400 mb-2">Auction Completed!</h3>
        <p class="text-gray-300 mb-4">${data.message || 'Redirecting to Playing 11 selection...'}</p>
        <p class="text-yellow-400 mb-4">Finalizing your squad data...</p>
        <p class="text-gray-500">You have been assigned: ${data.squadData ? 
            `${(data.squadData.retainedPlayers?.length || 0) + (data.squadData.auctionPlayers?.length || 0)} players` : 
            'Your squad'} 
        </p>
        <div class="mt-6 flex items-center justify-center space-x-2">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
        </div>
    `;
    
    // Hide current player
    currentPlayerCard.classList.add('hidden');
    biddingControls.classList.add('hidden');
    
    // Disable all buttons
    document.querySelectorAll('button').forEach(btn => btn.disabled = true);
    
    // Mark auction as completed
    localStorage.setItem('auctionCompleted', 'true');
    
    // Redirect after delay
    setTimeout(() => {
        console.log('üîó Redirecting to playing11.html');
        window.location.href = 'playing11.html';
    }, 3000);
});
            
            socket.on('bidError', (data) => {
                console.error('‚ùå Bid error:', data);
                showAlert('Bid Error', data.message, '‚ùå');
            });
            
            socket.on('error', (data) => {
                console.error('‚ùå Auction error:', data);
                showAlert('Error', data.message, '‚ùå');
            });

            // ‚úÖ ADD THIS FORCE REDIRECT HANDLER
// ‚úÖ ADD THIS FORCE REDIRECT HANDLER (AFTER YOUR OTHER SOCKET HANDLERS)
// ‚úÖ FIXED: Force redirect with squad data
// ‚úÖ ROBUST REDIRECT HANDLER
socket.on('forceRedirectToPlaying11WithData', (data) => {
    console.log('üöÄ FORCE REDIRECT RECEIVED:', data);
    
    try {
        // Store whatever data we have
        if (data.squadData) {
            localStorage.setItem('playing11SquadData', JSON.stringify(data.squadData));
            console.log('‚úÖ Stored server squad data');
        } else {
            // Create local squad data
            const localSquadData = {
                roomCode: currentRoomCode,
                username: currentUsername,
                team: userTeam,
                budget: teamBudget,
                retainedPlayers: JSON.parse(localStorage.getItem('retainedPlayers') || '[]'),
                auctionPlayers: JSON.parse(localStorage.getItem('auctionBuys') || '[]'),
                timestamp: Date.now()
            };
            localStorage.setItem('playing11SquadData', JSON.stringify(localSquadData));
            console.log('‚úÖ Created local squad data');
        }
        
        // Always mark as completed
        localStorage.setItem('auctionCompleted', 'true');
        
        // Update UI immediately
        const waitingAuction = document.getElementById('waitingAuction');
        const currentPlayerCard = document.getElementById('currentPlayerCard');
        const biddingControls = document.getElementById('biddingControls');
        
        if (waitingAuction) {
            waitingAuction.classList.remove('hidden');
            waitingAuction.innerHTML = `
                <div class="text-6xl mb-4">üéâ</div>
                <h3 class="text-2xl font-bold text-green-400 mb-2">Auction Complete!</h3>
                <p class="text-gray-300 mb-4">${data.message || 'Redirecting to Playing 11...'}</p>
                <div class="mt-6 flex items-center justify-center space-x-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                </div>
            `;
        }
        
        if (currentPlayerCard) currentPlayerCard.classList.add('hidden');
        if (biddingControls) biddingControls.classList.add('hidden');
        
        // Disable buttons
        document.querySelectorAll('button').forEach(btn => btn.disabled = true);
        
        // FORCE REDIRECT after 2 seconds
        setTimeout(() => {
            console.log('üîó FORCE REDIRECTING to playing11.html');
            window.location.href = 'playing11.html';
        }, 2000);
        
    } catch (error) {
        console.error('‚ùå Redirect error:', error);
        // Still try to redirect
        setTimeout(() => {
            window.location.href = 'playing11.html';
        }, 1000);
    }
});
// ‚úÖ ADD THESE HANDLERS in auctionpool.html (in setupSocketEvents or similar)
socket.on('auctionEndedForUsers', (data) => {
    console.log('üèÅ Auction ended for users:', data);
    
    // Mark auction as completed
    localStorage.setItem('auctionCompleted', 'true');
    
    // Store squad data for playing11
    if (data.squadData) {
        localStorage.setItem('playing11SquadData', JSON.stringify(data.squadData));
        console.log('üíæ Stored squad data for playing11:', data.squadData);
    }
    
    // Show redirect message
    const waitingAuction = document.getElementById('waitingAuction');
    if (waitingAuction) {
        waitingAuction.classList.remove('hidden');
        waitingAuction.innerHTML = `
            <div class="text-6xl mb-4">üéâ</div>
            <h3 class="text-2xl font-bold text-green-400 mb-2">Auction Completed!</h3>
            <p class="text-gray-300 mb-4">${data.message || 'All players have been auctioned!'}</p>
            <p class="text-yellow-400 mb-4">Preparing your squad data...</p>
            <p class="text-gray-500">Redirecting to Playing 11 selection...</p>
            <div class="mt-6 flex items-center justify-center space-x-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
            </div>
        `;
    }
    
    // Hide current player if showing
    currentPlayerCard.classList.add('hidden');
    biddingControls.classList.add('hidden');
    
    // Redirect after delay (give time for data to be stored)
    setTimeout(() => {
        console.log('üîó Redirecting user to playing11.html');
        
        // Also store user session
        localStorage.setItem('userSession', JSON.stringify({
            username: currentUsername,
            roomCode: currentRoomCode,
            team: userTeam,
            sessionId: userSession?.sessionId || Date.now().toString()
        }));
        
        // Redirect to playing11
        window.location.href = 'playing11.html';
    }, 2000);
});



// ‚úÖ ADD THIS ALTERNATIVE HANDLER (backup)
socket.on('forceRedirectToPlaying11', (data) => {
    console.log('üöÄ Force redirect received:', data);
    
    // Store current squad data
    const currentData = {
        roomCode: currentRoomCode,
        username: currentUsername,
        team: userTeam,
        budget: teamBudget,
        squadLimits: squadLimits,
        retainedPlayers: JSON.parse(localStorage.getItem('retainedPlayers') || '[]'),
        auctionPlayers: JSON.parse(localStorage.getItem('auctionBuys') || '[]')
    };
    
    localStorage.setItem('auctionToPlaying11Data', JSON.stringify(currentData));
    localStorage.setItem('auctionCompleted', 'true');
    
    // Show immediate redirect message
    const waitingAuction = document.getElementById('waitingAuction');
    if (waitingAuction) {
        waitingAuction.classList.remove('hidden');
        waitingAuction.innerHTML = `
            <div class="text-6xl mb-4">üöÄ</div>
            <h3 class="text-2xl font-bold text-green-400 mb-2">Auction Completed!</h3>
            <p class="text-gray-300 mb-4">${data.message || 'Redirecting to playing 11 selection...'}</p>
            <div class="mt-6 flex items-center justify-center space-x-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
            </div>
        `;
    }
    
    // Hide current player
    currentPlayerCard.classList.add('hidden');
    biddingControls.classList.add('hidden');
    
    // Redirect immediately
    setTimeout(() => {
        window.location.href = 'playing11.html';
    }, 1500);
});

// ‚úÖ SIMPLE REDIRECT HANDLER - ALWAYS WORKS
socket.on('simpleRedirectToPlaying11', (data) => {
    console.log('üîó Simple redirect received:', data);
    
    // Store minimal session data
    localStorage.setItem('userSession', JSON.stringify({
        username: currentUsername,
        roomCode: currentRoomCode,
        team: userTeam,
        sessionId: userSession?.sessionId || Date.now().toString()
    }));
    
    // Mark auction as completed
    localStorage.setItem('auctionCompleted', 'true');
    
    // Create simple squad data from current state
    const simpleSquadData = {
        roomCode: currentRoomCode,
        username: currentUsername,
        team: userTeam,
        budget: teamBudget,
        squadLimits: squadLimits,
        retainedPlayers: JSON.parse(localStorage.getItem('retainedPlayers') || '[]'),
        auctionPlayers: getCurrentAuctionBuys(),
        timestamp: Date.now()
    };
    
    localStorage.setItem('playing11SquadData', JSON.stringify(simpleSquadData));
    
    console.log('üíæ Stored squad data for redirect:', simpleSquadData);
    
    // Immediate redirect with simple message
    waitingAuction.classList.remove('hidden');
    waitingAuction.innerHTML = `
        <div class="text-6xl mb-4">üöÄ</div>
        <h3 class="text-2xl font-bold text-green-400 mb-2">Auction Complete!</h3>
        <p class="text-gray-300 mb-4">Redirecting to Playing 11 selection...</p>
        <p class="text-sm text-gray-500">Please wait...</p>
    `;
    
    // Hide everything else
    currentPlayerCard.classList.add('hidden');
    biddingControls.classList.add('hidden');
    
    // Redirect immediately
    setTimeout(() => {
        window.location.href = 'playing11.html';
    }, 1000);
});

        }

        // ========== PAGE FUNCTIONS ==========
        function initializePage() {
            console.log('üîÑ Initializing auction page...');
            
            if (!userTeam) {
                console.error('‚ùå No team data');
                showErrorState('No team assigned');
                return;
            }
            
            displayTeamInfo();
            purseRemaining.textContent = teamBudget.toFixed(2);
            maxSquad.textContent = squadLimits.maxSquad || 25;
            
            console.log('‚úÖ Auction page initialized');
        }
        
        function displayTeamInfo() {
            if (!userTeam) return;
            
            const teamLogos = {
                'csk': 'images/teams/CSK.png',
                'mi': 'images/teams/MI.png', 
                'rcb': 'images/teams/RCB.png',
                'kkr': 'images/teams/KKR.png',
                'dc': 'images/teams/DC.png',
                'pbks': 'images/teams/PBKS.png',
                'rr': 'images/teams/RR.png',
                'srh': 'images/teams/SRH.png',
                'gt': 'images/teams/GT.png',
                'lsg': 'images/teams/LSG.png'
            };
            
            const teamLogo = teamLogos[userTeam.id] || userTeam.logo || 'images/teams/default.png';
            
            teamHeader.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center relative" 
                         style="background: ${userTeam.color}20; border: 2px solid ${userTeam.color}">
                        <div class="w-12 h-12 rounded-full bg-gray-900/80 flex items-center justify-center overflow-hidden">
                            <img src="${teamLogo}" alt="${userTeam.name}" 
                                 class="w-10 h-10 object-contain p-1"
                                 onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<span class=\\'text-2xl\\'>üèè</span>';">
                        </div>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold" style="color: ${userTeam.color}">${userTeam.name}</h2>
                        <p class="text-gray-400 text-sm">Live Auction Pool</p>
                        <p class="text-gray-500 text-xs">${currentUsername}</p>
                    </div>
                </div>
            `;
            
            let teamBg = document.getElementById('teamBackground');
            if (!teamBg) {
                teamBg = document.createElement('div');
                teamBg.id = 'teamBackground';
                teamBg.className = 'team-background';
                document.body.appendChild(teamBg);
            }
            
            teamBg.style.backgroundImage = `url('${teamLogo}')`;
            teamBg.style.filter = 'blur(4px) brightness(0.15) opacity(0.4)';
            teamBg.style.backgroundSize = '300px';
            teamBg.style.backgroundRepeat = 'no-repeat';
            teamBg.style.backgroundPosition = 'center';
        }
        
        function displayCurrentPlayer() {
            if (!currentPlayer) return;
            
            currentPlayerCard.classList.remove('hidden');
            waitingAuction.classList.add('hidden');
            
            playerName.textContent = currentPlayer.name || 'Unknown Player';
            
            const role = currentPlayer.role || 'Player';
            let roleClass = 'role-bat';
            let roleDisplay = role;
            
            if (role) {
                const roleLower = role.toLowerCase();
                if (roleLower.includes('bowl') || roleLower.includes('pace') || roleLower.includes('spin') || roleLower === 'bow') {
                    roleClass = 'role-bowl';
                    roleDisplay = 'Bowler';
                } else if (roleLower.includes('all') || roleLower.includes('ar')) {
                    roleClass = 'role-ar';
                    roleDisplay = 'All-Rounder';
                } else if (roleLower.includes('wk') || roleLower.includes('keep')) {
                    roleClass = 'role-wk';
                    roleDisplay = 'WK-Batsman';
                } else if (roleLower.includes('bat')) {
                    roleClass = 'role-bat';
                    roleDisplay = 'Batsman';
                }
            }
            
            playerRole.className = `role-badge ${roleClass}`;
            playerRole.textContent = roleDisplay;
            
            playerType.textContent = currentPlayer.bowlingType || 'N/A';
            playerNationality.textContent = currentPlayer.nationality || 'Indian';
            const currentBidValue = currentPlayer.currentBid || currentPlayer.basePrice || 2;
            currentBid.textContent = `‚Çπ${currentBidValue} Cr`;
            basePrice.textContent = `‚Çπ${currentPlayer.basePrice || 2} Cr`;
            originalTeamName.textContent = currentPlayer.originalTeam || '-';
            
            if (currentPlayer.currentBidder) {
                highestBidder.textContent = currentPlayer.currentBidder.toUpperCase();
                const teamColors = {
                    'csk': '#FFCC00', 'mi': '#0048A0', 'rcb': '#D5152C',
                    'kkr': '#3A225D', 'dc': '#004C93', 'pbks': '#ED1B24',
                    'rr': '#FF4C93', 'srh': '#FF6F3D', 'gt': '#1E2D4A', 'lsg': '#A5E1F4'
                };
                highestBidder.style.color = teamColors[currentPlayer.currentBidder] || '#FFFFFF';
            } else {
                highestBidder.textContent = 'No bids yet';
                highestBidder.style.color = '#D1D5DB';
            }
            
            const isOverseas = currentPlayer.nationality?.toString().toLowerCase() !== 'indian';
            if (isOverseas) {
                playerOverseasBadge.classList.remove('hidden');
            } else {
                playerOverseasBadge.classList.add('hidden');
            }
            
            document.getElementById('statRuns').textContent = currentPlayer.totalRuns || '0';
            document.getElementById('statHighestScore').textContent = currentPlayer.highestScore || '0';
            document.getElementById('statStrikeRate').textContent = currentPlayer.strikeRate || '0';
            document.getElementById('statWickets').textContent = currentPlayer.wickets || '0';
            document.getElementById('statEconomy').textContent = currentPlayer.economyRate || '0';
            document.getElementById('statBestBowling').textContent = currentPlayer.bestBowling || '0/0';
            document.getElementById('statFours').textContent = currentPlayer.fours || '0';
            document.getElementById('statSixes').textContent = currentPlayer.sixes || '0';
            document.getElementById('statFifties').textContent = currentPlayer.fifties || '0';
            document.getElementById('statHundreds').textContent = currentPlayer.hundreds || '0';
        }
        
        function toggleStats() {
            const isVisible = !playerStats.classList.contains('hidden');
            
            if (isVisible) {
                playerStats.classList.add('hidden');
                currentPlayerCard.classList.remove('expanded');
                showStatsBtn.innerHTML = 'üìä Show Full Player Stats';
            } else {
                playerStats.classList.remove('hidden');
                currentPlayerCard.classList.add('expanded');
                showStatsBtn.innerHTML = 'üìä Hide Player Stats';
            }
        }

        // ========== BIDDING FUNCTIONS ==========
        function updateBidIncrement(currentBid) {
            minIncrement.textContent = '‚Çπ0.10 Cr';
        }
        
        function updateBidButtons() {
            document.querySelectorAll('.bid-btn').forEach(btn => {
                btn.disabled = false;
            });
        }

        function placeBid(increment) {
            if (!currentPlayer || !userTeam) {
                console.log('‚ùå No current player or user team');
                return;
            }
            
            const currentBidValue = parseFloat(currentPlayer.currentBid || currentPlayer.basePrice || 2);
            const newBid = currentBidValue + increment;
            const roundedBid = Math.round(newBid * 100) / 100;
            
            console.log(`üéØ Bid attempt: ${userTeam.id} bidding ‚Çπ${roundedBid} Cr`);
            
            if (roundedBid <= currentBidValue) {
                console.log('‚ö†Ô∏è Bid is not higher than current bid');
                showAlert('Bid Too Low', `Bid must be higher than current bid (‚Çπ${currentBidValue} Cr)`, '‚ö†Ô∏è');
                return;
            }
            
            sendBidToServer(roundedBid);
        }
        
        function sendBidToServer(bidAmount) {
            console.log('üéØ Sending bid to server:', bidAmount);
            
            if (!socket || !socket.connected) {
                console.error('‚ùå Socket not connected');
                showAlert('Connection Error', 'Not connected to server. Please refresh.', '‚ùå');
                showReconnectionOverlay();
                return;
            }
            
            if (!currentPlayer || !currentPlayer.id) {
                console.error('‚ùå No current player selected');
                showAlert('Error', 'No player selected for bidding', '‚ùå');
                return;
            }
            
            if (!userTeam || !userTeam.id) {
                console.error('‚ùå No user team');
                showAlert('Error', 'No team assigned', '‚ùå');
                return;
            }
            
            if (!currentRoomCode || !currentUsername) {
                console.error('‚ùå Missing session data');
                showAlert('Session Error', 'Session expired. Please refresh.', '‚ùå');
                return;
            }
            
            if (bidAmount > teamBudget) {
                showAlert('Insufficient Funds', `Your purse is only ‚Çπ${teamBudget.toFixed(2)} Cr`, '‚ùå');
                return;
            }
            
            const totalSquadSize = squadLimits.total;
            const maxSquadValue = squadLimits.maxSquad || 25;
            
            if (totalSquadSize >= maxSquadValue) {
                showAlert('Squad Full', `Maximum squad size (${maxSquadValue}) reached. You cannot buy more players.`, 'üèè');
                return;
            }
            
            const sessionData = JSON.parse(localStorage.getItem('userSession') || '{}');
            const sessionId = sessionData.sessionId || Date.now().toString();
            
            console.log('üì§ Sending bid with data:', {
                roomCode: currentRoomCode,
                username: currentUsername,
                playerId: currentPlayer.id,
                team: userTeam.id,
                bid: bidAmount,
                sessionId: sessionId
            });
            
            socket.emit('placeBid', {
                roomCode: currentRoomCode,
                username: currentUsername,
                playerId: currentPlayer.id,
                team: userTeam.id,
                bid: bidAmount,
                sessionId: sessionId
            }, (response) => {
                if (response && response.success) {
                    console.log('‚úÖ Bid successfully placed');
                    
                    // Optimistic update
                    currentBid.textContent = `‚Çπ${bidAmount} Cr`;
                    currentBid.classList.add('bounce');
                    setTimeout(() => currentBid.classList.remove('bounce'), 500);
                    
                    if (userTeam && userTeam.id) {
                        highestBidder.textContent = userTeam.id.toUpperCase();
                        const teamColors = {
                            'csk': '#FFCC00', 'mi': '#0048A0', 'rcb': '#D5152C',
                            'kkr': '#3A225D', 'dc': '#004C93', 'pbks': '#ED1B24',
                            'rr': '#FF4C93', 'srh': '#FF6F3D', 'gt': '#1E2D4A', 'lsg': '#A5E1F4'
                        };
                        highestBidder.style.color = teamColors[userTeam.id] || '#FFFFFF';
                    }
                    
                    addBidToLog(userTeam.id, bidAmount);
                    
                } else {
                    console.error('‚ùå Bid placement failed:', response?.message);
                    showAlert('Bid Failed', response?.message || 'Failed to place bid. Please try again.', '‚ùå');
                }
            });
        }
        
        function addBidToLog(team, bid, type = 'BID') {
            const bidItem = document.createElement('div');
            bidItem.className = 'bid-log-item new p-3 rounded-lg bg-gray-800/30 border-l-4 border-yellow-500 slide-in';
            
            const teamLogos = {
                'csk': 'images/teams/CSK.png',
                'mi': 'images/teams/MI.png', 
                'rcb': 'images/teams/RCB.png',
                'kkr': 'images/teams/KKR.png',
                'dc': 'images/teams/DC.png',
                'pbks': 'images/teams/PBKS.png',
                'rr': 'images/teams/RR.png',
                'srh': 'images/teams/SRH.png',
                'gt': 'images/teams/GT.png',
                'lsg': 'images/teams/LSG.png'
            };
            
            const teamColors = {
                'csk': '#FFCC00', 'mi': '#0048A0', 'rcb': '#D5152C',
                'kkr': '#3A225D', 'dc': '#004C93', 'pbks': '#ED1B24',
                'rr': '#FF4C93', 'srh': '#FF6F3D', 'gt': '#1E2D4A', 'lsg': '#A5E1F4'
            };
            
            const teamColor = teamColors[team] || '#FFFFFF';
            const teamLogo = teamLogos[team] || 'images/teams/default.png';
            
            bidItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <div class="w-6 h-6 rounded-full overflow-hidden bg-gray-800/50 flex items-center justify-center">
                            <img src="${teamLogo}" alt="${team}" 
                                 class="w-5 h-5 object-contain"
                                 onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<span class=\\'text-sm\\'>üèè</span>';">
                        </div>
                        <div class="h-4 w-1 bg-gradient-to-b from-transparent via-${teamColor} to-transparent"></div>
                    </div>
                    <span class="font-bold text-yellow-400">‚Çπ${bid} Cr</span>
                </div>
                <div class="text-xs text-gray-400 mt-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            `;
            
            bidLog.prepend(bidItem);
            
            setTimeout(() => {
                bidItem.classList.remove('new');
            }, 1000);
            
            if (bidLog.children.length > 20) {
                bidLog.removeChild(bidLog.lastChild);
            }
        }
        
        function clearBidLog() {
            bidLog.innerHTML = '<div class="text-center text-gray-500 py-4">No bids yet</div>';
        }
        
        function updateAuctionStatus(data) {
            if (data.category) auctionCategory.textContent = data.category;
            if (data.playersLeft !== undefined) playersLeft.textContent = data.playersLeft;
            if (data.unsoldCount !== undefined) unsoldCount.textContent = data.unsoldCount;
            
            if (data.currentPlayerIndex !== undefined && data.totalPlayers !== undefined) {
                const currentCount = data.currentPlayerIndex + 1;
                currentPlayerCount.textContent = `${currentCount}/${data.totalPlayers}`;
            }
        }

        // ========== SQUAD FUNCTIONS ==========
        function openSquadModal() {
            console.log('üë• Opening squad modal...');
            
            if (!socket || !socket.connected) {
                console.error('‚ùå Socket not connected for squad request');
                showAlert('Connection Error', 'Not connected to server. Please refresh.', '‚ùå');
                showReconnectionOverlay();
                return;
            }
            
            const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
            const currentSession = JSON.parse(localStorage.getItem('currentSession') || '{}');
            const sessionId = userSession.sessionId || currentSession.sessionId;
            
            if (!sessionId) {
                console.error('‚ùå No session ID for squad request');
                showAlert('Session Error', 'Cannot load squad without session', '‚ùå');
                return;
            }
            
            if (!currentRoomCode || !currentUsername) {
                console.error('‚ùå Missing room code or username');
                showAlert('Error', 'Missing user information', '‚ùå');
                return;
            }
            
            console.log('üì§ Requesting squad data:', {
                roomCode: currentRoomCode,
                username: currentUsername,
                sessionId: sessionId
            });
            
            socket.emit('requestSquad', {
                roomCode: currentRoomCode,
                username: currentUsername,
                sessionId: sessionId
            }, (response) => {
                if (response && response.success && response.data) {
                    console.log('‚úÖ Squad data received:', response.data);
                    updateSquadDisplay(response.data);
                } else {
                    console.error('‚ùå Failed to get squad data:', response?.message);
                    showAlert('Error', response?.message || 'Failed to load squad data', '‚ùå');
                    
                    // Show offline squad data as fallback
                    const offlineSquadData = {
                        team: userTeam,
                        retainedPlayers: JSON.parse(localStorage.getItem('retainedPlayers') || '[]'),
                        auctionPlayers: JSON.parse(localStorage.getItem('auctionBuys') || '[]'),
                        budget: teamBudget,
                        totalSpent: 0,
                        totalBudget: 100,
                        remainingBudget: teamBudget,
                        squadLimit: squadLimits.maxSquad || 25,
                        remainingSlots: Math.max(0, (squadLimits.maxSquad || 25) - squadLimits.total)
                    };
                    
                    updateSquadDisplay(offlineSquadData);
                }
            });
        }
        
        function updateSquadLimits() {
            squadSize.textContent = squadLimits.total || 0;
            const max = squadLimits.maxSquad || 25;
            maxSquad.textContent = max;
            remainingSlots.textContent = max - squadLimits.total;
            canBuy.textContent = max - squadLimits.total;
            indianCount.textContent = squadLimits.indian || 0;
            overseasCount.textContent = squadLimits.overseas || 0;
        }
        
        function updateSquadDisplay(data) {
            console.log('üë• Updating squad display:', data);
            
            const squadData = {
                team: data.team || userTeam || { name: 'Team' },
                retainedPlayers: data.retainedPlayers || [],
                auctionPlayers: data.auctionPlayers || [],
                budget: data.budget || teamBudget || 100,
                totalSpent: data.totalSpent || 0,
                totalBudget: data.totalBudget || 100,
                remainingBudget: data.remainingBudget || data.budget || 100,
                squadLimit: data.squadLimit || data.maxSquad || 25,
                remainingSlots: data.remainingSlots || 0,
                rules: data.rules || { impactPlayers: 1 }
            };
            
            let overseasCount = 0;
            let indianCount = 0;
            
            squadData.retainedPlayers.forEach(p => {
                if (p.isOverseas) overseasCount++;
                else indianCount++;
            });
            
            squadData.auctionPlayers.forEach(p => {
                if (p.isOverseas) overseasCount++;
                else indianCount++;
            });
            
            const totalPlayers = squadData.retainedPlayers.length + squadData.auctionPlayers.length;
            
            const squadModal = document.createElement('div');
            squadModal.className = 'fixed inset-0 flex items-center justify-center z-50';
            squadModal.innerHTML = `
                <div class="absolute inset-0 bg-black/80"></div>
                <div class="glass-panel rounded-2xl p-6 max-w-2xl w-11/12 max-h-[80vh] overflow-y-auto z-10">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-yellow-400">My Squad - ${squadData.team.name}</h2>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                class="text-2xl hover:text-yellow-400">‚úï</button>
                    </div>
                    
                    <!-- Budget Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="text-center p-4 rounded-lg bg-gray-800/30">
                            <div class="text-sm text-gray-400">Total Budget</div>
                            <div class="text-2xl font-bold text-green-400">‚Çπ${squadData.totalBudget.toFixed(2)} Cr</div>
                        </div>
                        <div class="text-center p-4 rounded-lg bg-gray-800/30">
                            <div class="text-sm text-gray-400">Amount Spent</div>
                            <div class="text-2xl font-bold text-red-400">‚Çπ${squadData.totalSpent.toFixed(2)} Cr</div>
                        </div>
                        <div class="text-center p-4 rounded-lg bg-gray-800/30">
                            <div class="text-sm text-gray-400">Remaining Purse</div>
                            <div class="text-2xl font-bold text-yellow-400">‚Çπ${squadData.remainingBudget.toFixed(2)} Cr</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Retained Players -->
                        <div>
                            <h3 class="text-xl font-bold mb-4 text-green-400 flex items-center justify-between">
                                <span>Retained Players (${squadData.retainedPlayers.length})</span>
                                <span class="text-sm text-gray-400">Free</span>
                            </h3>
                            <div class="space-y-3 max-h-[300px] overflow-y-auto">
                                ${squadData.retainedPlayers.map(player => `
                                    <div class="p-3 bg-gray-800/30 rounded-lg hover:bg-gray-800/50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-medium">${player.name}</div>
                                                <div class="text-sm text-gray-400">${player.role} ‚Ä¢ ${player.isOverseas ? '‚úàÔ∏è Overseas' : 'üáÆüá≥ Indian'}</div>
                                            </div>
                                            <div class="text-green-400 font-bold">FREE</div>
                                        </div>
                                    </div>
                                `).join('')}
                                ${squadData.retainedPlayers.length === 0 ? 
                                    '<div class="text-gray-500 text-center py-4">No retained players</div>' : ''}
                            </div>
                        </div>
                        
                        <!-- Auction Buys -->
                        <div>
                            <h3 class="text-xl font-bold mb-4 text-blue-400 flex items-center justify-between">
                                <span>Auction Buys (${squadData.auctionPlayers.length})</span>
                                <span class="text-sm text-gray-400">Total: ‚Çπ${squadData.auctionPlayers.reduce((sum, p) => sum + (p.price || 0), 0).toFixed(2)} Cr</span>
                            </h3>
                            <div class="space-y-3 max-h-[300px] overflow-y-auto">
                                ${squadData.auctionPlayers.map(player => `
                                    <div class="p-3 bg-gray-800/30 rounded-lg hover:bg-gray-800/50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-medium">${player.name}</div>
                                                <div class="text-sm text-gray-400">${player.role} ‚Ä¢ ${player.isOverseas ? '‚úàÔ∏è Overseas' : 'üáÆüá≥ Indian'}</div>
                                                ${player.price ? `<div class="text-xs text-yellow-400">Price: ‚Çπ${player.price} Cr</div>` : ''}
                                            </div>
                                            <div class="text-yellow-400 font-bold">‚Çπ${player.price || 0} Cr</div>
                                        </div>
                                    </div>
                                `).join('')}
                                ${squadData.auctionPlayers.length === 0 ? 
                                    '<div class="text-gray-500 text-center py-4">No players bought yet</div>' : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Squad Summary -->
                    <div class="mt-6 pt-6 border-t border-gray-700">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-3 bg-gray-800/30 rounded-lg">
                                <div class="text-sm text-gray-400">Total Players</div>
                                <div class="text-2xl font-bold">${totalPlayers}</div>
                            </div>
                            <div class="text-center p-3 bg-gray-800/30 rounded-lg">
                                <div class="text-sm text-gray-400">Squad Limit</div>
                                <div class="text-2xl font-bold text-purple-400">${squadData.squadLimit}</div>
                            </div>
                            <div class="text-center p-3 bg-gray-800/30 rounded-lg">
                                <div class="text-sm text-gray-400">Remaining Slots</div>
                                <div class="text-2xl font-bold text-blue-400">${Math.max(0, squadData.squadLimit - totalPlayers)}</div>
                            </div>
                            <div class="text-center p-3 bg-gray-800/30 rounded-lg">
                                <div class="text-sm text-gray-400">Overseas/Indian</div>
                                <div class="text-lg font-bold">
                                    <span class="text-purple-400">${overseasCount}</span>
                                    <span class="text-gray-400">/</span>
                                    <span class="text-green-400">${indianCount}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existingModal = document.querySelector('.fixed.inset-0.flex.items-center.justify-center.z-50');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.appendChild(squadModal);
        }

        // ========== HELPER FUNCTIONS ==========
        function showAlert(title, message, icon = '‚ÑπÔ∏è') {
            const alertDiv = document.getElementById('alertToast');
            document.getElementById('alertIcon').textContent = icon;
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            alertDiv.classList.remove('hidden');
            
            setTimeout(() => {
                alertDiv.classList.add('hidden');
            }, 5000);
        }
        
        function closeAlert() {
            document.getElementById('alertToast').classList.add('hidden');
        }
        
        function showErrorState(message) {
            waitingAuction.innerHTML = `
                <div class="text-6xl mb-4">‚ùå</div>
                <h3 class="text-2xl font-bold text-red-400 mb-2">Error</h3>
                <p class="text-gray-300 mb-4">${message}</p>
                <button onclick="goToLogin()" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-lg font-semibold">
                    Go to Login
                </button>
            `;
        }
        
        function showSoldBroadcast(player, team, price) {
            const broadcast = document.createElement('div');
            broadcast.className = 'fixed bottom-1/3 left-1/2 transform -translate-x-1/2 z-50 w-11/12 max-w-lg';
            broadcast.innerHTML = `
                <div class="bg-gradient-to-r from-green-900/90 to-emerald-900/90 backdrop-blur-lg rounded-xl p-4 border-2 border-green-500/50 shadow-2xl">
                    <div class="flex items-center justify-center space-x-3">
                        <div class="text-3xl">üéâ</div>
                        <div class="text-center">
                            <div class="text-sm text-green-300 mb-1">PLAYER SOLD</div>
                            <div class="text-xl font-bold text-white mb-1">${player}</div>
                            <div class="flex items-center justify-center space-x-2">
                                <span class="text-green-300">to</span>
                                <span class="px-3 py-1 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg font-bold">
                                    ${team.toUpperCase()}
                                </span>
                                <span class="text-green-300">for</span>
                                <span class="text-2xl font-black text-yellow-400">‚Çπ${price} Cr</span>
                            </div>
                        </div>
                        <div class="text-3xl">üí∞</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(broadcast);
            
            setTimeout(() => {
                broadcast.remove();
            }, 3000);
        }

        function showUnsoldPopup(playerName) {
            console.log('‚ùå Showing unsold popup for:', playerName);
            
            const popup = document.createElement('div');
            popup.className = 'fixed top-1/3 left-1/2 transform -translate-x-1/2 z-50 w-11/12 max-w-lg unsold-popup';
            popup.innerHTML = `
                <div class="bg-gradient-to-r from-red-900/90 to-orange-900/90 backdrop-blur-lg rounded-xl p-4 border-2 border-red-500/50 shadow-2xl">
                    <div class="flex items-center justify-center space-x-3">
                        <div class="text-3xl">‚ùå</div>
                        <div class="text-center">
                            <div class="text-sm text-red-300 mb-1">PLAYER UNSOLD</div>
                            <div class="text-xl font-bold text-white mb-1">${playerName}</div>
                            <div class="text-yellow-200 text-sm mt-1">
                                Went unsold and will come again in the unsold list
                            </div>
                        </div>
                        <div class="text-3xl">üìã</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                if (popup.parentElement) {
                    popup.remove();
                }
            }, 3000);
        }

        // ========== EXPOSE FUNCTIONS TO GLOBAL SCOPE ==========
        window.reconnectWithSession = reconnectWithSession;
        window.goToLogin = goToLogin;
        window.closeAlert = closeAlert;
        window.forceReconnect = forceReconnect;
        window.closeBackWarning = closeBackWarning;

        console.log('‚úÖ Auction pool page loaded with back button protection');
        // ‚úÖ GLOBAL FALLBACK REDIRECT FUNCTION
function redirectToPlaying11Fallback() {
    console.log('üîÑ Fallback redirect triggered');
    
    // Create squad data from whatever we have
    const squadData = {
        roomCode: currentRoomCode,
        username: currentUsername,
        team: userTeam,
        budget: teamBudget,
        squadLimits: squadLimits,
        retainedPlayers: JSON.parse(localStorage.getItem('retainedPlayers') || '[]'),
        auctionPlayers: JSON.parse(localStorage.getItem('auctionBuys') || '[]'),
        timestamp: Date.now()
    };
    
    // Store data
    localStorage.setItem('playing11SquadData', JSON.stringify(squadData));
    localStorage.setItem('auctionCompleted', 'true');
    localStorage.setItem('userSession', JSON.stringify({
        username: currentUsername,
        roomCode: currentRoomCode,
        team: userTeam,
        sessionId: userSession?.sessionId || Date.now().toString()
    }));
    
    console.log('üíæ Fallback squad data stored:', squadData);
    
    // Show message
    const waitingAuction = document.getElementById('waitingAuction');
    if (waitingAuction) {
        waitingAuction.classList.remove('hidden');
        waitingAuction.innerHTML = `
            <div class="text-6xl mb-4">üîó</div>
            <h3 class="text-2xl font-bold text-green-400 mb-2">Fallback Redirect</h3>
            <p class="text-gray-300 mb-4">Auction completed! Redirecting...</p>
        `;
    }
    
    // Redirect
    setTimeout(() => {
        window.location.href = 'playing11.html';
    }, 1000);
}

// Expose to window for debugging
window.redirectToPlaying11Fallback = redirectToPlaying11Fallback;

// ... all your existing code ...

// ‚úÖ DEBUG: Show manual redirect button if stuck on auctionpool page
// Add this at the very end, before the closing script tag
setTimeout(() => {
    const debugBtn = document.getElementById('debugRedirectBtn');
    if (debugBtn && window.location.href.includes('auctionpool.html')) {
        debugBtn.classList.remove('hidden');
        console.log('‚ö†Ô∏è Debug redirect button enabled - manual redirect available');
        
        // Also show alert to user
        showAlert('Manual Redirect', 
            'If you are stuck here, click the "Debug Redirect" button to manually go to Playing 11 selection.', 
            'üîß');
    }
}, 10000); // 10 seconds

console.log('‚úÖ Auction pool page loaded with debug redirect system');

    </script>
</body>
</html>